<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence Analyzer</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #4a90e2 0%, #50c9c3 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #007bff;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            background: #007bff;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .file-input-label:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .control-group:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .control-group h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .control-group p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .export-section {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #28a745;
            text-align: center;
        }
        
        .export-section h3 {
            color: #155724;
            margin-bottom: 15px;
        }
        
        .export-section p {
            color: #155724;
            margin-bottom: 20px;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            max-height: 350px;
            overflow: hidden;
        }
        
        .chart-canvas {
            max-width: 100%;
            height: 300px;
            width: 100% !important;
        }
        
        .analysis-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #17a2b8;
        }
        
        .analysis-section h3 {
            color: #17a2b8;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .data-preview {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-preview th,
        .data-preview td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-preview th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: #fff3cd;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .loading.show {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        .business-insight {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .business-insight.revenue {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border-left: 5px solid #28a745;
        }
        
        .business-insight.products {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 5px solid #2196f3;
        }
        
        .business-insight.recommendation {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 5px solid #ff9800;
        }
        
        .business-insight h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .business-insight ul {
            margin-left: 20px;
        }
        
        .business-insight li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .product-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 3px solid #007bff;
        }
        
        .download-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            min-width: 400px;
            max-width: 90%;
            border: 3px solid #28a745;
        }
        
        .download-notification.error {
            border-color: #dc3545;
        }
        
        .download-notification.info {
            border-color: #17a2b8;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .notification-body {
            margin-bottom: 20px;
            color: #666;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .notification-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .notification-btn:not(.secondary) {
            background: #28a745;
            color: white;
        }
        
        .notification-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .notification-btn.disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Login Screen Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 400px;
            max-width: 90%;
        }

        .login-form h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #007bff;
        }

        .login-form .login-btn {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 10px;
        }

        .login-form .login-btn:hover {
            background: #0056b3;
        }

        .login-error {
            color: #dc3545;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        .main-app {
            display: none;
        }

        @media (max-width: 768px) {
            .login-form {
                min-width: auto;
                padding: 30px 20px;
            }
            
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .analysis-controls {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                max-height: 250px;
                padding: 15px;
            }
            
            .chart-canvas {
                height: 200px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .download-notification {
                min-width: 90%;
                margin: 0 5%;
            }
        }
        
        /* History section styles */
        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-item-date {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }
        
        .history-item-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .history-item-content {
            color: #333;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }

        /* Print styles - Show only charts and analysis results */
        @media print {
            /* Force UTF-8 encoding for proper Bulgarian text */
            * {
                font-family: "Times New Roman", "DejaVu Sans", serif !important;
                -webkit-font-feature-settings: "kern" 1 !important;
                font-feature-settings: "kern" 1 !important;
            }
            
            /* Hide everything except results section */
            .header,
            .upload-section,
            .analysis-controls,
            .export-section,
            .history-section,
            .loading,
            .login-overlay,
            .file-input-wrapper,
            .btn,
            .control-group,
            .footer,
            button,
            input,
            .login-container,
            .form-section,
            .controls,
            #loginOverlay,
            .login-form,
            .error-message,
            .success-message {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Show only specific results */
            .results-section,
            #analysisResults,
            .chart-container,
            #chartsContainer {
                display: block !important;
                visibility: visible !important;
                margin: 0 !important;
                padding: 15px !important;
            }
            
            /* Optimize charts for printing */
            .chart-container {
                page-break-inside: avoid;
                margin-bottom: 30px !important;
                border: 2px solid #333 !important;
                padding: 20px !important;
                background: white !important;
                border-radius: 0 !important;
            }
            
            /* Chart titles styling */
            .chart-container h3,
            .chart-container h4 {
                font-size: 14pt !important;
                font-weight: bold !important;
                margin-bottom: 15px !important;
                text-align: center !important;
                color: #000 !important;
                page-break-after: avoid !important;
            }
            
            /* Canvas sizing for charts */
            canvas {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            
            /* Optimize analysis results for printing */
            #analysisResults {
                page-break-inside: avoid;
                background: white !important;
                padding: 20px !important;
                border: 2px solid #333 !important;
                margin: 20px 0 !important;
                font-size: 11pt !important;
                line-height: 1.5 !important;
            }
            
            /* Analysis results formatting */
            #analysisResults h3,
            #analysisResults h4 {
                font-size: 13pt !important;
                font-weight: bold !important;
                margin: 15px 0 10px 0 !important;
                color: #000 !important;
                page-break-after: avoid !important;
            }
            
            #analysisResults p,
            #analysisResults div {
                margin-bottom: 8px !important;
                font-size: 10pt !important;
                line-height: 1.4 !important;
            }
            
            #analysisResults ul,
            #analysisResults ol {
                margin: 10px 0 10px 20px !important;
                font-size: 10pt !important;
            }
            
            #analysisResults li {
                margin-bottom: 5px !important;
                line-height: 1.3 !important;
            }
            
            /* Container adjustments for print */
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                background: white !important;
                width: 100% !important;
            }
            
            /* Body adjustments for print */
            body {
                background: white !important;
                color: black !important;
                font-size: 11pt !important;
                line-height: 1.4 !important;
                margin: 0 !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Page setup */
            @page {
                margin: 1.5cm !important;
                size: A4 !important;
            }
            
            /* Ensure good contrast for printing */
            h1, h2, h3, h4, h5, h6 {
                color: black !important;
                font-weight: bold !important;
                page-break-after: avoid !important;
            }
            
            /* Add a title for the printed document */
            body::before {
                content: "Business Intelligence –ê–Ω–∞–ª–∏–∑ - –†–µ–∑—É–ª—Ç–∞—Ç–∏";
                display: block !important;
                font-size: 20pt !important;
                font-weight: bold !important;
                text-align: center !important;
                margin: 0 0 30px 0 !important;
                padding: 15px !important;
                border-bottom: 3px solid #333 !important;
                background: #f5f5f5 !important;
                page-break-after: avoid !important;
            }
            
            /* Hide specific problematic elements */
            .login-overlay,
            .loading,
            script,
            style:not([media*="print"]),
            .error,
            .warning,
            .notification,
            .popup,
            .modal {
                display: none !important;
            }
            
            /* Remove any JavaScript-generated content that causes issues */
            .dynamic-content:empty {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-form">
            <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞</h2>
            <div class="input-group">
                <label for="username">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–Ω–æ –∏–º–µ:</label>
                <input type="text" id="username" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–Ω–æ –∏–º–µ">
            </div>
            <div class="input-group">
                <label for="password">–ü–∞—Ä–æ–ª–∞:</label>
                <input type="password" id="password" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ –ø–∞—Ä–æ–ª–∞">
            </div>
            <button class="login-btn" onclick="attemptLogin()">üöÄ –í–ª–µ–∑</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="container">
        <div class="header">
            <h1>üéØ Business Intelligence Analyzer</h1>
            <p>–ü—Ä–µ–≤—ä—Ä–Ω–µ—Ç–µ –¥–∞–Ω–Ω–∏—Ç–µ —Å–∏ –≤ –ø–æ–ª–µ–∑–Ω–∏ –±–∏–∑–Ω–µ—Å —Ä–µ—à–µ–Ω–∏—è —Å –ª–µ—Å–Ω–æ—Å—Ç –∏ —Å—Ç–∏–ª</p>
        </div>
        
        <div class="upload-section">
            <h2>üìÅ –ö–∞—á–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏</h2>
            <p>–ö–∞—á–µ—Ç–µ Excel (.xlsx, .xls) –∏–ª–∏ CSV —Ñ–∞–π–ª –∑–∞ –∞–Ω–∞–ª–∏–∑</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                <label for="fileInput" class="file-input-label">
                    üìÇ –ò–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª
                </label>
            </div>
            <br>
            <button class="btn" onclick="loadFile()">üöÄ –ó–∞—Ä–µ–¥–∏ –¥–∞–Ω–Ω–∏—Ç–µ</button>
        </div>
        
        <div class="analysis-controls">
            <div class="control-group">
                <h3>üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ</h3>
                <p>–°—ä–∑–¥–∞–π—Ç–µ –¥–∏–∞–≥—Ä–∞–º–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∏ –∑–∞ –ø–æ-—è—Å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ</p>
                <button class="btn" onclick="createCharts()">üìà –°—ä–∑–¥–∞–π –¥–∏–∞–≥—Ä–∞–º–∏</button>
            </div>
            
            <div class="control-group">
                <h3>üîç Market Basket –∞–Ω–∞–ª–∏–∑</h3>
                <p>–û—Ç–∫—Ä–∏–π—Ç–µ –≤—Ä—ä–∑–∫–∏ –º–µ–∂–¥—É –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ</p>
                <button class="btn" onclick="performMarketBasketAnalysis()">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –≤—Ä—ä–∑–∫–∏—Ç–µ</button>
            </div>
            
            <div class="control-group">
                <h3>üíº –ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑</h3>
                <p>–ü–æ–ª—É—á–µ—Ç–µ –±–∏–∑–Ω–µ—Å –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏</p>
                <button class="btn" onclick="generateBusinessAnalysis()">üí° –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∞–Ω–∞–ª–∏–∑</button>
            </div>
        </div>
        
        <div class="export-section">
            <h3>üì§ –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ</h3>
            <p>–ò–∑—Ç–µ–≥–ª–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ –≤ —É–¥–æ–±–µ–Ω —Ñ–æ—Ä–º–∞—Ç</p>
            <button class="btn" onclick="exportToPDF()">üìë –ï–∫—Å–ø–æ—Ä—Ç PDF</button>
            <button class="btn" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
            <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 0.9em;">
                <strong>üí° –°—ä–≤–µ—Ç–∏ –∑–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ:</strong>
                <ul style="margin: 5px 0 0 20px; text-align: left;">
                    <li>–ê–∫–æ —Ñ–∞–π–ª—ä—Ç –Ω–µ —Å–µ –∏–∑—Ç–µ–≥–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –±—Ä–∞—É–∑—ä—Ä–∞ –∑–∞ –±–ª–æ–∫–∏—Ä–∞–Ω–∏ pop-up –ø—Ä–æ–∑–æ—Ä—Ü–∏</li>
                    <li>–§–∞–π–ª–æ–≤–µ—Ç–µ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç –≤ –ø–∞–ø–∫–∞—Ç–∞ "Downloads" –Ω–∞ –∫–æ–º–ø—é—Ç—ä—Ä–∞</li>
                    <li>–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∏, –æ—Ç–≤–æ—Ä–µ—Ç–µ Developer Console (F12) –∑–∞ –ø–æ–≤–µ—á–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</li>
                </ul>
            </div>
        </div>
        
        <div class="history-section" style="margin-top: 30px;">
            <h3>üìö –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ</h3>
            <p>–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –ø—Ä–µ–¥–∏—à–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ –∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</p>
            <button class="btn" onclick="showAnalysisHistory()">üìñ –ü–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—è</button>
            <button class="btn secondary" onclick="clearAnalysisHistory()" style="margin-left: 10px;">üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è</button>
            <div id="historyContainer" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <h3>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ...</h3>
            <p>–ú–æ–ª—è, –∏–∑—á–∞–∫–∞–π—Ç–µ...</p>
        </div>
        
        <div class="loading" id="exportLoading">
            <h3>üì¶ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª...</h3>
            <p>–§–∞–π–ª—ä—Ç —Å–µ –ø–æ–¥–≥–æ—Ç–≤—è –∑–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ...</p>
        </div>
        
        <div class="results-section">
            <div id="chartContainer"></div>
            <div id="analysisResults"></div>
        </div>
    </div>
    </div> <!-- End of main-app -->
    
    <script>
        // Login functionality
        function attemptLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Check credentials
            if (username === 'admin' && password === 'password') {
                // Hide login screen
                document.getElementById('loginOverlay').style.display = 'none';
                // Show main application
                document.getElementById('mainApp').style.display = 'block';
                // Clear error
                errorDiv.style.display = 'none';
            } else {
                // Show error
                errorDiv.textContent = '–ì—Ä–µ—à–Ω–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–Ω–æ –∏–º–µ –∏–ª–∏ –ø–∞—Ä–æ–ª–∞!';
                errorDiv.style.display = 'block';
                // Clear password field
                document.getElementById('password').value = '';
            }
        }

        // Allow Enter key to submit login
        document.addEventListener('DOMContentLoaded', function() {
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            
            if (usernameField && passwordField) {
                usernameField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        passwordField.focus();
                    }
                });
                
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        attemptLogin();
                    }
                });
            }
        });

        let processedData = null;
        let currentCharts = [];
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
        
        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        function showInfo(message) {
            showNotification(message, 'info');
        }
        
        function showMessage(message, type = 'success') {
            showNotification(message, type);
        }
        
        function showLoading(message) {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.innerHTML = `<h3>‚è≥ ${message}</h3><p>–ú–æ–ª—è, –∏–∑—á–∞–∫–∞–π—Ç–µ...</p>`;
                loading.style.display = 'block';
            }
        }
        
        function hideLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) loading.style.display = 'none';
        }
        
        // Analysis History Functions
        function saveToHistory(type, content, summary) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toLocaleString('bg-BG'),
                type: type,
                content: content,
                summary: summary || '–ê–Ω–∞–ª–∏–∑ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–µ'
            };
            
            analysisHistory.unshift(historyItem); // Add to beginning
            
            // Keep only last 20 items
            if (analysisHistory.length > 20) {
                analysisHistory = analysisHistory.slice(0, 20);
            }
            
            // Save to localStorage
            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            console.log('Analysis saved to history:', type, summary);
        }
        
        function showAnalysisHistory() {
            const container = document.getElementById('historyContainer');
            
            if (analysisHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>üì≠ –ù—è–º–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏</p>
                        <p style="font-size: 0.9em;">–ù–∞–ø—Ä–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è —Å–∏ –∞–Ω–∞–ª–∏–∑, –∑–∞ –¥–∞ —Å–µ –ø–æ—è–≤–∏ —Ç—É–∫!</p>
                    </div>
                `;
            } else {
                let historyHtml = '<h4>üìö –ó–∞–ø–∞–∑–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ (' + analysisHistory.length + ' –±—Ä.)</h4>';
                
                analysisHistory.forEach(item => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-date">${item.date}</span>
                                <span class="history-item-type">${item.type}</span>
                            </div>
                            <div class="history-item-content">
                                <strong>${item.summary}</strong><br>
                                ${item.content.substring(0, 300)}${item.content.length > 300 ? '...' : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = historyHtml;
            }
            
            // Toggle visibility
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function clearAnalysisHistory() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ?')) {
                analysisHistory = [];
                localStorage.removeItem('analysisHistory');
                
                const container = document.getElementById('historyContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>‚úÖ –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—á–∏—Å—Ç–µ–Ω–∞</p>
                    </div>
                `;
                
                showSuccess('–ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ –µ –∏–∑—á–∏—Å—Ç–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                
                // Hide container after 2 seconds
                setTimeout(() => {
                    container.style.display = 'none';
                }, 2000);
            }
        }
        
        // File loading functions
        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª –ø—ä—Ä–≤–æ.');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('show');
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = function(e) {
                    try {
                        processedData = parseCSV(e.target.result);
                        displayDataPreview();
                        showSuccess('CSV —Ñ–∞–π–ª—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } catch (error) {
                        showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ CSV —Ñ–∞–π–ª–∞: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        processedData = parseArrayData(jsonData);
                        displayDataPreview();
                        showSuccess('Excel —Ñ–∞–π–ª—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } catch (error) {
                        showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª–∞: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                showError('–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–∞ —Ñ–∞–π–ª. –ú–æ–ª—è, –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ CSV –∏–ª–∏ Excel —Ñ–∞–π–ª–æ–≤–µ.');
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return { headers, data };
        }
        
        function parseArrayData(arrayData) {
            if (arrayData.length === 0) return { headers: [], data: [] };
            
            const headers = arrayData[0].map(h => String(h || '').trim());
            const data = [];
            
            for (let i = 1; i < arrayData.length; i++) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = arrayData[i][index] || '';
                });
                if (Object.values(row).some(v => v !== '')) {
                    data.push(row);
                }
            }
            
            return { headers, data };
        }
        
        function displayDataPreview() {
            const container = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>üìã –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ</h3>
                    <p><strong>–ó–∞—Ä–µ–¥–µ–Ω–∏ –∑–∞–ø–∏—Å–∏:</strong> ${processedData.data.length} –±—Ä.</p>
                    <p><strong>–ö–æ–ª–æ–Ω–∏:</strong> ${processedData.headers.join(', ')}</p>
                    
                    <div class="data-preview">
                        <table>
                            <thead>
                                <tr>
            `;
            
            processedData.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            
            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show first 5 rows
            processedData.data.slice(0, 5).forEach(row => {
                html += '<tr>';
                processedData.headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    ${processedData.data.length > 5 ? `<p><em>–ü–æ–∫–∞–∑–∞–Ω–∏ —Å–∞ –ø—ä—Ä–≤–∏—Ç–µ 5 –∑–∞–ø–∏—Å–∞ –æ—Ç –æ–±—â–æ ${processedData.data.length}</em></p>` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function createCharts() {
            const container = document.getElementById('chartContainer');
            
            // Find suitable columns for charting
            const numericColumns = findNumericColumns();
            const textColumns = findTextColumns();
            
            if (numericColumns.length === 0) {
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>‚ö†Ô∏è –ù—è–º–∞ —á–∏—Å–ª–æ–≤–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –¥–∏–∞–≥—Ä–∞–º–∏</h3>
                        <p>–§–∞–π–ª—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ —á–∏—Å–ª–æ–≤–∏ –∫–æ–ª–æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏ –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è.</p>
                    </div>
                `;
                return;
            }
            
            // Create bar chart for first numeric column
            if (numericColumns.length > 0 && textColumns.length > 0) {
                createBarChart(textColumns[0], numericColumns[0]);
            }
            
            // Create pie chart if we have categorical data
            if (textColumns.length > 0) {
                createPieChart(textColumns[0]);
            }
            
            // Create line chart for trends
            if (numericColumns.length >= 2) {
                createLineChart(numericColumns[0], numericColumns[1]);
            }
            
            // Save charts to history
            const chartsCreated = [];
            if (numericColumns.length > 0 && textColumns.length > 0) chartsCreated.push('Bar Chart');
            if (textColumns.length > 0) chartsCreated.push('Pie Chart');
            if (numericColumns.length >= 2) chartsCreated.push('Line Chart');
            
            if (chartsCreated.length > 0) {
                const summaryText = `–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: ${chartsCreated.join(', ')} –æ—Ç ${processedData.data.length} –∑–∞–ø–∏—Å–∞`;
                const contentText = `–°—ä–∑–¥–∞–¥–µ–Ω–∏ –¥–∏–∞–≥—Ä–∞–º–∏: ${chartsCreated.join(', ')}\n–î–∞–Ω–Ω–∏: ${processedData.data.length} –∑–∞–ø–∏—Å–∞\n–ö–æ–ª–æ–Ω–∏: ${processedData.headers.join(', ')}`;
                saveToHistory('üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è', contentText, summaryText);
            }
        }
        
        function findNumericColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && !isNaN(parseFloat(value)) && isFinite(value);
                });
            });
        }
        
        function findTextColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && isNaN(parseFloat(value));
                });
            });
        }
        
        function createBarChart(categoryColumn, valueColumn) {
            // Group data by category
            const categoryData = {};
            processedData.data.forEach(row => {
                const category = row[categoryColumn];
                const value = parseFloat(row[valueColumn]) || 0;
                
                if (category) {
                    categoryData[category] = (categoryData[category] || 0) + value;
                }
            });
            
            // Sort by value and take top 10
            const sortedData = Object.entries(categoryData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const labels = sortedData.map(([category]) => category);
            const values = sortedData.map(([, value]) => value);
            
            // Create chart
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            
            const container = document.getElementById('chartContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<h3>üìä ${categoryColumn} vs ${valueColumn} (–±—Ä–æ–π)</h3>`;
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${valueColumn} (–±—Ä–æ–π)`,
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `–ü—Ä–æ–¥—É–∫—Ç–∏ vs –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–±—Ä–æ–π)`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–±—Ä–æ–π)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: categoryColumn
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createPieChart(categoryColumn) {
            // Count occurrences
            const categoryData = {};
            processedData.data.forEach(row => {
                const category = row[categoryColumn];
                if (category) {
                    categoryData[category] = (categoryData[category] || 0) + 1;
                }
            });
            
            // Sort and take top 8
            const sortedData = Object.entries(categoryData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            const labels = sortedData.map(([category]) => category);
            const values = sortedData.map(([, count]) => count);
            
            // Create chart
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            
            const container = document.getElementById('chartContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<h3>ü•ß –†–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ ${categoryColumn} (–±—Ä–æ–π)</h3>`;
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `–†–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ ${categoryColumn} (–±—Ä–æ–π)`
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createLineChart(xColumn, yColumn) {
            // Get numeric data and sort by x-axis
            const chartData = processedData.data
                .map(row => ({
                    x: parseFloat(row[xColumn]) || 0,
                    y: parseFloat(row[yColumn]) || 0
                }))
                .filter(point => !isNaN(point.x) && !isNaN(point.y))
                .sort((a, b) => a.x - b.x);
            
            if (chartData.length === 0) return;
            
            // Create chart
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            
            const container = document.getElementById('chartContainer');
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<h3>üìà –¢–µ–Ω–¥–µ–Ω—Ü–∏—è: ${xColumn} vs ${yColumn}</h3>`;
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${yColumn} (—Å—Ç–æ–π–Ω–æ—Å—Ç)`,
                        data: chartData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${xColumn} vs ${yColumn} —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è`
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: `${xColumn} (—Å—Ç–æ–π–Ω–æ—Å—Ç)`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `${yColumn} (—Å—Ç–æ–π–Ω–æ—Å—Ç)`
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        // Market Basket Analysis functions
        function performMarketBasketAnalysis() {
            if (!processedData) {
                showError('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∫–∞—á–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            try {
                const transactions = extractTransactions();
                const frequentItemsets = findFrequentItemsets(transactions);
                const associationRules = generateAssociationRules(frequentItemsets, transactions);
                
                displayMarketBasketResults(frequentItemsets, associationRules, transactions);
                showSuccess('–ê–Ω–∞–ª–∏–∑—ä—Ç –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω!');
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞: ' + error.message);
                console.error('Market basket analysis error:', error);
            }
        }
        
        function extractTransactions() {
            // Find transaction and product columns
            const possibleTransactionColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('transaction') || 
                header.toLowerCase().includes('order') ||
                header.toLowerCase().includes('id') ||
                header.toLowerCase().includes('–Ω–æ–º–µ—Ä')
            );
            
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('–ø—Ä–æ–¥—É–∫—Ç') ||
                header.toLowerCase().includes('—Å—Ç–æ–∫–∞')
            );
            
            const transactionColumn = possibleTransactionColumns[0] || processedData.headers[0];
            const productColumn = possibleProductColumns[0] || processedData.headers[1];
            
            // Group products by transaction
            const transactions = {};
            
            processedData.data.forEach(row => {
                const transactionId = row[transactionColumn];
                const product = row[productColumn];
                
                if (transactionId && product) {
                    if (!transactions[transactionId]) {
                        transactions[transactionId] = new Set();
                    }
                    transactions[transactionId].add(product);
                }
            });
            
            // Convert to array of arrays
            return Object.values(transactions).map(set => Array.from(set));
        }
        
        function findFrequentItemsets(transactions, minSupport = 0.1) {
            const itemCounts = {};
            const totalTransactions = transactions.length;
            
            // Count individual items
            transactions.forEach(transaction => {
                transaction.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
            });
            
            // Find frequent 1-itemsets
            const frequentItems = Object.entries(itemCounts)
                .filter(([item, count]) => count / totalTransactions >= minSupport)
                .map(([item, count]) => ({ items: [item], count, support: count / totalTransactions }));
            
            // Find frequent 2-itemsets
            const frequent2Itemsets = [];
            for (let i = 0; i < frequentItems.length; i++) {
                for (let j = i + 1; j < frequentItems.length; j++) {
                    const itemset = [frequentItems[i].items[0], frequentItems[j].items[0]];
                    const count = transactions.filter(transaction => 
                        itemset.every(item => transaction.includes(item))
                    ).length;
                    
                    const support = count / totalTransactions;
                    if (support >= minSupport) {
                        frequent2Itemsets.push({ items: itemset, count, support });
                    }
                }
            }
            
            return [...frequentItems, ...frequent2Itemsets];
        }
        
        function generateAssociationRules(frequentItemsets, transactions, minConfidence = 0.5) {
            const rules = [];
            const totalTransactions = transactions.length;
            
            // Generate rules from 2-itemsets
            frequentItemsets
                .filter(itemset => itemset.items.length === 2)
                .forEach(itemset => {
                    const [itemA, itemB] = itemset.items;
                    
                    // Rule: A -> B
                    const countA = transactions.filter(t => t.includes(itemA)).length;
                    const countAB = itemset.count;
                    const confidenceAB = countAB / countA;
                    
                    if (confidenceAB >= minConfidence) {
                        rules.push({
                            antecedent: [itemA],
                            consequent: [itemB],
                            support: itemset.support,
                            confidence: confidenceAB,
                            lift: confidenceAB / (transactions.filter(t => t.includes(itemB)).length / totalTransactions)
                        });
                    }
                    
                    // Rule: B -> A
                    const countB = transactions.filter(t => t.includes(itemB)).length;
                    const confidenceBA = countAB / countB;
                    
                    if (confidenceBA >= minConfidence) {
                        rules.push({
                            antecedent: [itemB],
                            consequent: [itemA],
                            support: itemset.support,
                            confidence: confidenceBA,
                            lift: confidenceBA / (countA / totalTransactions)
                        });
                    }
                });
            
            return rules.sort((a, b) => b.confidence - a.confidence);
        }
        
        function getProductIcon(product) {
            const productLower = product.toLowerCase();
            
            // Food items
            if (productLower.includes('—Ö–ª—è–±') || productLower.includes('bread')) return 'üçû';
            if (productLower.includes('–º–ª—è–∫–æ') || productLower.includes('milk')) return 'ü•õ';
            if (productLower.includes('—Å–∏—Ä–µ–Ω–µ') || productLower.includes('cheese')) return 'üßÄ';
            if (productLower.includes('–∫–∞—Ñ–µ') || productLower.includes('coffee')) return '‚òï';
            if (productLower.includes('–∑–∞—Ö–∞—Ä') || productLower.includes('sugar')) return 'üçØ';
            if (productLower.includes('—è–±—ä–ª–∫–∞') || productLower.includes('apple')) return 'üçé';
            if (productLower.includes('–±–∞–Ω–∞–Ω') || productLower.includes('banana')) return 'üçå';
            if (productLower.includes('–º–µ—Å–æ') || productLower.includes('meat')) return 'ü•©';
            if (productLower.includes('—Ä–∏–±–∞') || productLower.includes('fish')) return 'üêü';
            if (productLower.includes('—è–π—Ü–∞') || productLower.includes('eggs')) return 'ü•ö';
            
            // Categories
            if (productLower.includes('–ø—Ä–æ–¥—É–∫—Ç') || productLower.includes('product')) return 'üì¶';
            if (productLower.includes('—Å—Ç–æ–∫–∞') || productLower.includes('item')) return 'üõçÔ∏è';
            
            return 'üè∑Ô∏è'; // Default icon
        }
        
        function displayMarketBasketResults(frequentItemsets, associationRules, transactions) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>üîç Market Basket Analysis - –ê–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</h3>
                    
                    <div class="business-insight revenue">
                        <h4>üìä –û–±—â–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                        <ul>
                            <li><strong>–û–±—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong> ${transactions.length} –±—Ä.</li>
                            <li><strong>–û—Ç–∫—Ä–∏—Ç–∏ —á–µ—Å—Ç–æ —Å—Ä–µ—â–∞–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</strong> ${frequentItemsets.filter(item => item.items.length === 1).length} –±—Ä.</li>
                            <li><strong>–û—Ç–∫—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –∞—Å–æ—Ü–∏–∞—Ü–∏—è:</strong> ${associationRules.length} –±—Ä.</li>
                            <li><strong>–°—Ä–µ–¥–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:</strong> ${(transactions.reduce((sum, t) => sum + t.length, 0) / transactions.length).toFixed(2)} –±—Ä.</li>
                        </ul>
                    </div>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <div class="business-insight products">
                        <h4>üîó –°–∏–ª–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –∞—Å–æ—Ü–∏–∞—Ü–∏—è:</h4>
                        <p>–ü—Ä–æ–¥—É–∫—Ç–∏, –∫–æ–∏—Ç–æ —Å–µ –∫—É–ø—É–≤–∞—Ç –∑–∞–µ–¥–Ω–æ:</p>
                        <div class="product-list">
                `;
                
                associationRules.slice(0, 10).forEach(rule => {
                    const antecedentIcon = getProductIcon(rule.antecedent[0]);
                    const consequentIcon = getProductIcon(rule.consequent[0]);
                    html += `
                        <div class="product-item">
                            <strong>${antecedentIcon} ${rule.antecedent[0]} ‚Üí ${consequentIcon} ${rule.consequent[0]}</strong><br>
                            <small>–£–≤–µ—Ä–µ–Ω–æ—Å—Ç: ${(rule.confidence * 100).toFixed(1)}% | Lift: ${rule.lift.toFixed(2)}</small>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            // Show top individual products
            const singleItems = frequentItemsets
                .filter(item => item.items.length === 1)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            if (singleItems.length > 0) {
                html += `
                    <div class="business-insight products">
                        <h4>‚≠ê –ù–∞–π-–ø–æ–ø—É–ª—è—Ä–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                        <div class="product-list">
                `;
                
                singleItems
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10)
                    .forEach((item, index) => {
                        const icon = getProductIcon(item.items[0]);
                        html += `
                            <div class="product-item">
                                ${icon} ${item.items[0]} (${item.count} –ø—ä—Ç–∏)
                            </div>
                        `;
                    });
                
                html += `</div>`;
            }
            
            html += `
                    <div class="business-insight recommendation">
                        <h4>üí° –ü—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –ø–æ–¥–æ–±—Ä—è–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥–∞–∂–±–∏—Ç–µ:</h4>
                        <ul>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <li>–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –±–ª–∏–∑–æ –µ–¥–∏–Ω –¥–æ –¥—Ä—É–≥ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ, –∫–æ–∏—Ç–æ —Å–µ –∫—É–ø—É–≤–∞—Ç –∑–∞–µ–¥–Ω–æ</li>
                    <li>–°—ä–∑–¥–∞–π—Ç–µ –ø—Ä–æ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∏ –ø–∞–∫–µ—Ç–∏ –æ—Ç —á–µ—Å—Ç–æ –∫—É–ø—É–≤–∞–Ω–∏—Ç–µ –∑–∞–µ–¥–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏</li>
                    <li>–ü—Ä–∏ —Ä–µ–∫–ª–∞–º–∞ –Ω–∞ –µ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç, —Å–ø–æ–º–µ–Ω–µ—Ç–µ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—Ç–µ —Å –Ω–µ–≥–æ</li>
                `;
            } else {
                html += `
                    <li>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –∑–∞—â–æ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ —Å–µ –∫—É–ø—É–≤–∞—Ç –ø–æ–æ—Ç–¥–µ–ª–Ω–æ</li>
                    <li>–°—ä–∑–¥–∞–π—Ç–µ –ø—Ä–æ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∏ –ø–∞–∫–µ—Ç–∏ –∑–∞ —Å—Ç–∏–º—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–º–±–∏–Ω–∏—Ä–∞–Ω–∏—Ç–µ –ø–æ–∫—É–ø–∫–∏</li>
                    <li>–ü—Ä–æ—É—á–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è –∑–∞ –ø–æ-–¥–æ–±—Ä–æ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–æ—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ</li>
                `;
            }
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const rulesCount = associationRules.length;
            const transactionsCount = transactions.length;
            const summaryText = `Market Basket –∞–Ω–∞–ª–∏–∑: ${rulesCount} –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –∞—Å–æ—Ü–∏–∞—Ü–∏—è, ${transactionsCount} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('üîç Market Basket –ê–Ω–∞–ª–∏–∑', contentText, summaryText);
        }
        
        // Business Analysis function
        function generateBusinessAnalysis() {
            if (!processedData) {
                showError('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∫–∞—á–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            try {
                const analysis = performBusinessAnalysis();
                displayBusinessAnalysis(analysis);
                showSuccess('–ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω!');
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –±–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
            }
        }
        
        function performBusinessAnalysis() {
            // Find relevant columns
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('–ø—Ä–æ–¥—É–∫—Ç') ||
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('—Å—Ç–æ–∫–∞')
            );
            
            const possiblePriceColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('price') || 
                header.toLowerCase().includes('—Ü–µ–Ω–∞') ||
                header.toLowerCase().includes('amount') ||
                header.toLowerCase().includes('—Å—É–º–∞') ||
                header.toLowerCase().includes('total') ||
                header.toLowerCase().includes('–æ–±—â–æ')
            );
            
            const possibleQuantityColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('quantity') || 
                header.toLowerCase().includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') ||
                header.toLowerCase().includes('qty') ||
                header.toLowerCase().includes('–±—Ä–æ–π')
            );
            
            const productColumn = possibleProductColumns[0];
            const priceColumn = possiblePriceColumns[0];
            const quantityColumn = possibleQuantityColumns[0];
            
            // Filter valid data (remove product codes)
            const validData = processedData.data.filter(row => {
                const product = row[productColumn];
                return product && product.length > 2 && !/^[A-Z0-9]+$/.test(product);
            });
            
            // Calculate statistics
            const productStats = {};
            let totalRevenue = 0;
            let totalTransactions = validData.length;
            
            validData.forEach(row => {
                const product = row[productColumn];
                const price = parseFloat(row[priceColumn]) || 0;
                const quantity = parseFloat(row[quantityColumn]) || 1;
                const revenue = price * quantity;
                
                if (!productStats[product]) {
                    productStats[product] = {
                        count: 0,
                        totalRevenue: 0,
                        avgPrice: 0,
                        totalQuantity: 0
                    };
                }
                
                productStats[product].count++;
                productStats[product].totalRevenue += revenue;
                productStats[product].totalQuantity += quantity;
                totalRevenue += revenue;
            });
            
            // Calculate market share and average prices
            Object.keys(productStats).forEach(product => {
                const stats = productStats[product];
                stats.marketShare = (stats.totalRevenue / totalRevenue) * 100;
                stats.avgPrice = stats.totalRevenue / stats.totalQuantity;
            });
            
            // Find top and worst products
            const sortedProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => b.totalRevenue - a.totalRevenue);
            
            const topProducts = sortedProducts.slice(0, 5);
            const worstProducts = sortedProducts.slice(-3).reverse();
            
            return {
                totalRevenue,
                totalTransactions,
                avgTransactionValue: totalRevenue / totalTransactions,
                topProducts,
                worstProducts,
                productCount: Object.keys(productStats).length
            };
        }
        
        function displayBusinessAnalysis(analysis) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>üíº –ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h3>
                    
                    <div class="business-insight revenue">
                        <h4>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤ –ø—Ä–µ–≥–ª–µ–¥:</h4>
                        <ul>
                            <li><strong>–û–±—â –æ–±–æ—Ä–æ—Ç:</strong> ${analysis.totalRevenue.toFixed(2)} –ª–≤.</li>
                            <li><strong>–û–±—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong> ${analysis.totalTransactions} –±—Ä.</li>
                            <li><strong>–°—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:</strong> ${analysis.avgTransactionValue.toFixed(2)} –ª–≤.</li>
                            <li><strong>–ë—Ä–æ–π —Ä–∞–∑–ª–∏—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</strong> ${analysis.productCount} –±—Ä.</li>
                        </ul>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>‚≠ê –ù–∞–π-–ø–µ—á–µ–ª–∏–≤—à–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                        <div class="product-list">
            `;
            
            analysis.topProducts.forEach(([product, stats], index) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        <strong>${index + 1}. ${icon} ${product}</strong><br>
                        <small>–û–±–æ—Ä–æ—Ç: ${stats.totalRevenue.toFixed(2)} –ª–≤. | –ü—Ä–æ–¥–∞–∂–±–∏: ${stats.count} –±—Ä. | –î—è–ª: ${stats.marketShare.toFixed(1)}%</small>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>‚ö†Ô∏è –°–ª–∞–±–æ –ø—Ä–æ–¥–∞–≤–∞–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                        <div class="product-list">
            `;
            
            analysis.worstProducts.forEach(([product, stats]) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        ${icon} ${product} - —Å–∞–º–æ ${stats.count} –±—Ä. –ø—Ä–æ–¥–∞–∂–±–∏
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight recommendation">
                        <h4>üéØ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ:</h4>
                        <ul>
                            <li><strong>–§–æ–∫—É—Å –≤—ä—Ä—Ö—É —Ç–æ–ø –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ:</strong> –£–≤–µ–ª–∏—á–µ—Ç–µ —Ä–µ–∫–ª–∞–º–∞—Ç–∞ –∏ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ ${analysis.topProducts.slice(0, 3).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>–ü—Ä–µ–æ—Å–º–∏—Å–ª–µ—Ç–µ —Å–ª–∞–±–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏:</strong> –ù–∞–º–∞–ª–µ—Ç–µ –∏–ª–∏ –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ –æ—Ç –∞—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ ${analysis.worstProducts.slice(0, 2).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>–ê–Ω–∞–ª–∏–∑ –Ω–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑—É–≤–∞–Ω–µ—Ç–æ:</strong> –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ü–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–ø –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ - –º–æ–∂–µ –¥–∞ –∏–º–∞—Ç–µ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç –∑–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ</li>
                            <li><strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø–∞—Å–∏—Ç–µ:</strong> –û—Å–∏–≥—É—Ä–µ—Ç–µ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç –ø–µ—á–µ–ª–∏–≤—à–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏</li>
                            <li><strong>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> –ù–∞—Å–æ—á–µ—Ç–µ —Ä–µ–∫–ª–∞–º–Ω–∏—è –±—é–¥–∂–µ—Ç –∫—ä–º –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ —Å –Ω–∞–π-–≤–∏—Å–æ–∫ –æ–±–æ—Ä–æ—Ç</li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const summaryText = `–ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑: –û–±–æ—Ä–æ—Ç ${analysis.totalRevenue.toFixed(2)} –ª–≤., ${analysis.totalTransactions} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, ${analysis.productCount} –ø—Ä–æ–¥—É–∫—Ç–∞`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('üíº –ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑', contentText, summaryText);
        }
        
        // Export functions - FIXED VERSION
        function exportToPDF() {
            try {
                // Show loading message
                showLoading('–ü–æ–¥–≥–æ—Ç–≤—è–Ω–µ –Ω–∞ PDF –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ...');
                
                // Hide the loading after a short delay
                setTimeout(() => {
                    hideLoading();
                    
                    // Show user-friendly message
                    showMessage('PDF –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ—Ç–æ —â–µ –∑–∞–ø–æ—á–Ω–µ —Å–ª–µ–¥ —Å–µ–∫—É–Ω–¥–∞. –ò–∑–±–µ—Ä–µ—Ç–µ "–ó–∞–ø–∞–∑–∏ –∫–∞—Ç–æ PDF" –≤ –¥–∏–∞–ª–æ–≥–∞ –∑–∞ –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ! üñ®Ô∏è', 'info');
                    
                    // Delay print dialog to give user time to read message
                    setTimeout(() => {
                        // Open browser's native print dialog
                        window.print();
                    }, 1500);
                    
                }, 800);
                
            } catch (error) {
                hideLoading();
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ PDF –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ: ' + error.message);
                console.error('PDF Print Error:', error);
            }
        }
        
        // Simplified download function
        function downloadFile(url, filename) {
            try {
                hideLoading();
                
                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                showMessage(`–§–∞–π–ª—ä—Ç "${filename}" –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìÅ`, 'success');
                
                // Cleanup URL after delay
                setTimeout(() => {
                    try {
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        console.warn('URL cleanup error:', e);
                    }
                }, 1000);
                
                console.log('Download completed:', filename);
                
            } catch (error) {
                hideLoading();
                console.error('Download error:', error);
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç–µ–≥–ª—è–Ω–µ: ' + error.message);
            }
        }
        
        function exportToExcel() {
            try {
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined') {
                    showError('Excel –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞. –ú–æ–ª—è, –ø—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.');
                    return;
                }
                
                if (!processedData) {
                    showError('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç.');
                    return;
                }
                
                showLoading('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª...');
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add main data sheet
                const ws = XLSX.utils.json_to_sheet(processedData.data);
                XLSX.utils.book_append_sheet(wb, ws, '–î–∞–Ω–Ω–∏');
                
                // Add summary sheet
                const summaryData = [
                    ['–û–±–æ–±—â–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ'],
                    ['–û–±—â–æ –∑–∞–ø–∏—Å–∏ (–±—Ä–æ–π)', processedData.data.length],
                    ['–ë—Ä–æ–π –∫–æ–ª–æ–Ω–∏ (–±—Ä–æ–π)', processedData.headers.length],
                    ['–î–∞—Ç–∞ –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç', new Date().toLocaleDateString('bg-BG')]
                ];
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, '–û–±–æ–±—â–µ–Ω–∏–µ');
                
                // Generate file
                const filename = `BI_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                const excelBlob = new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const url = window.URL.createObjectURL(excelBlob);
                console.log('Excel generated successfully:', filename, 'Size:', excelBlob.size, 'bytes');
                downloadFile(url, filename);
                
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel: ' + error.message);
                console.error('Excel Export Error:', error);
            }
        }
    </script>
</body>
</html>