<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Analyzer - –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6; color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px; margin: 0 auto; padding: 20px;
            background: white; margin-top: 20px; margin-bottom: 20px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center; margin-bottom: 40px; padding: 30px 0;
            background: linear-gradient(135deg, #4a90e2 0%, #50c9c3 100%);
            border-radius: 15px; color: white;
        }
        .header h1 {
            font-size: 2.5em; margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .upload-section {
            background: #f8f9fa; padding: 30px; border-radius: 15px;
            margin-bottom: 30px; border: 2px dashed #007bff;
            text-align: center; transition: all 0.3s ease;
        }
        .upload-section:hover {
            border-color: #0056b3; background: #e3f2fd;
        }
        .file-input-wrapper {
            position: relative; display: inline-block; margin: 20px 0;
        }
        .file-input { display: none; }
        .file-input-label {
            background: #007bff; color: white; padding: 15px 30px;
            border-radius: 25px; cursor: pointer; font-size: 1.1em;
            transition: all 0.3s ease; display: inline-block;
        }
        .file-input-label:hover {
            background: #0056b3; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        .btn {
            background: #28a745; color: white; border: none;
            padding: 12px 24px; border-radius: 25px; cursor: pointer;
            font-size: 1em; margin: 10px; transition: all 0.3s ease;
            text-decoration: none; display: inline-block;
        }
        .btn:hover {
            background: #218838; transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        .btn-group { text-align: center; margin: 30px 0; }
        .results-section {
            margin-top: 30px; padding: 20px; background: #f8f9fa;
            border-radius: 15px; min-height: 100px;
        }
        .chart-container {
            background: white; padding: 30px; border-radius: 15px;
            margin: 20px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .chart-title {
            color: #4a90e2; margin-bottom: 20px; font-size: 1.5em;
            text-align: center; border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        .product-analysis {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px; margin: 20px 0;
        }
        .product-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px; border-radius: 15px; border-left: 5px solid #28a745;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .product-card h4 {
            color: #2c3e50; margin-bottom: 15px; font-size: 1.2em;
            display: flex; align-items: center; gap: 8px;
        }
        .product-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #dee2e6; font-size: 0.95em;
        }
        .product-item:last-child { border-bottom: none; }
        .product-item span:first-child {
            font-weight: 500; color: #495057;
        }
        .product-item span:last-child {
            font-weight: bold; color: #28a745; background: #e8f5e8;
            padding: 2px 8px; border-radius: 12px; font-size: 0.9em;
        }
        .business-insights {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px; border-radius: 15px; border-left: 5px solid #ffc107;
            margin: 20px 0;
        }
        .business-insights h4 {
            color: #856404; margin-bottom: 15px; font-size: 1.2em;
        }
        .insight-item {
            margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.7);
            border-radius: 8px; line-height: 1.5;
        }
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 25px;
            border-radius: 8px; color: white; font-weight: bold;
            z-index: 1000; opacity: 0; transform: translateX(100%);
            transition: all 0.3s ease;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Market Basket Analyzer</h1>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –≤—Ä—ä–∑–∫–∏—Ç–µ –º–µ–∂–¥—É –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –≤—ä–≤ –≤–∞—à–∏—Ç–µ –¥–∞–Ω–Ω–∏</p>
        </div>
        
        <div class="upload-section">
            <h2>üìÇ –ö–∞—á–µ—Ç–µ CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏ –∑–∞ –ø—Ä–æ–¥–∞–∂–±–∏</h2>
            <p>–§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ –∫–æ–ª–æ–Ω–∏ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ –ø–æ—Ä—ä—á–∫–∏</p>
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv">
                <label for="csvFile" class="file-input-label">
                    üìé –ò–∑–±–µ—Ä–µ—Ç–µ CSV —Ñ–∞–π–ª
                </label>
            </div>
            <br>
            <button class="btn" onclick="loadData()">üìä –ó–∞—Ä–µ–¥–∏ –¥–∞–Ω–Ω–∏—Ç–µ</button>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="performMarketBasketAnalysis()">üîç Market Basket –ê–Ω–∞–ª–∏–∑</button>
            <button class="btn" onclick="exportToPDF()">üìë –ï–∫—Å–ø–æ—Ä—Ç PDF</button>
            <button class="btn" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
        </div>
        
        <div class="results-section">
            <div id="analysisResults">
                <p style="text-align: center; color: #666; font-style: italic;">
                    –ö–∞—á–µ—Ç–µ CSV —Ñ–∞–π–ª –∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ "Market Basket –ê–Ω–∞–ª–∏–∑" –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ
                </p>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ JavaScript starting...');
        
        let processedData = null;
        
        function showNotification(message, type) {
            console.log('üì¢ Notification:', message, type);
            const notification = document.createElement('div');
            notification.className = 'notification ' + (type || 'success');
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(function() { notification.classList.add('show'); }, 100);
            
            setTimeout(function() {
                notification.classList.remove('show');
                setTimeout(function() {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        function loadData() {
            console.log('üìä Loading CSV data...');
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ CSV —Ñ–∞–π–ª!', 'warning');
                return;
            }
            
            console.log('üìÅ File selected:', file.name, file.size + ' bytes');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('üìñ Reading file content...');
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(function(line) { return line.trim(); });
                    
                    if (lines.length < 2) {
                        throw new Error('–§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –ø–æ–Ω–µ –∑–∞–≥–ª–∞–≤–Ω–∏ —Ä–µ–¥–æ–≤–µ –∏ –µ–¥–∏–Ω —Ä–µ–¥ —Å –¥–∞–Ω–Ω–∏');
                    }
                    
                    const headers = lines[0].split(',').map(function(h) { 
                        return h.trim().replace(/"/g, ''); 
                    });
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].split(',').map(function(cell) { 
                            return cell.trim().replace(/"/g, ''); 
                        });
                        if (row.length === headers.length) {
                            data.push(row);
                        }
                    }
                    
                    processedData = {
                        fileName: file.name,
                        headers: headers,
                        data: data
                    };
                    
                    console.log('‚úÖ Data processed:', data.length + ' rows, ' + headers.length + ' columns');
                    showNotification('‚úÖ –î–∞–Ω–Ω–∏ –∑–∞—Ä–µ–¥–µ–Ω–∏: ' + data.length + ' –∑–∞–ø–∏—Å–∞, ' + headers.length + ' –∫–æ–ª–æ–Ω–∏', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Error loading data:', error);
                    showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                console.error('‚ùå FileReader error');
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞', 'error');
            };
            
            reader.readAsText(file);
        }
        
        function performMarketBasketAnalysis() {
            console.log('üîç Starting Market Basket Analysis...');
            
            if (!processedData) {
                showNotification('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏!', 'warning');
                return;
            }
            
            try {
                const results = document.getElementById('analysisResults');
                let html = '<div class="chart-container">';
                html += '<h3 class="chart-title">üõí Market Basket –ê–Ω–∞–ª–∏–∑ - –ê–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</h3>';
                
                const productColumns = [];
                let productCounts = {};
                
                processedData.headers.forEach(function(header, index) {
                    const lowerHeader = header.toLowerCase();
                    if (lowerHeader.includes('product') || lowerHeader.includes('item') || 
                        lowerHeader.includes('–∞—Ä—Ç–∏–∫—É–ª') || lowerHeader.includes('–ø—Ä–æ–¥—É–∫—Ç') ||
                        lowerHeader.includes('—Å—Ç–æ–∫–∞') || lowerHeader.includes('—Ç–æ–≤–∞—Ä')) {
                        productColumns.push({ name: header, index: index });
                    }
                });
                
                if (productColumns.length > 0) {
                    const productColumn = productColumns[0];
                    const totalTransactions = processedData.data.length;
                    
                    processedData.data.forEach(function(row) {
                        const product = row[productColumn.index];
                        if (product && product !== '') {
                            productCounts[product] = (productCounts[product] || 0) + 1;
                        }
                    });
                    
                    const sortedProducts = Object.entries(productCounts)
                        .sort(function(a, b) { return b[1] - a[1]; })
                        .slice(0, 15);
                    
                    html += '<div class="product-analysis">';
                    
                    html += '<div class="product-card">';
                    html += '<h4>üèÜ –ù–∞–π-–ø–æ–ø—É–ª—è—Ä–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</h4>';
                    sortedProducts.slice(0, 10).forEach(function(item, index) {
                        const product = item[0];
                        const count = item[1];
                        const percentage = ((count / totalTransactions) * 100).toFixed(1);
                        let emoji = 'üîπ';
                        if (index === 0) emoji = 'ü•á';
                        else if (index === 1) emoji = 'ü•à'; 
                        else if (index === 2) emoji = 'ü•â';
                        else if (index < 5) emoji = '‚≠ê';
                        
                        html += '<div class="product-item">';
                        html += '<span>' + emoji + ' ' + product + '</span>';
                        html += '<span>' + count + ' –ø—ä—Ç–∏ (' + percentage + '%)</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                    
                    html += '<div class="product-card">';
                    html += '<h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ</h4>';
                    html += '<div class="product-item"><span>üõçÔ∏è –û–±—â–æ —É–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</span><span>' + Object.keys(productCounts).length + '</span></div>';
                    html += '<div class="product-item"><span>üßæ –û–±—â–æ –∑–∞–ø–∏—Å–∏:</span><span>' + totalTransactions + '</span></div>';
                    
                    const avgPerProduct = (totalTransactions / Object.keys(productCounts).length).toFixed(1);
                    html += '<div class="product-item"><span>üìà –°—Ä–µ–¥–Ω–æ –ø—Ä–æ–¥–∞–∂–±–∏ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç:</span><span>' + avgPerProduct + '</span></div>';
                    html += '</div>';
                    html += '</div>';
                    
                    const topProduct = sortedProducts[0];
                    const topPercentage = ((topProduct[1] / totalTransactions) * 100).toFixed(1);
                    
                    html += '<div class="business-insights">';
                    html += '<h4>üí° –ë–∏–∑–Ω–µ—Å –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h4>';
                    html += '<div class="insight-item">';
                    html += '<strong>üéØ –í–æ–¥–µ—â –ø—Ä–æ–¥—É–∫—Ç:</strong> "' + topProduct[0] + '" –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–≤–∞ ' + topPercentage + '% –æ—Ç –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥–∞–∂–±–∏';
                    html += '</div>';
                    
                    if (sortedProducts.length > 5) {
                        let top5Count = 0;
                        for (let i = 0; i < 5; i++) {
                            top5Count += sortedProducts[i][1];
                        }
                        const top5Percentage = ((top5Count / totalTransactions) * 100).toFixed(1);
                        html += '<div class="insight-item">';
                        html += '<strong>üìà –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è:</strong> –¢–æ–ø 5 –ø—Ä–æ–¥—É–∫—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç ' + top5Percentage + '% –æ—Ç –ø—Ä–æ–¥–∞–∂–±–∏—Ç–µ';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    
                } else {
                    html += '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 15px; border-left: 5px solid #dc3545;">';
                    html += '<h4>‚ùå –ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏ –¥–∞–Ω–Ω–∏ –∑–∞ Market Basket –∞–Ω–∞–ª–∏–∑</h4>';
                    html += '<p>–ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ –∫–æ–ª–æ–Ω–∏ —Å –ø—Ä–æ–¥—É–∫—Ç–∏. –ù–µ–æ–±—Ö–æ–¥–∏–º–∏ —Å–∞ –∫–æ–ª–æ–Ω–∏ –∫–∞—Ç–æ "product", "item", "–ø—Ä–æ–¥—É–∫—Ç", "–∞—Ä—Ç–∏–∫—É–ª"</p>';
                    html += '</div>';
                }
                
                html += '</div>';
                results.innerHTML = html;
                
                console.log('‚úÖ Market Basket Analysis completed');
                showNotification('Market Basket –∞–Ω–∞–ª–∏–∑—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω! üõí', 'success');
                
            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'error');
            }
        }
        
        function exportToPDF() {
            console.log('üìë Starting PDF export...');
            
            if (!processedData) {
                showNotification('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!', 'warning');
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF —Ñ–∞–π–ª...', 'success');
                
                if (typeof jsPDF === 'undefined') {
                    throw new Error('jsPDF –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞');
                }
                
                const doc = new jsPDF.jsPDF();
                let yPos = 20;
                
                doc.setFontSize(18);
                doc.text('Market Basket Analysis Report', 20, yPos);
                yPos += 15;
                
                doc.setFontSize(12);
                const dateStr = new Date().toLocaleString('bg-BG');
                doc.text('Date: ' + dateStr, 20, yPos);
                yPos += 15;
                
                doc.setFontSize(10);
                doc.text('File: ' + processedData.fileName, 20, yPos);
                yPos += 8;
                doc.text('Records: ' + processedData.data.length, 20, yPos);
                yPos += 8;
                doc.text('Columns: ' + processedData.headers.length, 20, yPos);
                
                const pdfBlob = doc.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = 'Market_Basket_Analysis_' + new Date().getTime() + '.pdf';
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                setTimeout(function() {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                console.log('‚úÖ PDF export completed');
                showNotification('PDF —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìÑ', 'success');
                
            } catch (error) {
                console.error('‚ùå PDF Export Error:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF: ' + error.message, 'error');
            }
        }
        
        function exportToExcel() {
            console.log('üìä Starting Excel export...');
            
            if (!processedData) {
                showNotification('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!', 'warning');
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª...', 'success');
                
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞');
                }
                
                const wb = XLSX.utils.book_new();
                const excelData = [];
                
                if (processedData.headers) {
                    excelData.push(processedData.headers);
                }
                
                if (processedData.data) {
                    processedData.data.forEach(function(row) {
                        excelData.push(row);
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const excelBlob = new Blob([excelBuffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const url = URL.createObjectURL(excelBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = 'Market_Basket_Analysis_' + new Date().getTime() + '.xlsx';
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                setTimeout(function() {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                }, 100);
                
                console.log('‚úÖ Excel export completed');
                showNotification('Excel —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìä', 'success');
                
            } catch (error) {
                console.error('‚ùå Excel Export Error:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel: ' + error.message, 'error');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM loaded successfully');
            showNotification('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –µ –≥–æ—Ç–æ–≤–æ –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ! üöÄ', 'success');
        });
        
        console.log('‚úÖ JavaScript loaded successfully');
    </script>
</body>
</html>