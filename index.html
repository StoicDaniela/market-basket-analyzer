<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä - –°–≤–µ–∂–∞ –í–µ—Ä—Å–∏—è</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #e3f2fd;
        }
        
        .upload-section input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .control-group h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container canvas {
            max-height: 400px;
        }
        
        .analysis-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }
        
        .business-insight {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        
        .business-insight.revenue {
            border-left-color: #28a745;
        }
        
        .business-insight.products {
            border-left-color: #ffc107;
        }
        
        .business-insight.recommendation {
            border-left-color: #dc3545;
        }
        
        .product-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .product-list {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading.show {
            display: block;
        }
        
        .export-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .export-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .data-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-preview th,
        .data-preview td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-preview th {
            background: #f5f5f5;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .download-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            min-width: 400px;
            text-align: center;
        }
        
        .download-notification.error {
            border-color: #dc3545;
        }
        
        .download-notification.info {
            border-color: #17a2b8;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .notification-body {
            margin-bottom: 20px;
            color: #666;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .notification-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .notification-btn:not(.secondary) {
            background: #28a745;
            color: white;
        }
        
        .notification-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .notification-btn.disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .analysis-controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .download-notification {
                min-width: 90%;
                margin: 0 5%;
            }
        }
        
        /* History section styles */
        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-item-date {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }
        
        .history-item-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .history-item-content {
            color: #333;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Business Intelligence –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</h1>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –≤–∞—à–∏—Ç–µ –¥–∞–Ω–Ω–∏ –∏ –ø–æ–ª—É—á–µ—Ç–µ —Ü–µ–Ω–Ω–∏ –±–∏–∑–Ω–µ—Å —Ä–µ—à–µ–Ω–∏—è</p>
        </div>
        
        <div class="upload-section">
            <h2>üìÅ –ö–∞—á–µ—Ç–µ –≤–∞—à–∏—è —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏</h2>
            <p>–ü–æ–¥–¥—ä—Ä–∂–∞–º–µ CSV –∏ Excel —Ñ–∞–π–ª–æ–≤–µ</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
            <br>
            <button class="btn" onclick="loadFile()">üöÄ –ó–∞—Ä–µ–¥–∏ –¥–∞–Ω–Ω–∏—Ç–µ</button>
        </div>
        
        <div class="data-preview" id="dataPreview" style="display: none;">
            <h3>üëÄ –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ</h3>
            <div id="previewContent"></div>
        </div>
        
        <div class="analysis-controls">
            <div class="control-group">
                <h3>üìà –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–∏</h3>
                <p>–°—ä–∑–¥–∞–π—Ç–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ –≤–∞—à–∏—Ç–µ –¥–∞–Ω–Ω–∏</p>
                <button class="btn" onclick="generateCharts()">üìä –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –¥–∏–∞–≥—Ä–∞–º–∏</button>
            </div>
            
            <div class="control-group">
                <h3>üõí –ê–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</h3>
                <p>–û—Ç–∫—Ä–∏–π—Ç–µ –≤—Ä—ä–∑–∫–∏ –º–µ–∂–¥—É –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ</p>
                <button class="btn" onclick="performMarketBasketAnalysis()">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –≤—Ä—ä–∑–∫–∏—Ç–µ</button>
            </div>
            
            <div class="control-group">
                <h3>üíº –ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑</h3>
                <p>–ü–æ–ª—É—á–µ—Ç–µ –±–∏–∑–Ω–µ—Å –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏</p>
                <button class="btn" onclick="generateBusinessAnalysis()">üí° –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∞–Ω–∞–ª–∏–∑</button>
            </div>
        </div>
        
        <div class="export-section">
            <h3>üì§ –ï–∫—Å–ø–æ—Ä—Ç –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ</h3>
            <p>–ò–∑—Ç–µ–≥–ª–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ –≤ —É–¥–æ–±–µ–Ω —Ñ–æ—Ä–º–∞—Ç</p>
            <button class="btn" onclick="exportToPDF()"> –ï–∫—Å–ø–æ—Ä—Ç PDF </button> 
            
            
            <button class="btn" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
            <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 0.9em;">
                <strong>üí° –°—ä–≤–µ—Ç–∏ –∑–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ:</strong>
                <ul style="margin: 5px 0 0 20px; text-align: left;">
                    <li>–ê–∫–æ —Ñ–∞–π–ª—ä—Ç –Ω–µ —Å–µ –∏–∑—Ç–µ–≥–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –±—Ä–∞—É–∑—ä—Ä–∞ –∑–∞ –±–ª–æ–∫–∏—Ä–∞–Ω–∏ pop-up –ø—Ä–æ–∑–æ—Ä—Ü–∏</li>
                    <li>–§–∞–π–ª–æ–≤–µ—Ç–µ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç –≤ –ø–∞–ø–∫–∞—Ç–∞ "Downloads" –Ω–∞ –∫–æ–º–ø—é—Ç—ä—Ä–∞</li>

  }

        function printToPDF() {
            console.log('üñ®Ô∏è Starting print to PDF...');
            
            if (!processedData || !currentAnalysisResult) {
                showNotification('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç. –ú–æ–ª—è, –ø—ä—Ä–≤–æ –Ω–∞–ø—Ä–∞–≤–µ—Ç–µ –∞–Ω–∞–ª–∏–∑.', 'error');
                return;
            }
            
            showNotification('–û—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –¥–∏–∞–ª–æ–≥ –∑–∞ –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ...', 'success');
            
            // Hide export buttons temporarily
            const exportButtons = document.getElementById('exportButtons');
            exportButtons.style.display = 'none';
            
            setTimeout(() => {
                window.print();
                exportButtons.style.display = 'block';
            }, 500);
        }

        function exportToExcel() {
            console.log('üìä Starting Excel export...');
            
            if (!processedData || !currentAnalysisResult) {
                showNotification('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç. –ú–æ–ª—è, –ø—ä—Ä–≤–æ –Ω–∞–ø—Ä–∞–≤–µ—Ç–µ –∞–Ω–∞–ª–∏–∑.', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                showNotification('Excel –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞. –û–ø—Ä–µ—Å–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.', 'error');
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª...', 'success');
                
                const wb = XLSX.utils.book_new();
                
                // Summary sheet
                const summaryData = [
                    ['Market Basket Analysis Report'],
                    ['–§–∞–π–ª:', processedData.fileName],
                    ['–î–∞—Ç–∞:', new Date().toLocaleString('bg-BG')],
                    [''],
                    ['–û–±—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', currentAnalysisResult.totalTransactions],
                    ['–£–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:', currentAnalysisResult.uniqueItems],
                    ['–°—Ä–µ–¥–Ω–∞ –∫–æ—à–Ω–∏—Ü–∞:', currentAnalysisResult.averageBasketSize.toFixed(2)],
                ];
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, '–û–±–æ–±—â–µ–Ω–∏–µ');
                
                // Top items sheet
                const topItemsData = [
                    ['–ü—Ä–æ–¥—É–∫—Ç', '–ü–æ–∫—É–ø–∫–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç'],
                    ...currentAnalysisResult.topItems.map(([item, freq]) => [
                        item, 
                        freq, 
                        ((freq / currentAnalysisResult.totalTransactions) * 100).toFixed(1) + '%'
                    ])
                ];
                
                const topItemsSheet = XLSX.utils.aoa_to_sheet(topItemsData);
                XLSX.utils.book_append_sheet(wb, topItemsSheet, '–¢–æ–ø –ø—Ä–æ–¥—É–∫—Ç–∏');
                
                // Rules sheet
                const rulesData = [
                    ['–ê–∫–æ –∫—É–ø–∏', '–©–µ –∫—É–ø–∏ –∏', 'Support %', 'Confidence %', 'Lift'],
                    ...currentAnalysisResult.rules.map(rule => [
                        rule.antecedent,
                        rule.consequent,
                        (rule.support * 100).toFixed(2),
                        (rule.confidence * 100).toFixed(2),
                        rule.lift.toFixed(3)
                    ])
                ];
                
                const rulesSheet = XLSX.utils.aoa_to_sheet(rulesData);
                XLSX.utils.book_append_sheet(wb, rulesSheet, '–ê—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞');
                
                const fileName = `Market_Basket_Analysis_${processedData.fileName.replace(/\.[^/.]+$/, "")}_${new Date().getTime()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                console.log('‚úÖ Excel export completed');
                showNotification('Excel —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìä', 'success');
                
            } catch (error) {
                console.error('‚ùå Excel Export Error:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel: ' + error.message, 'error');
            }
        }

                    
                    
                </ul>
            </div>
        </div>
        
        <div class="history-section" style="margin-top: 30px;">
            <h3>üìö –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ</h3>
            <p>–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –ø—Ä–µ–¥–∏—à–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ –∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</p>
            <button class="btn" onclick="showAnalysisHistory()">üìñ –ü–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—è</button>
            <button class="btn secondary" onclick="clearAnalysisHistory()" style="margin-left: 10px;">üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è</button>
            <div id="historyContainer" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <h3>‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ...</h3>
            <p>–ú–æ–ª—è, –∏–∑—á–∞–∫–∞–π—Ç–µ...</p>
        </div>
        
        <div class="loading" id="exportLoading">
            <h3>üì¶ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª...</h3>
            <p>–§–∞–π–ª—ä—Ç —Å–µ –ø–æ–¥–≥–æ—Ç–≤—è –∑–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ...</p>
        </div>
        
        <div class="results-section">
            <div id="chartContainer"></div>
            <div id="analysisResults"></div>
        </div>
    </div>
    
    <script>
        let processedData = null;
        let currentCharts = [];
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
        
        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        function showInfo(message) {
            showNotification(message, 'info');
        }
        
        function showLoading(message) {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.innerHTML = `<h3>‚è≥ ${message}</h3><p>–ú–æ–ª—è, –∏–∑—á–∞–∫–∞–π—Ç–µ...</p>`;
                loading.style.display = 'block';
            }
        }
        
        function hideLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) loading.style.display = 'none';
        }
        
        // Analysis History Functions
        function saveToHistory(type, content, summary) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toLocaleString('bg-BG'),
                type: type,
                content: content,
                summary: summary || '–ê–Ω–∞–ª–∏–∑ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–µ'
            };
            
            analysisHistory.unshift(historyItem); // Add to beginning
            
            // Keep only last 20 items
            if (analysisHistory.length > 20) {
                analysisHistory = analysisHistory.slice(0, 20);
            }
            
            // Save to localStorage
            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            console.log('Analysis saved to history:', type, summary);
        }
        
        function showAnalysisHistory() {
            const container = document.getElementById('historyContainer');
            
            if (analysisHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>üì≠ –ù—è–º–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏</p>
                        <p style="font-size: 0.9em;">–ù–∞–ø—Ä–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è —Å–∏ –∞–Ω–∞–ª–∏–∑, –∑–∞ –¥–∞ —Å–µ –ø–æ—è–≤–∏ —Ç—É–∫!</p>
                    </div>
                `;
            } else {
                let historyHtml = '<h4>üìö –ó–∞–ø–∞–∑–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ (' + analysisHistory.length + ' –±—Ä.)</h4>';
                
                analysisHistory.forEach(item => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-date">${item.date}</span>
                                <span class="history-item-type">${item.type}</span>
                            </div>
                            <div class="history-item-content">
                                <strong>${item.summary}</strong><br>
                                ${item.content.substring(0, 300)}${item.content.length > 300 ? '...' : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = historyHtml;
            }
            
            // Toggle visibility
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function clearAnalysisHistory() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ?')) {
                analysisHistory = [];
                localStorage.removeItem('analysisHistory');
                
                const container = document.getElementById('historyContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>‚úÖ –ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—á–∏—Å—Ç–µ–Ω–∞</p>
                    </div>
                `;
                
                showSuccess('–ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ –µ –∏–∑—á–∏—Å—Ç–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                
                // Hide container after 2 seconds
                setTimeout(() => {
                    container.style.display = 'none';
                }, 2000);
            }
        }
        
        // File loading functions
        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª –ø—ä—Ä–≤–æ.');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('show');
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = function(e) {
                    try {
                        processedData = parseCSV(e.target.result);
                        displayDataPreview();
                        showSuccess('CSV —Ñ–∞–π–ª—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } catch (error) {
                        showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ CSV —Ñ–∞–π–ª–∞: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        processedData = parseArrayData(jsonData);
                        displayDataPreview();
                        showSuccess('Excel —Ñ–∞–π–ª—ä—Ç –µ –∑–∞—Ä–µ–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } catch (error) {
                        showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª–∞: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                showError('–ù–µ–ø–æ–¥–¥—ä—Ä–∂–∞–Ω —Ñ–∞–π–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç. –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ CSV –∏–ª–∏ Excel —Ñ–∞–π–ª–æ–≤–µ.');
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return { headers, data };
        }
        
        function parseArrayData(arrayData) {
            if (arrayData.length === 0) {
                throw new Error('–§–∞–π–ª—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω');
            }
            
            const headers = arrayData[0].map(h => String(h || '').trim());
            const data = [];
            
            for (let i = 1; i < arrayData.length; i++) {
                if (arrayData[i] && arrayData[i].some(cell => cell !== null && cell !== undefined && cell !== '')) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = String(arrayData[i][index] || '').trim();
                    });
                    data.push(row);
                }
            }
            
            return { headers, data };
        }
        
        function displayDataPreview() {
            const previewDiv = document.getElementById('dataPreview');
            const contentDiv = document.getElementById('previewContent');
            
            if (!processedData || processedData.data.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            ${processedData.headers.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const previewRows = Math.min(5, processedData.data.length);
            for (let i = 0; i < previewRows; i++) {
                html += '<tr>';
                processedData.headers.forEach(header => {
                    html += `<td>${processedData.data[i][header] || ''}</td>`;
                });
                html += '</tr>';
            }
            
            html += `
                    </tbody>
                </table>
                <p><small>–ü–æ–∫–∞–∑–∞–Ω–∏ —Å–∞ –ø—ä—Ä–≤–∏—Ç–µ ${previewRows} –æ—Ç –æ–±—â–æ ${processedData.data.length} –∑–∞–ø–∏—Å–∞</small></p>
            `;
            
            contentDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        }
        
        // Chart generation functions
        function generateCharts() {
            if (!processedData) {
                showError('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∫–∞—á–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            try {
                clearExistingCharts();
                createCharts();
                showSuccess('–î–∏–∞–≥—Ä–∞–º–∏—Ç–µ —Å–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —É—Å–ø–µ—à–Ω–æ!');
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–∏: ' + error.message);
                console.error('Chart generation error:', error);
            }
        }
        
        function clearExistingCharts() {
            currentCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            currentCharts = [];
            
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';
        }
        
        function createCharts() {
            const container = document.getElementById('chartContainer');
            
            // Find suitable columns for charting
            const numericColumns = findNumericColumns();
            const textColumns = findTextColumns();
            
            if (numericColumns.length === 0) {
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>‚ö†Ô∏è –ù—è–º–∞ —á–∏—Å–ª–æ–≤–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –¥–∏–∞–≥—Ä–∞–º–∏</h3>
                        <p>–§–∞–π–ª—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ —á–∏—Å–ª–æ–≤–∏ –∫–æ–ª–æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏ –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è.</p>
                    </div>
                `;
                return;
            }
            
            // Create bar chart for first numeric column
            if (numericColumns.length > 0 && textColumns.length > 0) {
                createBarChart(textColumns[0], numericColumns[0]);
            }
            
            // Create pie chart if we have categorical data
            if (textColumns.length > 0) {
                createPieChart(textColumns[0]);
            }
            
            // Create line chart for trends
            if (numericColumns.length >= 2) {
                createLineChart(numericColumns[0], numericColumns[1]);
            }
            
            // Save charts to history
            const chartsCreated = [];
            if (numericColumns.length > 0 && textColumns.length > 0) chartsCreated.push('Bar Chart');
            if (textColumns.length > 0) chartsCreated.push('Pie Chart');
            if (numericColumns.length >= 2) chartsCreated.push('Line Chart');
            
            if (chartsCreated.length > 0) {
                const summaryText = `–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: ${chartsCreated.join(', ')} –æ—Ç ${processedData.data.length} –∑–∞–ø–∏—Å–∞`;
                const contentText = `–°—ä–∑–¥–∞–¥–µ–Ω–∏ –¥–∏–∞–≥—Ä–∞–º–∏: ${chartsCreated.join(', ')}\n–î–∞–Ω–Ω–∏: ${processedData.data.length} –∑–∞–ø–∏—Å–∞\n–ö–æ–ª–æ–Ω–∏: ${processedData.headers.join(', ')}`;
                saveToHistory('üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è', contentText, summaryText);
            }
        }
        
        function findNumericColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && !isNaN(parseFloat(value)) && isFinite(value);
                });
            });
        }
        
        function findTextColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && isNaN(parseFloat(value));
                });
            });
        }
        
        function createBarChart(labelColumn, valueColumn) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3>üìä ${labelColumn} vs ${valueColumn} (–±—Ä–æ–π)</h3>
                <canvas id="barChart"></canvas>
            `;
            document.getElementById('chartContainer').appendChild(chartContainer);
            
            const ctx = document.getElementById('barChart').getContext('2d');
            
            // Aggregate data
            const dataMap = {};
            processedData.data.forEach(row => {
                const label = row[labelColumn] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const value = parseFloat(row[valueColumn]) || 0;
                
                if (dataMap[label]) {
                    dataMap[label] += value;
                } else {
                    dataMap[label] = value;
                }
            });
            
            const labels = Object.keys(dataMap).slice(0, 10); // Top 10
            const values = labels.map(label => dataMap[label]);
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: valueColumn,
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `${valueColumn} (–±—Ä–æ–π)`
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: labelColumn
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createPieChart(column) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3>ü•ß –†–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ ${column} (–±—Ä–æ–π –ø—Ä–æ–¥–∞–∂–±–∏)</h3>
                <canvas id="pieChart"></canvas>
            `;
            document.getElementById('chartContainer').appendChild(chartContainer);
            
            const ctx = document.getElementById('pieChart').getContext('2d');
            
            // Count occurrences
            const counts = {};
            processedData.data.forEach(row => {
                const value = row[column] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                counts[value] = (counts[value] || 0) + 1;
            });
            
            const labels = Object.keys(counts).slice(0, 8); // Top 8
            const values = labels.map(label => counts[label]);
            
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createLineChart(xColumn, yColumn) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3>üìà –¢—Ä–µ–Ω–¥: ${xColumn} / ${yColumn}</h3>
                <canvas id="lineChart"></canvas>
            `;
            document.getElementById('chartContainer').appendChild(chartContainer);
            
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            const data = processedData.data
                .filter(row => row[xColumn] && row[yColumn])
                .map(row => ({
                    x: parseFloat(row[xColumn]) || 0,
                    y: parseFloat(row[yColumn]) || 0
                }))
                .sort((a, b) => a.x - b.x);
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${yColumn} –ø–æ ${xColumn}`,
                        data: data,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: `${xColumn} (—Å—Ç–æ–π–Ω–æ—Å—Ç)`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `${yColumn} (—Å—Ç–æ–π–Ω–æ—Å—Ç)`
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        // Market Basket Analysis functions
        function performMarketBasketAnalysis() {
            if (!processedData) {
                showError('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∫–∞—á–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            try {
                const transactions = extractTransactions();
                const frequentItemsets = findFrequentItemsets(transactions);
                const associationRules = generateAssociationRules(frequentItemsets, transactions);
                
                displayMarketBasketResults(frequentItemsets, associationRules, transactions);
                showSuccess('–ê–Ω–∞–ª–∏–∑—ä—Ç –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω!');
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞: ' + error.message);
                console.error('Market basket analysis error:', error);
            }
        }
        
        function extractTransactions() {
            // Find transaction and product columns
            const possibleTransactionColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('transaction') || 
                header.toLowerCase().includes('order') ||
                header.toLowerCase().includes('id') ||
                header.toLowerCase().includes('–Ω–æ–º–µ—Ä')
            );
            
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('–ø—Ä–æ–¥—É–∫—Ç') ||
                header.toLowerCase().includes('—Å—Ç–æ–∫–∞')
            );
            
            const transactionColumn = possibleTransactionColumns[0] || processedData.headers[0];
            const productColumn = possibleProductColumns[0] || processedData.headers[1];
            
            const transactions = {};
            
            processedData.data.forEach(row => {
                const transactionId = row[transactionColumn];
                const product = row[productColumn];
                
                if (transactionId && product) {
                    if (!transactions[transactionId]) {
                        transactions[transactionId] = [];
                    }
                    if (!transactions[transactionId].includes(product)) {
                        transactions[transactionId].push(product);
                    }
                }
            });
            
            return transactions;
        }
        
        function getProductIcon(productName) {
            const product = productName.toLowerCase();
            
            // Food and beverages
            if (product.includes('bread') || product.includes('—Ö–ª—è–±')) return 'üçû';
            if (product.includes('milk') || product.includes('–º–ª—è–∫–æ')) return 'ü•õ';
            if (product.includes('cheese') || product.includes('—Å–∏—Ä–µ–Ω–µ')) return 'üßÄ';
            if (product.includes('butter') || product.includes('–º–∞—Å–ª–æ')) return 'üßà';
            if (product.includes('egg') || product.includes('—è–π—Ü–µ') || product.includes('—è–π—Ü–∞')) return 'ü•ö';
            if (product.includes('sugar') || product.includes('–∑–∞—Ö–∞—Ä')) return 'üßÇ';
            if (product.includes('biscuit') || product.includes('–±–∏—Å–∫–≤–∏—Ç–∞') || product.includes('–±–∏—Å–∫–≤–∏—Ç–∏')) return 'üç™';
            if (product.includes('cookie') || product.includes('–∫—É—Ä–∞–±–∏—è') || product.includes('–∫—É—Ä–∞–±–∏–∏')) return 'üç™';
            if (product.includes('meat') || product.includes('–º–µ—Å–æ')) return 'ü•©';
            if (product.includes('chicken') || product.includes('–ø–∏–ª–µ')) return 'üçó';
            if (product.includes('fish') || product.includes('—Ä–∏–±–∞')) return 'üêü';
            if (product.includes('apple') || product.includes('—è–±—ä–ª–∫–∞')) return 'üçé';
            if (product.includes('banana') || product.includes('–±–∞–Ω–∞–Ω')) return 'üçå';
            if (product.includes('orange') || product.includes('–ø–æ—Ä—Ç–æ–∫–∞–ª')) return 'üçä';
            if (product.includes('tomato') || product.includes('–¥–æ–º–∞—Ç')) return 'üçÖ';
            if (product.includes('potato') || product.includes('–∫–∞—Ä—Ç–æ—Ñ')) return 'ü•î';
            if (product.includes('carrot') || product.includes('–º–æ—Ä–∫–æ–≤')) return 'ü•ï';
            if (product.includes('onion') || product.includes('–ª—É–∫')) return 'üßÖ';
            if (product.includes('rice') || product.includes('–æ—Ä–∏–∑')) return 'üçö';
            if (product.includes('pasta') || product.includes('–ø–∞—Å—Ç–∞')) return 'üçù';
            if (product.includes('coffee') || product.includes('–∫–∞—Ñ–µ')) return '‚òï';
            if (product.includes('tea') || product.includes('—á–∞–π')) return 'üçµ';
            if (product.includes('beer') || product.includes('–±–∏—Ä–∞')) return 'üç∫';
            if (product.includes('wine') || product.includes('–≤–∏–Ω–æ')) return 'üç∑';
            if (product.includes('water') || product.includes('–≤–æ–¥–∞')) return 'üíß';
            if (product.includes('juice') || product.includes('—Å–æ–∫')) return 'üßÉ';
            if (product.includes('chocolate') || product.includes('—à–æ–∫–æ–ª–∞–¥')) return 'üç´';
            if (product.includes('cake') || product.includes('—Ç–æ—Ä—Ç–∞')) return 'üç∞';
            if (product.includes('ice cream') || product.includes('—Å–ª–∞–¥–æ–ª–µ–¥')) return 'üç¶';
            
            // Household items
            if (product.includes('soap') || product.includes('—Å–∞–ø—É–Ω')) return 'üßº';
            if (product.includes('shampoo') || product.includes('—à–∞–º–ø–æ–∞–Ω')) return 'üß¥';
            if (product.includes('toilet paper') || product.includes('—Ç–æ–∞–ª–µ—Ç–Ω–∞ —Ö–∞—Ä—Ç–∏—è')) return 'üßª';
            if (product.includes('toothpaste') || product.includes('–ø–∞—Å—Ç–∞ –∑–∞ –∑—ä–±–∏')) return 'ü¶∑';
            if (product.includes('detergent') || product.includes('–ø—Ä–µ–ø–∞—Ä–∞—Ç')) return 'üßΩ';
            
            // Default icons for categories
            if (product.includes('fruit') || product.includes('–ø–ª–æ–¥')) return 'üçé';
            if (product.includes('vegetable') || product.includes('–∑–µ–ª–µ–Ω—á—É–∫')) return 'ü•ï';
            if (product.includes('dairy') || product.includes('–º–ª–µ—á–µ–Ω')) return 'ü•õ';
            if (product.includes('beverage') || product.includes('–Ω–∞–ø–∏—Ç–∫–∞')) return 'ü•§';
            if (product.includes('snack') || product.includes('–∑–∞–∫—É—Å–∫–∞')) return 'üçø';
            
            return 'üì¶'; // Default product icon
        }
        
        function findFrequentItemsets(transactions, minSupport = 0.1) {
            const transactionCount = Object.keys(transactions).length;
            const minSupportCount = Math.max(1, Math.floor(transactionCount * minSupport));
            
            // Count individual items
            const itemCounts = {};
            Object.values(transactions).forEach(transaction => {
                transaction.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
            });
            
            // Find frequent 1-itemsets
            const frequent1Itemsets = Object.keys(itemCounts).filter(item => 
                itemCounts[item] >= minSupportCount
            );
            
            // Find frequent 2-itemsets
            const frequent2Itemsets = [];
            for (let i = 0; i < frequent1Itemsets.length; i++) {
                for (let j = i + 1; j < frequent1Itemsets.length; j++) {
                    const itemA = frequent1Itemsets[i];
                    const itemB = frequent1Itemsets[j];
                    
                    let count = 0;
                    Object.values(transactions).forEach(transaction => {
                        if (transaction.includes(itemA) && transaction.includes(itemB)) {
                            count++;
                        }
                    });
                    
                    if (count >= minSupportCount) {
                        frequent2Itemsets.push({
                            items: [itemA, itemB],
                            count: count,
                            support: count / transactionCount
                        });
                    }
                }
            }
            
            return {
                items: frequent1Itemsets.map(item => ({
                    items: [item],
                    support: itemCounts[item] / transactionCount,
                    count: itemCounts[item]
                })),
                pairs: frequent2Itemsets
            };
        }
        
        function generateAssociationRules(frequentItemsets, transactions) {
            const rules = [];
            const transactionCount = Object.keys(transactions).length;
            
            frequentItemsets.pairs.forEach(itemset => {
                const [itemA, itemB] = itemset.items;
                
                // Rule: A -> B
                const aCount = frequentItemsets.items.find(item => item.items[0] === itemA)?.count || 0;
                const confidence_A_to_B = aCount > 0 ? itemset.count / aCount : 0;
                
                if (confidence_A_to_B > 0.3) {
                    rules.push({
                        antecedent: [itemA],
                        consequent: [itemB],
                        support: itemset.support,
                        confidence: confidence_A_to_B,
                        lift: confidence_A_to_B / (frequentItemsets.items.find(item => item.items[0] === itemB)?.support || 1)
                    });
                }
                
                // Rule: B -> A
                const bCount = frequentItemsets.items.find(item => item.items[0] === itemB)?.count || 0;
                const confidence_B_to_A = bCount > 0 ? itemset.count / bCount : 0;
                
                if (confidence_B_to_A > 0.3) {
                    rules.push({
                        antecedent: [itemB],
                        consequent: [itemA],
                        support: itemset.support,
                        confidence: confidence_B_to_A,
                        lift: confidence_B_to_A / (frequentItemsets.items.find(item => item.items[0] === itemA)?.support || 1)
                    });
                }
            });
            
            return rules.sort((a, b) => b.confidence - a.confidence);
        }
        
        function displayMarketBasketResults(frequentItemsets, associationRules, transactions) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>üõí –ê–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞ - –†–µ–∑—É–ª—Ç–∞—Ç–∏</h3>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <div class="business-insight">
                        <h4>üîó –ù–∞–π-—Å–∏–ª–Ω–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –æ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                `;
                
                associationRules.slice(0, 5).forEach((rule, index) => {
                    const antecedentIcon = getProductIcon(rule.antecedent[0]);
                    const consequentIcon = getProductIcon(rule.consequent[0]);
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>${index + 1}. ${antecedentIcon} ${rule.antecedent[0]} ‚Üí ${consequentIcon} ${rule.consequent[0]}</strong><br>
                            <small>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç: ${(rule.confidence * 100).toFixed(1)}% | –°–∏–ª–∞ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞: ${rule.lift.toFixed(2)}</small>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="business-insight">
                        <h4>üìä –†–µ–∑—É–ª—Ç–∞—Ç –æ—Ç –∞–Ω–∞–ª–∏–∑–∞:</h4>
                        <p>–ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ –∑–Ω–∞—á–∏–º–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ —Å—ä—Å —Å–∏–ª–Ω–∞ –≤—Ä—ä–∑–∫–∞. –¢–æ–≤–∞ –º–æ–∂–µ –¥–∞ –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ —Å–µ –∫—É–ø—É–≤–∞—Ç –ø—Ä–µ–¥–∏–º–Ω–æ –ø–æ–æ—Ç–¥–µ–ª–Ω–æ –∏–ª–∏ –¥–∞–Ω–Ω–∏—Ç–µ —Å–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∏ –∑–∞ –∞–Ω–∞–ª–∏–∑.</p>
                    </div>
                `;
            }
            
            // Show top products
            if (frequentItemsets.items.length > 0) {
                html += `
                    <div class="business-insight products">
                        <h4>‚≠ê –ù–∞–π-–ø–æ–ø—É–ª—è—Ä–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                `;
                
                frequentItemsets.items
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10)
                    .forEach((item, index) => {
                        const icon = getProductIcon(item.items[0]);
                        html += `
                            <div class="product-item">
                                ${icon} ${item.items[0]} (${item.count} –ø—ä—Ç–∏)
                            </div>
                        `;
                    });
                
                html += `</div>`;
            }
            
            html += `
                    <div class="business-insight recommendation">
                        <h4>üí° –ü—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –ø–æ–¥–æ–±—Ä—è–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥–∞–∂–±–∏—Ç–µ:</h4>
                        <ul>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <li>–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –±–ª–∏–∑–æ –µ–¥–∏–Ω –¥–æ –¥—Ä—É–≥ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ, –∫–æ–∏—Ç–æ —Å–µ –∫—É–ø—É–≤–∞—Ç –∑–∞–µ–¥–Ω–æ</li>
                    <li>–°—ä–∑–¥–∞–π—Ç–µ –ø—Ä–æ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∏ –ø–∞–∫–µ—Ç–∏ –æ—Ç —á–µ—Å—Ç–æ –∫—É–ø—É–≤–∞–Ω–∏—Ç–µ –∑–∞–µ–¥–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏</li>
                    <li>–ü—Ä–∏ —Ä–µ–∫–ª–∞–º–∞ –Ω–∞ –µ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç, —Å–ø–æ–º–µ–Ω–µ—Ç–µ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—Ç–µ —Å –Ω–µ–≥–æ</li>
                `;
            } else {
                html += `
                    <li>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –∑–∞—â–æ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ —Å–µ –∫—É–ø—É–≤–∞—Ç –ø–æ–æ—Ç–¥–µ–ª–Ω–æ</li>
                    <li>–°—ä–∑–¥–∞–π—Ç–µ –ø—Ä–æ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∏ –ø–∞–∫–µ—Ç–∏ –∑–∞ —Å—Ç–∏–º—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–º–±–∏–Ω–∏—Ä–∞–Ω–∏—Ç–µ –ø–æ–∫—É–ø–∫–∏</li>
                    <li>–ü—Ä–æ—É—á–µ—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è –∑–∞ –ø–æ-–¥–æ–±—Ä–æ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–æ—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ</li>
                `;
            }
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const rulesCount = associationRules.length;
            const transactionsCount = transactions.length;
            const summaryText = `Market Basket –∞–Ω–∞–ª–∏–∑: ${rulesCount} –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ –∞—Å–æ—Ü–∏–∞—Ü–∏—è, ${transactionsCount} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('üîç Market Basket –ê–Ω–∞–ª–∏–∑', contentText, summaryText);
        }
        
        // Business Analysis function
        function generateBusinessAnalysis() {
            if (!processedData) {
                showError('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∫–∞—á–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            try {
                const analysis = performBusinessAnalysis();
                displayBusinessAnalysis(analysis);
                showSuccess('–ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω!');
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –±–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑–∞: ' + error.message);
            }
        }
        
        function performBusinessAnalysis() {
            // Find relevant columns
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('–ø—Ä–æ–¥—É–∫—Ç') ||
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('—Å—Ç–æ–∫–∞')
            );
            
            const possiblePriceColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('price') || 
                header.toLowerCase().includes('—Ü–µ–Ω–∞') ||
                header.toLowerCase().includes('amount') ||
                header.toLowerCase().includes('—Å—É–º–∞') ||
                header.toLowerCase().includes('total') ||
                header.toLowerCase().includes('–æ–±—â–æ')
            );
            
            const possibleQuantityColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('quantity') || 
                header.toLowerCase().includes('–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ') ||
                header.toLowerCase().includes('qty') ||
                header.toLowerCase().includes('–±—Ä–æ–π')
            );
            
            const productColumn = possibleProductColumns[0];
            const priceColumn = possiblePriceColumns[0];
            const quantityColumn = possibleQuantityColumns[0];
            
            // Filter valid data (remove product codes)
            const validData = processedData.data.filter(row => {
                const product = row[productColumn];
                return product && !(/\d/.test(product));
            });
            
            // Product analysis
            const productStats = {};
            let totalRevenue = 0;
            let totalTransactions = validData.length;
            
            validData.forEach(row => {
                const product = row[productColumn];
                const price = parseFloat(row[priceColumn]) || 0;
                const quantity = parseFloat(row[quantityColumn]) || 1;
                const revenue = price * quantity;
                
                if (!productStats[product]) {
                    productStats[product] = {
                        count: 0,
                        totalRevenue: 0,
                        totalQuantity: 0,
                        avgPrice: 0
                    };
                }
                
                productStats[product].count++;
                productStats[product].totalRevenue += revenue;
                productStats[product].totalQuantity += quantity;
                totalRevenue += revenue;
            });
            
            // Calculate averages and sort products
            Object.keys(productStats).forEach(product => {
                const stats = productStats[product];
                stats.avgPrice = stats.totalRevenue / stats.totalQuantity;
                stats.marketShare = (stats.totalRevenue / totalRevenue) * 100;
            });
            
            const topProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => b.totalRevenue - a.totalRevenue)
                .slice(0, 10);
            
            const worstProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => a.count - b.count)
                .slice(0, 5);
            
            return {
                totalRevenue,
                totalTransactions,
                avgTransactionValue: totalRevenue / totalTransactions,
                topProducts,
                worstProducts,
                productCount: Object.keys(productStats).length
            };
        }
        
        function displayBusinessAnalysis(analysis) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>üíº –ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h3>
                    
                    <div class="business-insight revenue">
                        <h4>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤ –ø—Ä–µ–≥–ª–µ–¥:</h4>
                        <ul>
                            <li><strong>–û–±—â –æ–±–æ—Ä–æ—Ç:</strong> ${analysis.totalRevenue.toFixed(2)} –ª–≤.</li>
                            <li><strong>–û–±—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong> ${analysis.totalTransactions} –±—Ä.</li>
                            <li><strong>–°—Ä–µ–¥–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:</strong> ${analysis.avgTransactionValue.toFixed(2)} –ª–≤.</li>
                            <li><strong>–ë—Ä–æ–π —Ä–∞–∑–ª–∏—á–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</strong> ${analysis.productCount} –±—Ä.</li>
                        </ul>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>‚≠ê –ù–∞–π-–ø–µ—á–µ–ª–∏–≤—à–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                        <div class="product-list">
            `;
            
            analysis.topProducts.forEach(([product, stats], index) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        <strong>${index + 1}. ${icon} ${product}</strong><br>
                        <small>–û–±–æ—Ä–æ—Ç: ${stats.totalRevenue.toFixed(2)} –ª–≤. | –ü—Ä–æ–¥–∞–∂–±–∏: ${stats.count} –±—Ä. | –î—è–ª: ${stats.marketShare.toFixed(1)}%</small>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>‚ö†Ô∏è –°–ª–∞–±–æ –ø—Ä–æ–¥–∞–≤–∞–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</h4>
                        <div class="product-list">
            `;
            
            analysis.worstProducts.forEach(([product, stats]) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        ${icon} ${product} - —Å–∞–º–æ ${stats.count} –±—Ä. –ø—Ä–æ–¥–∞–∂–±–∏
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight recommendation">
                        <h4>üéØ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ:</h4>
                        <ul>
                            <li><strong>–§–æ–∫—É—Å –≤—ä—Ä—Ö—É —Ç–æ–ø –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ:</strong> –£–≤–µ–ª–∏—á–µ—Ç–µ —Ä–µ–∫–ª–∞–º–∞—Ç–∞ –∏ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ ${analysis.topProducts.slice(0, 3).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>–ü—Ä–µ–æ—Å–º–∏—Å–ª–µ—Ç–µ —Å–ª–∞–±–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏:</strong> –ù–∞–º–∞–ª–µ—Ç–µ –∏–ª–∏ –ø—Ä–µ–º–∞—Ö–Ω–µ—Ç–µ –æ—Ç –∞—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ ${analysis.worstProducts.slice(0, 2).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>–ê–Ω–∞–ª–∏–∑ –Ω–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑—É–≤–∞–Ω–µ—Ç–æ:</strong> –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ü–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–ø –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ - –º–æ–∂–µ –¥–∞ –∏–º–∞—Ç–µ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç –∑–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ</li>
                            <li><strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∑–∞–ø–∞—Å–∏—Ç–µ:</strong> –û—Å–∏–≥—É—Ä–µ—Ç–µ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç –ø–µ—á–µ–ª–∏–≤—à–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏</li>
                            <li><strong>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> –ù–∞—Å–æ—á–µ—Ç–µ —Ä–µ–∫–ª–∞–º–Ω–∏—è –±—é–¥–∂–µ—Ç –∫—ä–º –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ —Å –Ω–∞–π-–≤–∏—Å–æ–∫ –æ–±–æ—Ä–æ—Ç</li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const summaryText = `–ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑: –û–±–æ—Ä–æ—Ç ${analysis.totalRevenue.toFixed(2)} –ª–≤., ${analysis.totalTransactions} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, ${analysis.productCount} –ø—Ä–æ–¥—É–∫—Ç–∞`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('üíº –ë–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏–∑', contentText, summaryText);
        }
        
        // Export functions - FIXED VERSION
        function exportToPDF() {
            try {
                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    showError('PDF –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞. –ú–æ–ª—è, –ø—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.');
                    return;
                }
                
                showLoading('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF –æ—Ç—á–µ—Ç...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Safe text function with validation
                const safeText = (text, x, y) => {
                    try {
                        if (text && typeof text === 'string' && x && y) {
                            // Clean text from problematic characters
                            const cleanText = text.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                            doc.text(cleanText, x, y);
                            return true;
                        }
                    } catch (e) {
                        console.warn('Failed to add text:', text, e);
                        return false;
                    }
                    return false;
                };
                
                // Add title
                doc.setFontSize(16);
                safeText('Business Intelligence –û—Ç—á–µ—Ç', 20, 20);
                
                // Add date
                doc.setFontSize(10);
                const dateStr = new Date().toLocaleDateString('bg-BG');
                safeText(`–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω –Ω–∞: ${dateStr}`, 20, 30);
                
                let yPos = 50;
                
                if (processedData && processedData.data && processedData.headers) {
                    // Add data summary
                    doc.setFontSize(12);
                    safeText('–û–±–æ–±—â–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ:', 20, yPos);
                    yPos += 15;
                    
                    doc.setFontSize(10);
                    safeText(`–û–±—â–æ –∑–∞–ø–∏—Å–∏: ${processedData.data.length} –±—Ä.`, 20, yPos);
                    yPos += 10;
                    
                    // Safe headers join
                    const headersStr = processedData.headers.slice(0, 5).join(', ');
                    safeText(`–ö–æ–ª–æ–Ω–∏: ${headersStr}`, 20, yPos);
                    yPos += 15;
                    
                    // Add sample data - with better error handling
                    safeText('–ü—Ä–∏–º–µ—Ä–Ω–∏ –¥–∞–Ω–Ω–∏ (–ø—ä—Ä–≤–∏—Ç–µ 5 –∑–∞–ø–∏—Å–∞):', 20, yPos);
                    yPos += 10;
                    
                    processedData.data.slice(0, 5).forEach((row, index) => {
                        try {
                            if (row && typeof row === 'object') {
                                const values = Object.values(row).slice(0, 3);
                                const cleanValues = values.map(v => v ? String(v).substring(0, 50) : '').filter(v => v);
                                const rowText = `${index + 1}. ${cleanValues.join(' | ')}`;
                                if (safeText(rowText, 20, yPos)) {
                                    yPos += 8;
                                }
                            }
                        } catch (rowError) {
                            console.warn('Error processing row:', index, rowError);
                        }
                    });
                }
                
                // Add analysis results if available
                const analysisResults = document.getElementById('analysisResults');
                if (analysisResults && analysisResults.innerHTML.trim()) {
                    doc.addPage();
                    doc.setFontSize(12);
                    safeText('–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ç–µ:', 20, 20);
                    doc.setFontSize(10);
                    safeText('–ú–æ–ª—è, –≤–∏–∂—Ç–µ –¥–µ—Ç–∞–π–ª–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ.', 20, 35);
                    
                    // Try to extract and add some analysis text
                    try {
                        const textContent = analysisResults.textContent || '';
                        const lines = textContent.split('\n').filter(line => line.trim()).slice(0, 20);
                        let analysisY = 50;
                        
                        lines.forEach(line => {
                            if (analysisY < 280) { // Don't exceed page height
                                if (safeText(line.trim().substring(0, 80), 20, analysisY)) {
                                    analysisY += 8;
                                }
                            }
                        });
                    } catch (analysisError) {
                        console.warn('Error adding analysis content:', analysisError);
                    }
                }
                
                // Generate and download
                const filename = `BI_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                const pdfBlob = doc.output('blob');
                
                if (pdfBlob && pdfBlob.size > 0) {
                    const url = window.URL.createObjectURL(pdfBlob);
                    console.log('PDF generated successfully:', filename, 'Size:', pdfBlob.size, 'bytes');
                    
                    // Use simple direct download instead of complex system
                    downloadFile(url, filename);
                } else {
                    throw new Error('PDF –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ—Ç–æ –Ω–µ—É—Å–ø–µ—à–Ω–æ - —Ñ–∞–π–ª—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω');
                }
                
            } catch (error) {
                hideLoading();
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF: ' + error.message);
                console.error('PDF Export Error:', error);
            }
        }
        
        // Simplified download function
        function downloadFile(url, filename) {
            try {
                hideLoading();
                
                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                showMessage(`–§–∞–π–ª—ä—Ç "${filename}" –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìÅ`, 'success');
                
                // Cleanup URL after delay
                setTimeout(() => {
                    try {
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        console.warn('URL cleanup error:', e);
                    }
                }, 1000);
                
                console.log('Download completed:', filename);
                
            } catch (error) {
                hideLoading();
                console.error('Download error:', error);
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç–µ–≥–ª—è–Ω–µ: ' + error.message);
            }
        }
        
        function exportToExcel() {
            try {
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined') {
                    showError('Excel –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞. –ú–æ–ª—è, –ø—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.');
                    return;
                }
                
                if (!processedData) {
                    showError('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç.');
                    return;
                }
                
                showLoading('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª...');
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add main data sheet
                const ws = XLSX.utils.json_to_sheet(processedData.data);
                XLSX.utils.book_append_sheet(wb, ws, '–î–∞–Ω–Ω–∏');
                
                // Add summary sheet
                const summaryData = [
                    ['–û–±–æ–±—â–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ'],
                    ['–û–±—â–æ –∑–∞–ø–∏—Å–∏ (–±—Ä–æ–π)', processedData.data.length],
                    ['–ë—Ä–æ–π –∫–æ–ª–æ–Ω–∏ (–±—Ä–æ–π)', processedData.headers.length],
                    ['–î–∞—Ç–∞ –Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç', new Date().toLocaleDateString('bg-BG')]
                ];
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, '–û–±–æ–±—â–µ–Ω–∏–µ');
                
                // Generate file
                const filename = `BI_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                const excelBlob = new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const url = window.URL.createObjectURL(excelBlob);
                console.log('Excel generated successfully:', filename, 'Size:', excelBlob.size, 'bytes');
                downloadFile(url, filename);
                
            } catch (error) {
                showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel: ' + error.message);
                console.error('Excel Export Error:', error);
            }
        }
        
        // Enhanced download system - SIMPLIFIED
        function triggerEnhancedDownload(url, filename, fileType) {
            try {
                // Hide loading
                hideLoading();
                
                console.log(`Attempting download: ${filename}, URL: ${url.substring(0, 50)}...`);
                
                // Method 1: Direct download link with multiple attempts
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                link.target = '_blank';
                
                // Add to DOM
                document.body.appendChild(link);
                
                // Try clicking with user interaction simulation
                setTimeout(() => {
                    try {
                        link.click();
                        console.log('Download triggered successfully');
                        showSimpleDownloadNotification(filename, fileType);
                    } catch (clickError) {
                        console.error('Click error:', clickError);
                        // Fallback: Try opening in new window
                        tryFallbackDownload(url, filename, fileType);
                    }
                }, 10);
                
                // Cleanup after delay
                setTimeout(() => {
                    try {
                        if (document.body.contains(link)) {
                            document.body.removeChild(link);
                        }
                        window.URL.revokeObjectURL(url);
                    } catch (cleanupError) {
                        console.error('Cleanup error:', cleanupError);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Download error:', error);
                tryFallbackDownload(url, filename, fileType);
            }
        }
        
        function tryFallbackDownload(url, filename, fileType) {
            try {
                // Fallback method: Open in new window with instructions
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    // Show notification with instructions
                    showDownloadInstructionsNotification(filename, fileType);
                } else {
                    // Pop-up blocked, show manual download
                    showManualDownloadNotification(url, filename, fileType);
                }
            } catch (fallbackError) {
                console.error('Fallback error:', fallbackError);
                showError('–ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞–ø–æ—á–Ω–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞ –∑–∞ pop-up –±–ª–æ–∫–∏—Ä–∞–Ω–µ.');
            }
        }
        
        // Simple download notification
        function showSimpleDownloadNotification(filename, fileType) {
            const notification = document.createElement('div');
            notification.className = 'download-notification success';
            notification.innerHTML = `
                <div class="notification-header">
                    <span>‚úÖ</span>
                    <span>${fileType} –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω!</span>
                </div>
                <div class="notification-body">
                    <strong>${filename}</strong><br>
                    <small>–§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –∏–∑—Ç–µ–≥–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.<br>
                    –ê–∫–æ –Ω–µ —Å–µ —Å–ª—É—á–∏, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –ø–∞–ø–∫–∞—Ç–∞ "Downloads" –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è—Ç–∞ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.</small>
                </div>
                <div class="notification-actions">
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-btn">
                        ‚úï –ó–∞—Ç–≤–æ—Ä–∏
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function showDownloadInstructionsNotification(filename, fileType) {
            const notification = document.createElement('div');
            notification.className = 'download-notification info';
            notification.innerHTML = `
                <div class="notification-header">
                    üì• ${fileType} –∏–∑—Ç–µ–≥–ª—è–Ω–µ –∑–∞–ø–æ—á–Ω–∞
                </div>
                <div class="notification-body">
                    <strong>${filename}</strong><br>
                    <small>–§–∞–π–ª—ä—Ç —Å–µ –æ—Ç–≤–∞—Ä—è –≤ –Ω–æ–≤ –ø—Ä–æ–∑–æ—Ä–µ—Ü.<br>
                    –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ Ctrl+S –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –∏–ª–∏ –¥–µ—Å–µ–Ω –∫–ª–∏–∫ ‚Üí "–ó–∞–ø–∞–∑–∏ –∫–∞—Ç–æ..."</small>
                </div>
                <div class="notification-actions">
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-btn">
                        ‚úì –†–∞–∑–±—Ä–∞—Ö
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.remove();
                }
            }, 10000);
        }
        
        function showManualDownloadNotification(url, filename, fileType) {
            const notification = document.createElement('div');
            notification.className = 'download-notification error';
            notification.innerHTML = `
                <div class="notification-header">
                    ‚ö†Ô∏è –ù—É–∂–Ω–∞ –µ —Ä—ä—á–Ω–∞ –ø–æ–º–æ—â
                </div>
                <div class="notification-body">
                    <strong>${filename}</strong><br>
                    <small>–ë—Ä–∞—É–∑—ä—Ä—ä—Ç –±–ª–æ–∫–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—Ç–æ –∏–∑—Ç–µ–≥–ª—è–Ω–µ.<br>
                    –ö–ª–∏–∫–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞ –∑–∞ —Ä—ä—á–Ω–æ –∏–∑—Ç–µ–≥–ª—è–Ω–µ:</small>
                </div>
                <div class="notification-actions">
                    <a href="${url}" download="${filename}" class="notification-btn" style="background: #28a745; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; margin: 5px;">
                        üì• –ò–∑—Ç–µ–≥–ª–∏ —Ñ–∞–π–ª–∞
                    </a>
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-btn">
                        ‚úï –ó–∞—Ç–≤–æ—Ä–∏
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-close after 15 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.remove();
                }
            }, 15000);
        }
    </script>
</body>
</html>
