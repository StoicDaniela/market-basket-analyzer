<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence Анализатор - Свежа Версия</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #e3f2fd;
        }
        
        .upload-section input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .control-group h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container canvas {
            max-height: 400px;
        }
        
        .analysis-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }
        
        .business-insight {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        
        .business-insight.revenue {
            border-left-color: #28a745;
        }
        
        .business-insight.products {
            border-left-color: #ffc107;
        }
        
        .business-insight.recommendation {
            border-left-color: #dc3545;
        }
        
        .product-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .product-list {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading.show {
            display: block;
        }
        
        .export-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .export-section h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .data-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-preview th,
        .data-preview td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-preview th {
            background: #f5f5f5;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .download-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            min-width: 400px;
            text-align: center;
        }
        
        .download-notification.error {
            border-color: #dc3545;
        }
        
        .download-notification.info {
            border-color: #17a2b8;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .notification-body {
            margin-bottom: 20px;
            color: #666;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .notification-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .notification-btn:not(.secondary) {
            background: #28a745;
            color: white;
        }
        
        .notification-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .notification-btn.disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .analysis-controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .download-notification {
                min-width: 90%;
                margin: 0 5%;
            }
        }
        
        /* History section styles */
        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-item-date {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }
        
        .history-item-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .history-item-content {
            color: #333;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Business Intelligence Анализатор</h1>
            <p>Анализирайте вашите данни и получете ценни бизнес решения</p>
        </div>
        
        <div class="upload-section">
            <h2>📁 Качете вашия файл с данни</h2>
            <p>Поддържаме CSV и Excel файлове</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
            <br>
            <button class="btn" onclick="loadFile()">🚀 Зареди данните</button>
        </div>
        
        <div class="data-preview" id="dataPreview" style="display: none;">
            <h3>👀 Преглед на данните</h3>
            <div id="previewContent"></div>
        </div>
        
        <div class="analysis-controls">
            <div class="control-group">
                <h3>📈 Генериране на диаграми</h3>
                <p>Създайте визуализации на вашите данни</p>
                <button class="btn" onclick="generateCharts()">📊 Генерирай диаграми</button>
            </div>
            
            <div class="control-group">
                <h3>🛒 Анализ на пазарната кошница</h3>
                <p>Открийте връзки между продуктите</p>
                <button class="btn" onclick="performMarketBasketAnalysis()">🔍 Анализирай връзките</button>
            </div>
            
            <div class="control-group">
                <h3>💼 Бизнес анализ</h3>
                <p>Получете бизнес препоръки и анализи</p>
                <button class="btn" onclick="generateBusinessAnalysis()">💡 Генерирай анализ</button>
            </div>
        </div>
        
        <div class="export-section">
            <h3>📤 Експорт на резултатите</h3>
            <p>Изтеглете анализите в удобен формат</p>
            <button class="btn" onclick="exportToPDF()"> Експорт PDF </button> 
            
            
            <button class="btn" onclick="exportToExcel()">📊 Експорт Excel</button>
            <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 0.9em;">
                <strong>💡 Съвети за изтегляне:</strong>
                <ul style="margin: 5px 0 0 20px; text-align: left;">
                    <li>Ако файлът не се изтегли автоматично, проверете браузъра за блокирани pop-up прозорци</li>
                    <li>Файловете се запазват в папката "Downloads" на компютъра</li>

  }

        function printToPDF() {
            console.log('🖨️ Starting print to PDF...');
            
            if (!processedData || !currentAnalysisResult) {
                showNotification('Няма данни за експорт. Моля, първо направете анализ.', 'error');
                return;
            }
            
            showNotification('Отваряне на диалог за принтиране...', 'success');
            
            // Hide export buttons temporarily
            const exportButtons = document.getElementById('exportButtons');
            exportButtons.style.display = 'none';
            
            setTimeout(() => {
                window.print();
                exportButtons.style.display = 'block';
            }, 500);
        }

        function exportToExcel() {
            console.log('📊 Starting Excel export...');
            
            if (!processedData || !currentAnalysisResult) {
                showNotification('Няма данни за експорт. Моля, първо направете анализ.', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                showNotification('Excel библиотеката не е заредена. Опреснете страницата.', 'error');
                return;
            }
            
            try {
                showNotification('Генериране на Excel файл...', 'success');
                
                const wb = XLSX.utils.book_new();
                
                // Summary sheet
                const summaryData = [
                    ['Market Basket Analysis Report'],
                    ['Файл:', processedData.fileName],
                    ['Дата:', new Date().toLocaleString('bg-BG')],
                    [''],
                    ['Общо транзакции:', currentAnalysisResult.totalTransactions],
                    ['Уникални продукти:', currentAnalysisResult.uniqueItems],
                    ['Средна кошница:', currentAnalysisResult.averageBasketSize.toFixed(2)],
                ];
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, 'Обобщение');
                
                // Top items sheet
                const topItemsData = [
                    ['Продукт', 'Покупки', 'Процент'],
                    ...currentAnalysisResult.topItems.map(([item, freq]) => [
                        item, 
                        freq, 
                        ((freq / currentAnalysisResult.totalTransactions) * 100).toFixed(1) + '%'
                    ])
                ];
                
                const topItemsSheet = XLSX.utils.aoa_to_sheet(topItemsData);
                XLSX.utils.book_append_sheet(wb, topItemsSheet, 'Топ продукти');
                
                // Rules sheet
                const rulesData = [
                    ['Ако купи', 'Ще купи и', 'Support %', 'Confidence %', 'Lift'],
                    ...currentAnalysisResult.rules.map(rule => [
                        rule.antecedent,
                        rule.consequent,
                        (rule.support * 100).toFixed(2),
                        (rule.confidence * 100).toFixed(2),
                        rule.lift.toFixed(3)
                    ])
                ];
                
                const rulesSheet = XLSX.utils.aoa_to_sheet(rulesData);
                XLSX.utils.book_append_sheet(wb, rulesSheet, 'Асоциативни правила');
                
                const fileName = `Market_Basket_Analysis_${processedData.fileName.replace(/\.[^/.]+$/, "")}_${new Date().getTime()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                console.log('✅ Excel export completed');
                showNotification('Excel файлът е изтеглен успешно! 📊', 'success');
                
            } catch (error) {
                console.error('❌ Excel Export Error:', error);
                showNotification('Грешка при генериране на Excel: ' + error.message, 'error');
            }
        }

                    
                    
                </ul>
            </div>
        </div>
        
        <div class="history-section" style="margin-top: 30px;">
            <h3>📚 История на анализите</h3>
            <p>Преглед на предишни анализи и резултати</p>
            <button class="btn" onclick="showAnalysisHistory()">📖 Покажи история</button>
            <button class="btn secondary" onclick="clearAnalysisHistory()" style="margin-left: 10px;">🗑️ Изчисти история</button>
            <div id="historyContainer" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <h3>⏳ Обработка на данните...</h3>
            <p>Моля, изчакайте...</p>
        </div>
        
        <div class="loading" id="exportLoading">
            <h3>📦 Генериране на файл...</h3>
            <p>Файлът се подготвя за изтегляне...</p>
        </div>
        
        <div class="results-section">
            <div id="chartContainer"></div>
            <div id="analysisResults"></div>
        </div>
    </div>
    
    <script>
        let processedData = null;
        let currentCharts = [];
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
        
        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        function showInfo(message) {
            showNotification(message, 'info');
        }
        
        function showLoading(message) {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.innerHTML = `<h3>⏳ ${message}</h3><p>Моля, изчакайте...</p>`;
                loading.style.display = 'block';
            }
        }
        
        function hideLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) loading.style.display = 'none';
        }
        
        // Analysis History Functions
        function saveToHistory(type, content, summary) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toLocaleString('bg-BG'),
                type: type,
                content: content,
                summary: summary || 'Анализ без описание'
            };
            
            analysisHistory.unshift(historyItem); // Add to beginning
            
            // Keep only last 20 items
            if (analysisHistory.length > 20) {
                analysisHistory = analysisHistory.slice(0, 20);
            }
            
            // Save to localStorage
            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            console.log('Analysis saved to history:', type, summary);
        }
        
        function showAnalysisHistory() {
            const container = document.getElementById('historyContainer');
            
            if (analysisHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>📭 Няма запазени анализи</p>
                        <p style="font-size: 0.9em;">Направете първия си анализ, за да се появи тук!</p>
                    </div>
                `;
            } else {
                let historyHtml = '<h4>📚 Запазени анализи (' + analysisHistory.length + ' бр.)</h4>';
                
                analysisHistory.forEach(item => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-date">${item.date}</span>
                                <span class="history-item-type">${item.type}</span>
                            </div>
                            <div class="history-item-content">
                                <strong>${item.summary}</strong><br>
                                ${item.content.substring(0, 300)}${item.content.length > 300 ? '...' : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = historyHtml;
            }
            
            // Toggle visibility
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function clearAnalysisHistory() {
            if (confirm('Сигурни ли сте, че искате да изтриете цялата история на анализите?')) {
                analysisHistory = [];
                localStorage.removeItem('analysisHistory');
                
                const container = document.getElementById('historyContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>✅ Историята е изчистена</p>
                    </div>
                `;
                
                showSuccess('Историята на анализите е изчистена успешно!');
                
                // Hide container after 2 seconds
                setTimeout(() => {
                    container.style.display = 'none';
                }, 2000);
            }
        }
        
        // File loading functions
        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Моля, изберете файл първо.');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('show');
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = function(e) {
                    try {
                        processedData = parseCSV(e.target.result);
                        displayDataPreview();
                        showSuccess('CSV файлът е зареден успешно!');
                    } catch (error) {
                        showError('Грешка при четене на CSV файла: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        processedData = parseArrayData(jsonData);
                        displayDataPreview();
                        showSuccess('Excel файлът е зареден успешно!');
                    } catch (error) {
                        showError('Грешка при четене на Excel файла: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                showError('Неподдържан файлов формат. Използвайте CSV или Excel файлове.');
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return { headers, data };
        }
        
        function parseArrayData(arrayData) {
            if (arrayData.length === 0) {
                throw new Error('Файлът е празен');
            }
            
            const headers = arrayData[0].map(h => String(h || '').trim());
            const data = [];
            
            for (let i = 1; i < arrayData.length; i++) {
                if (arrayData[i] && arrayData[i].some(cell => cell !== null && cell !== undefined && cell !== '')) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = String(arrayData[i][index] || '').trim();
                    });
                    data.push(row);
                }
            }
            
            return { headers, data };
        }
        
        function displayDataPreview() {
            const previewDiv = document.getElementById('dataPreview');
            const contentDiv = document.getElementById('previewContent');
            
            if (!processedData || processedData.data.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            ${processedData.headers.map(header => `<th>${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const previewRows = Math.min(5, processedData.data.length);
            for (let i = 0; i < previewRows; i++) {
                html += '<tr>';
                processedData.headers.forEach(header => {
                    html += `<td>${processedData.data[i][header] || ''}</td>`;
                });
                html += '</tr>';
            }
            
            html += `
                    </tbody>
                </table>
                <p><small>Показани са първите ${previewRows} от общо ${processedData.data.length} записа</small></p>
            `;
            
            contentDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        }
        
        // Chart generation functions
        function generateCharts() {
            if (!processedData) {
                showError('Моля, първо качете файл с данни.');
                return;
            }
            
            try {
                clearExistingCharts();
                createCharts();
                showSuccess('Диаграмите са генерирани успешно!');
            } catch (error) {
                showError('Грешка при генериране на диаграми: ' + error.message);
                console.error('Chart generation error:', error);
            }
        }
        
        function clearExistingCharts() {
            currentCharts.forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            currentCharts = [];
            
            const container = document.getElementById('chartContainer');
            container.innerHTML = '';
        }
        
        function createCharts() {
            const container = document.getElementById('chartContainer');
            
            // Find suitable columns for charting
            const numericColumns = findNumericColumns();
            const textColumns = findTextColumns();
            
            if (numericColumns.length === 0) {
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>⚠️ Няма числови данни за диаграми</h3>
                        <p>Файлът не съдържа числови колони подходящи за визуализация.</p>
                    </div>
                `;
                return;
            }
            
            // Create bar chart for first numeric column
            if (numericColumns.length > 0 && textColumns.length > 0) {
                createBarChart(textColumns[0], numericColumns[0]);
            }
            
            // Create pie chart if we have categorical data
            if (textColumns.length > 0) {
                createPieChart(textColumns[0]);
            }
            
            // Create line chart for trends
            if (numericColumns.length >= 2) {
                createLineChart(numericColumns[0], numericColumns[1]);
            }
            
            // Save charts to history
            const chartsCreated = [];
            if (numericColumns.length > 0 && textColumns.length > 0) chartsCreated.push('Bar Chart');
            if (textColumns.length > 0) chartsCreated.push('Pie Chart');
            if (numericColumns.length >= 2) chartsCreated.push('Line Chart');
            
            if (chartsCreated.length > 0) {
                const summaryText = `Визуализация: ${chartsCreated.join(', ')} от ${processedData.data.length} записа`;
                const contentText = `Създадени диаграми: ${chartsCreated.join(', ')}\nДанни: ${processedData.data.length} записа\nКолони: ${processedData.headers.join(', ')}`;
                saveToHistory('📊 Визуализация', contentText, summaryText);
            }
        }
        
        function findNumericColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && !isNaN(parseFloat(value)) && isFinite(value);
                });
            });
        }
        
        function findTextColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && isNaN(parseFloat(value));
                });
            });
        }
        
        function createBarChart(labelColumn, valueColumn) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3>📊 ${labelColumn} vs ${valueColumn} (брой)</h3>
                <canvas id="barChart"></canvas>
            `;
            document.getElementById('chartContainer').appendChild(chartContainer);
            
            const ctx = document.getElementById('barChart').getContext('2d');
            
            // Aggregate data
            const dataMap = {};
            processedData.data.forEach(row => {
                const label = row[labelColumn] || 'Неизвестно';
                const value = parseFloat(row[valueColumn]) || 0;
                
                if (dataMap[label]) {
                    dataMap[label] += value;
                } else {
                    dataMap[label] = value;
                }
            });
            
            const labels = Object.keys(dataMap).slice(0, 10); // Top 10
            const values = labels.map(label => dataMap[label]);
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: valueColumn,
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                            '#4BC0C0', '#FF6384'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `${valueColumn} (брой)`
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: labelColumn
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createPieChart(column) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3>🥧 Разпределение по ${column} (брой продажби)</h3>
                <canvas id="pieChart"></canvas>
            `;
            document.getElementById('chartContainer').appendChild(chartContainer);
            
            const ctx = document.getElementById('pieChart').getContext('2d');
            
            // Count occurrences
            const counts = {};
            processedData.data.forEach(row => {
                const value = row[column] || 'Неизвестно';
                counts[value] = (counts[value] || 0) + 1;
            });
            
            const labels = Object.keys(counts).slice(0, 8); // Top 8
            const values = labels.map(label => counts[label]);
            
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createLineChart(xColumn, yColumn) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3>📈 Тренд: ${xColumn} / ${yColumn}</h3>
                <canvas id="lineChart"></canvas>
            `;
            document.getElementById('chartContainer').appendChild(chartContainer);
            
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            const data = processedData.data
                .filter(row => row[xColumn] && row[yColumn])
                .map(row => ({
                    x: parseFloat(row[xColumn]) || 0,
                    y: parseFloat(row[yColumn]) || 0
                }))
                .sort((a, b) => a.x - b.x);
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${yColumn} по ${xColumn}`,
                        data: data,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: `${xColumn} (стойност)`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `${yColumn} (стойност)`
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        // Market Basket Analysis functions
        function performMarketBasketAnalysis() {
            if (!processedData) {
                showError('Моля, първо качете файл с данни.');
                return;
            }
            
            try {
                const transactions = extractTransactions();
                const frequentItemsets = findFrequentItemsets(transactions);
                const associationRules = generateAssociationRules(frequentItemsets, transactions);
                
                displayMarketBasketResults(frequentItemsets, associationRules, transactions);
                showSuccess('Анализът на пазарната кошница е завършен!');
            } catch (error) {
                showError('Грешка при анализ на пазарната кошница: ' + error.message);
                console.error('Market basket analysis error:', error);
            }
        }
        
        function extractTransactions() {
            // Find transaction and product columns
            const possibleTransactionColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('transaction') || 
                header.toLowerCase().includes('order') ||
                header.toLowerCase().includes('id') ||
                header.toLowerCase().includes('номер')
            );
            
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('продукт') ||
                header.toLowerCase().includes('стока')
            );
            
            const transactionColumn = possibleTransactionColumns[0] || processedData.headers[0];
            const productColumn = possibleProductColumns[0] || processedData.headers[1];
            
            const transactions = {};
            
            processedData.data.forEach(row => {
                const transactionId = row[transactionColumn];
                const product = row[productColumn];
                
                if (transactionId && product) {
                    if (!transactions[transactionId]) {
                        transactions[transactionId] = [];
                    }
                    if (!transactions[transactionId].includes(product)) {
                        transactions[transactionId].push(product);
                    }
                }
            });
            
            return transactions;
        }
        
        function getProductIcon(productName) {
            const product = productName.toLowerCase();
            
            // Food and beverages
            if (product.includes('bread') || product.includes('хляб')) return '🍞';
            if (product.includes('milk') || product.includes('мляко')) return '🥛';
            if (product.includes('cheese') || product.includes('сирене')) return '🧀';
            if (product.includes('butter') || product.includes('масло')) return '🧈';
            if (product.includes('egg') || product.includes('яйце') || product.includes('яйца')) return '🥚';
            if (product.includes('sugar') || product.includes('захар')) return '🧂';
            if (product.includes('biscuit') || product.includes('бисквита') || product.includes('бисквити')) return '🍪';
            if (product.includes('cookie') || product.includes('курабия') || product.includes('курабии')) return '🍪';
            if (product.includes('meat') || product.includes('месо')) return '🥩';
            if (product.includes('chicken') || product.includes('пиле')) return '🍗';
            if (product.includes('fish') || product.includes('риба')) return '🐟';
            if (product.includes('apple') || product.includes('ябълка')) return '🍎';
            if (product.includes('banana') || product.includes('банан')) return '🍌';
            if (product.includes('orange') || product.includes('портокал')) return '🍊';
            if (product.includes('tomato') || product.includes('домат')) return '🍅';
            if (product.includes('potato') || product.includes('картоф')) return '🥔';
            if (product.includes('carrot') || product.includes('морков')) return '🥕';
            if (product.includes('onion') || product.includes('лук')) return '🧅';
            if (product.includes('rice') || product.includes('ориз')) return '🍚';
            if (product.includes('pasta') || product.includes('паста')) return '🍝';
            if (product.includes('coffee') || product.includes('кафе')) return '☕';
            if (product.includes('tea') || product.includes('чай')) return '🍵';
            if (product.includes('beer') || product.includes('бира')) return '🍺';
            if (product.includes('wine') || product.includes('вино')) return '🍷';
            if (product.includes('water') || product.includes('вода')) return '💧';
            if (product.includes('juice') || product.includes('сок')) return '🧃';
            if (product.includes('chocolate') || product.includes('шоколад')) return '🍫';
            if (product.includes('cake') || product.includes('торта')) return '🍰';
            if (product.includes('ice cream') || product.includes('сладолед')) return '🍦';
            
            // Household items
            if (product.includes('soap') || product.includes('сапун')) return '🧼';
            if (product.includes('shampoo') || product.includes('шампоан')) return '🧴';
            if (product.includes('toilet paper') || product.includes('тоалетна хартия')) return '🧻';
            if (product.includes('toothpaste') || product.includes('паста за зъби')) return '🦷';
            if (product.includes('detergent') || product.includes('препарат')) return '🧽';
            
            // Default icons for categories
            if (product.includes('fruit') || product.includes('плод')) return '🍎';
            if (product.includes('vegetable') || product.includes('зеленчук')) return '🥕';
            if (product.includes('dairy') || product.includes('млечен')) return '🥛';
            if (product.includes('beverage') || product.includes('напитка')) return '🥤';
            if (product.includes('snack') || product.includes('закуска')) return '🍿';
            
            return '📦'; // Default product icon
        }
        
        function findFrequentItemsets(transactions, minSupport = 0.1) {
            const transactionCount = Object.keys(transactions).length;
            const minSupportCount = Math.max(1, Math.floor(transactionCount * minSupport));
            
            // Count individual items
            const itemCounts = {};
            Object.values(transactions).forEach(transaction => {
                transaction.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
            });
            
            // Find frequent 1-itemsets
            const frequent1Itemsets = Object.keys(itemCounts).filter(item => 
                itemCounts[item] >= minSupportCount
            );
            
            // Find frequent 2-itemsets
            const frequent2Itemsets = [];
            for (let i = 0; i < frequent1Itemsets.length; i++) {
                for (let j = i + 1; j < frequent1Itemsets.length; j++) {
                    const itemA = frequent1Itemsets[i];
                    const itemB = frequent1Itemsets[j];
                    
                    let count = 0;
                    Object.values(transactions).forEach(transaction => {
                        if (transaction.includes(itemA) && transaction.includes(itemB)) {
                            count++;
                        }
                    });
                    
                    if (count >= minSupportCount) {
                        frequent2Itemsets.push({
                            items: [itemA, itemB],
                            count: count,
                            support: count / transactionCount
                        });
                    }
                }
            }
            
            return {
                items: frequent1Itemsets.map(item => ({
                    items: [item],
                    support: itemCounts[item] / transactionCount,
                    count: itemCounts[item]
                })),
                pairs: frequent2Itemsets
            };
        }
        
        function generateAssociationRules(frequentItemsets, transactions) {
            const rules = [];
            const transactionCount = Object.keys(transactions).length;
            
            frequentItemsets.pairs.forEach(itemset => {
                const [itemA, itemB] = itemset.items;
                
                // Rule: A -> B
                const aCount = frequentItemsets.items.find(item => item.items[0] === itemA)?.count || 0;
                const confidence_A_to_B = aCount > 0 ? itemset.count / aCount : 0;
                
                if (confidence_A_to_B > 0.3) {
                    rules.push({
                        antecedent: [itemA],
                        consequent: [itemB],
                        support: itemset.support,
                        confidence: confidence_A_to_B,
                        lift: confidence_A_to_B / (frequentItemsets.items.find(item => item.items[0] === itemB)?.support || 1)
                    });
                }
                
                // Rule: B -> A
                const bCount = frequentItemsets.items.find(item => item.items[0] === itemB)?.count || 0;
                const confidence_B_to_A = bCount > 0 ? itemset.count / bCount : 0;
                
                if (confidence_B_to_A > 0.3) {
                    rules.push({
                        antecedent: [itemB],
                        consequent: [itemA],
                        support: itemset.support,
                        confidence: confidence_B_to_A,
                        lift: confidence_B_to_A / (frequentItemsets.items.find(item => item.items[0] === itemA)?.support || 1)
                    });
                }
            });
            
            return rules.sort((a, b) => b.confidence - a.confidence);
        }
        
        function displayMarketBasketResults(frequentItemsets, associationRules, transactions) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>🛒 Анализ на пазарната кошница - Резултати</h3>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <div class="business-insight">
                        <h4>🔗 Най-силни комбинации от продукти:</h4>
                `;
                
                associationRules.slice(0, 5).forEach((rule, index) => {
                    const antecedentIcon = getProductIcon(rule.antecedent[0]);
                    const consequentIcon = getProductIcon(rule.consequent[0]);
                    
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>${index + 1}. ${antecedentIcon} ${rule.antecedent[0]} → ${consequentIcon} ${rule.consequent[0]}</strong><br>
                            <small>Вероятност: ${(rule.confidence * 100).toFixed(1)}% | Сила на връзката: ${rule.lift.toFixed(2)}</small>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="business-insight">
                        <h4>📊 Резултат от анализа:</h4>
                        <p>Не са открити значими комбинации продукти със силна връзка. Това може да означава, че продуктите се купуват предимно поотделно или данните са недостатъчни за анализ.</p>
                    </div>
                `;
            }
            
            // Show top products
            if (frequentItemsets.items.length > 0) {
                html += `
                    <div class="business-insight products">
                        <h4>⭐ Най-популярни продукти:</h4>
                `;
                
                frequentItemsets.items
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10)
                    .forEach((item, index) => {
                        const icon = getProductIcon(item.items[0]);
                        html += `
                            <div class="product-item">
                                ${icon} ${item.items[0]} (${item.count} пъти)
                            </div>
                        `;
                    });
                
                html += `</div>`;
            }
            
            html += `
                    <div class="business-insight recommendation">
                        <h4>💡 Препоръки за подобряване на продажбите:</h4>
                        <ul>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <li>Поставете близо един до друг продуктите, които се купуват заедно</li>
                    <li>Създайте промоционални пакети от често купуваните заедно продукти</li>
                    <li>При реклама на един продукт, споменете и свързаните с него</li>
                `;
            } else {
                html += `
                    <li>Анализирайте защо продуктите се купуват поотделно</li>
                    <li>Създайте промоционални пакети за стимулиране на комбинираните покупки</li>
                    <li>Проучете клиентските предпочитания за по-добро разбиране на пазарното поведение</li>
                `;
            }
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const rulesCount = associationRules.length;
            const transactionsCount = transactions.length;
            const summaryText = `Market Basket анализ: ${rulesCount} правила за асоциация, ${transactionsCount} транзакции`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('🔍 Market Basket Анализ', contentText, summaryText);
        }
        
        // Business Analysis function
        function generateBusinessAnalysis() {
            if (!processedData) {
                showError('Моля, първо качете файл с данни.');
                return;
            }
            
            try {
                const analysis = performBusinessAnalysis();
                displayBusinessAnalysis(analysis);
                showSuccess('Бизнес анализът е завършен!');
            } catch (error) {
                showError('Грешка при бизнес анализа: ' + error.message);
            }
        }
        
        function performBusinessAnalysis() {
            // Find relevant columns
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('продукт') ||
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('стока')
            );
            
            const possiblePriceColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('price') || 
                header.toLowerCase().includes('цена') ||
                header.toLowerCase().includes('amount') ||
                header.toLowerCase().includes('сума') ||
                header.toLowerCase().includes('total') ||
                header.toLowerCase().includes('общо')
            );
            
            const possibleQuantityColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('quantity') || 
                header.toLowerCase().includes('количество') ||
                header.toLowerCase().includes('qty') ||
                header.toLowerCase().includes('брой')
            );
            
            const productColumn = possibleProductColumns[0];
            const priceColumn = possiblePriceColumns[0];
            const quantityColumn = possibleQuantityColumns[0];
            
            // Filter valid data (remove product codes)
            const validData = processedData.data.filter(row => {
                const product = row[productColumn];
                return product && !(/\d/.test(product));
            });
            
            // Product analysis
            const productStats = {};
            let totalRevenue = 0;
            let totalTransactions = validData.length;
            
            validData.forEach(row => {
                const product = row[productColumn];
                const price = parseFloat(row[priceColumn]) || 0;
                const quantity = parseFloat(row[quantityColumn]) || 1;
                const revenue = price * quantity;
                
                if (!productStats[product]) {
                    productStats[product] = {
                        count: 0,
                        totalRevenue: 0,
                        totalQuantity: 0,
                        avgPrice: 0
                    };
                }
                
                productStats[product].count++;
                productStats[product].totalRevenue += revenue;
                productStats[product].totalQuantity += quantity;
                totalRevenue += revenue;
            });
            
            // Calculate averages and sort products
            Object.keys(productStats).forEach(product => {
                const stats = productStats[product];
                stats.avgPrice = stats.totalRevenue / stats.totalQuantity;
                stats.marketShare = (stats.totalRevenue / totalRevenue) * 100;
            });
            
            const topProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => b.totalRevenue - a.totalRevenue)
                .slice(0, 10);
            
            const worstProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => a.count - b.count)
                .slice(0, 5);
            
            return {
                totalRevenue,
                totalTransactions,
                avgTransactionValue: totalRevenue / totalTransactions,
                topProducts,
                worstProducts,
                productCount: Object.keys(productStats).length
            };
        }
        
        function displayBusinessAnalysis(analysis) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>💼 Бизнес анализ и препоръки</h3>
                    
                    <div class="business-insight revenue">
                        <h4>💰 Финансов преглед:</h4>
                        <ul>
                            <li><strong>Общ оборот:</strong> ${analysis.totalRevenue.toFixed(2)} лв.</li>
                            <li><strong>Общо транзакции:</strong> ${analysis.totalTransactions} бр.</li>
                            <li><strong>Средна стойност на транзакция:</strong> ${analysis.avgTransactionValue.toFixed(2)} лв.</li>
                            <li><strong>Брой различни продукти:</strong> ${analysis.productCount} бр.</li>
                        </ul>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>⭐ Най-печеливши продукти:</h4>
                        <div class="product-list">
            `;
            
            analysis.topProducts.forEach(([product, stats], index) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        <strong>${index + 1}. ${icon} ${product}</strong><br>
                        <small>Оборот: ${stats.totalRevenue.toFixed(2)} лв. | Продажби: ${stats.count} бр. | Дял: ${stats.marketShare.toFixed(1)}%</small>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>⚠️ Слабо продавани продукти:</h4>
                        <div class="product-list">
            `;
            
            analysis.worstProducts.forEach(([product, stats]) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        ${icon} ${product} - само ${stats.count} бр. продажби
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight recommendation">
                        <h4>🎯 Конкретни препоръки за действие:</h4>
                        <ul>
                            <li><strong>Фокус върху топ продуктите:</strong> Увеличете рекламата и наличността на ${analysis.topProducts.slice(0, 3).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>Преосмислете слабите продукти:</strong> Намалете или премахнете от асортимента ${analysis.worstProducts.slice(0, 2).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>Анализ на ценообразуването:</strong> Проверете цените на топ продуктите - може да имате възможност за увеличение</li>
                            <li><strong>Управление на запасите:</strong> Осигурете достатъчно количества от печелившите продукти</li>
                            <li><strong>Маркетингова стратегия:</strong> Насочете рекламния бюджет към продуктите с най-висок оборот</li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const summaryText = `Бизнес анализ: Оборот ${analysis.totalRevenue.toFixed(2)} лв., ${analysis.totalTransactions} транзакции, ${analysis.productCount} продукта`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('💼 Бизнес анализ', contentText, summaryText);
        }
        
        // Export functions - FIXED VERSION
        function exportToPDF() {
            try {
                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    showError('PDF библиотеката не е заредена. Моля, презаредете страницата.');
                    return;
                }
                
                showLoading('Генериране на PDF отчет...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Safe text function with validation
                const safeText = (text, x, y) => {
                    try {
                        if (text && typeof text === 'string' && x && y) {
                            // Clean text from problematic characters
                            const cleanText = text.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                            doc.text(cleanText, x, y);
                            return true;
                        }
                    } catch (e) {
                        console.warn('Failed to add text:', text, e);
                        return false;
                    }
                    return false;
                };
                
                // Add title
                doc.setFontSize(16);
                safeText('Business Intelligence Отчет', 20, 20);
                
                // Add date
                doc.setFontSize(10);
                const dateStr = new Date().toLocaleDateString('bg-BG');
                safeText(`Генериран на: ${dateStr}`, 20, 30);
                
                let yPos = 50;
                
                if (processedData && processedData.data && processedData.headers) {
                    // Add data summary
                    doc.setFontSize(12);
                    safeText('Обобщение на данните:', 20, yPos);
                    yPos += 15;
                    
                    doc.setFontSize(10);
                    safeText(`Общо записи: ${processedData.data.length} бр.`, 20, yPos);
                    yPos += 10;
                    
                    // Safe headers join
                    const headersStr = processedData.headers.slice(0, 5).join(', ');
                    safeText(`Колони: ${headersStr}`, 20, yPos);
                    yPos += 15;
                    
                    // Add sample data - with better error handling
                    safeText('Примерни данни (първите 5 записа):', 20, yPos);
                    yPos += 10;
                    
                    processedData.data.slice(0, 5).forEach((row, index) => {
                        try {
                            if (row && typeof row === 'object') {
                                const values = Object.values(row).slice(0, 3);
                                const cleanValues = values.map(v => v ? String(v).substring(0, 50) : '').filter(v => v);
                                const rowText = `${index + 1}. ${cleanValues.join(' | ')}`;
                                if (safeText(rowText, 20, yPos)) {
                                    yPos += 8;
                                }
                            }
                        } catch (rowError) {
                            console.warn('Error processing row:', index, rowError);
                        }
                    });
                }
                
                // Add analysis results if available
                const analysisResults = document.getElementById('analysisResults');
                if (analysisResults && analysisResults.innerHTML.trim()) {
                    doc.addPage();
                    doc.setFontSize(12);
                    safeText('Резултати от анализите:', 20, 20);
                    doc.setFontSize(10);
                    safeText('Моля, вижте детайлните резултати в приложението.', 20, 35);
                    
                    // Try to extract and add some analysis text
                    try {
                        const textContent = analysisResults.textContent || '';
                        const lines = textContent.split('\n').filter(line => line.trim()).slice(0, 20);
                        let analysisY = 50;
                        
                        lines.forEach(line => {
                            if (analysisY < 280) { // Don't exceed page height
                                if (safeText(line.trim().substring(0, 80), 20, analysisY)) {
                                    analysisY += 8;
                                }
                            }
                        });
                    } catch (analysisError) {
                        console.warn('Error adding analysis content:', analysisError);
                    }
                }
                
                // Generate and download
                const filename = `BI_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                const pdfBlob = doc.output('blob');
                
                if (pdfBlob && pdfBlob.size > 0) {
                    const url = window.URL.createObjectURL(pdfBlob);
                    console.log('PDF generated successfully:', filename, 'Size:', pdfBlob.size, 'bytes');
                    
                    // Use simple direct download instead of complex system
                    downloadFile(url, filename);
                } else {
                    throw new Error('PDF генерирането неуспешно - файлът е празен');
                }
                
            } catch (error) {
                hideLoading();
                showError('Грешка при генериране на PDF: ' + error.message);
                console.error('PDF Export Error:', error);
            }
        }
        
        // Simplified download function
        function downloadFile(url, filename) {
            try {
                hideLoading();
                
                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                showMessage(`Файлът "${filename}" е изтеглен успешно! 📁`, 'success');
                
                // Cleanup URL after delay
                setTimeout(() => {
                    try {
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        console.warn('URL cleanup error:', e);
                    }
                }, 1000);
                
                console.log('Download completed:', filename);
                
            } catch (error) {
                hideLoading();
                console.error('Download error:', error);
                showError('Грешка при изтегляне: ' + error.message);
            }
        }
        
        function exportToExcel() {
            try {
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined') {
                    showError('Excel библиотеката не е заредена. Моля, презаредете страницата.');
                    return;
                }
                
                if (!processedData) {
                    showError('Няма данни за експорт.');
                    return;
                }
                
                showLoading('Генериране на Excel файл...');
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add main data sheet
                const ws = XLSX.utils.json_to_sheet(processedData.data);
                XLSX.utils.book_append_sheet(wb, ws, 'Данни');
                
                // Add summary sheet
                const summaryData = [
                    ['Обобщение на данните'],
                    ['Общо записи (брой)', processedData.data.length],
                    ['Брой колони (брой)', processedData.headers.length],
                    ['Дата на експорт', new Date().toLocaleDateString('bg-BG')]
                ];
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Обобщение');
                
                // Generate file
                const filename = `BI_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                const excelBlob = new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const url = window.URL.createObjectURL(excelBlob);
                console.log('Excel generated successfully:', filename, 'Size:', excelBlob.size, 'bytes');
                downloadFile(url, filename);
                
            } catch (error) {
                showError('Грешка при генериране на Excel: ' + error.message);
                console.error('Excel Export Error:', error);
            }
        }
        
        // Enhanced download system - SIMPLIFIED
        function triggerEnhancedDownload(url, filename, fileType) {
            try {
                // Hide loading
                hideLoading();
                
                console.log(`Attempting download: ${filename}, URL: ${url.substring(0, 50)}...`);
                
                // Method 1: Direct download link with multiple attempts
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                link.target = '_blank';
                
                // Add to DOM
                document.body.appendChild(link);
                
                // Try clicking with user interaction simulation
                setTimeout(() => {
                    try {
                        link.click();
                        console.log('Download triggered successfully');
                        showSimpleDownloadNotification(filename, fileType);
                    } catch (clickError) {
                        console.error('Click error:', clickError);
                        // Fallback: Try opening in new window
                        tryFallbackDownload(url, filename, fileType);
                    }
                }, 10);
                
                // Cleanup after delay
                setTimeout(() => {
                    try {
                        if (document.body.contains(link)) {
                            document.body.removeChild(link);
                        }
                        window.URL.revokeObjectURL(url);
                    } catch (cleanupError) {
                        console.error('Cleanup error:', cleanupError);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Download error:', error);
                tryFallbackDownload(url, filename, fileType);
            }
        }
        
        function tryFallbackDownload(url, filename, fileType) {
            try {
                // Fallback method: Open in new window with instructions
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    // Show notification with instructions
                    showDownloadInstructionsNotification(filename, fileType);
                } else {
                    // Pop-up blocked, show manual download
                    showManualDownloadNotification(url, filename, fileType);
                }
            } catch (fallbackError) {
                console.error('Fallback error:', fallbackError);
                showError('Не успях да започна изтегляне. Моля, проверете настройките на браузъра за pop-up блокиране.');
            }
        }
        
        // Simple download notification
        function showSimpleDownloadNotification(filename, fileType) {
            const notification = document.createElement('div');
            notification.className = 'download-notification success';
            notification.innerHTML = `
                <div class="notification-header">
                    <span>✅</span>
                    <span>${fileType} е генериран!</span>
                </div>
                <div class="notification-body">
                    <strong>${filename}</strong><br>
                    <small>Файлът трябва да се изтегли автоматично.<br>
                    Ако не се случи, проверете папката "Downloads" или разрешенията на браузъра.</small>
                </div>
                <div class="notification-actions">
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-btn">
                        ✕ Затвори
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function showDownloadInstructionsNotification(filename, fileType) {
            const notification = document.createElement('div');
            notification.className = 'download-notification info';
            notification.innerHTML = `
                <div class="notification-header">
                    📥 ${fileType} изтегляне започна
                </div>
                <div class="notification-body">
                    <strong>${filename}</strong><br>
                    <small>Файлът се отваря в нов прозорец.<br>
                    Използвайте Ctrl+S за запазване или десен клик → "Запази като..."</small>
                </div>
                <div class="notification-actions">
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-btn">
                        ✓ Разбрах
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.remove();
                }
            }, 10000);
        }
        
        function showManualDownloadNotification(url, filename, fileType) {
            const notification = document.createElement('div');
            notification.className = 'download-notification error';
            notification.innerHTML = `
                <div class="notification-header">
                    ⚠️ Нужна е ръчна помощ
                </div>
                <div class="notification-body">
                    <strong>${filename}</strong><br>
                    <small>Браузърът блокира автоматичното изтегляне.<br>
                    Кликнете бутона за ръчно изтегляне:</small>
                </div>
                <div class="notification-actions">
                    <a href="${url}" download="${filename}" class="notification-btn" style="background: #28a745; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; margin: 5px;">
                        📥 Изтегли файла
                    </a>
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-btn">
                        ✕ Затвори
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-close after 15 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.remove();
                }
            }, 15000);
        }
    </script>
</body>
</html>
