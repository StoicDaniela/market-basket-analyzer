<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence Analyzer v2.4 - Print Table Format</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #4a90e2 0%, #50c9c3 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #007bff;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            background: #007bff;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .file-input-label:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
            transition: all 0.3s ease;
        }
        
        .control-group:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .control-group h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .control-group p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .export-section {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #28a745;
            text-align: center;
        }
        
        .export-section h3 {
            color: #155724;
            margin-bottom: 15px;
        }
        
        .export-section p {
            color: #155724;
            margin-bottom: 20px;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            max-height: 350px;
            overflow: hidden;
        }
        
        .chart-canvas {
            max-width: 100%;
            height: 300px;
            width: 100% !important;
        }
        
        .analysis-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #17a2b8;
        }
        
        .analysis-section h3 {
            color: #17a2b8;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .data-preview {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-preview th,
        .data-preview td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-preview th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: #fff3cd;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .loading.show {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        .business-insight {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .business-insight.revenue {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border-left: 5px solid #28a745;
        }
        
        .business-insight.products {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 5px solid #2196f3;
        }
        
        .business-insight.recommendation {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left: 5px solid #ff9800;
        }
        
        .business-insight h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .business-insight ul {
            margin-left: 20px;
        }
        
        .business-insight li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .product-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 3px solid #007bff;
        }
        
        .download-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            min-width: 400px;
            max-width: 90%;
            border: 3px solid #28a745;
        }
        
        .download-notification.error {
            border-color: #dc3545;
        }
        
        .download-notification.info {
            border-color: #17a2b8;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .notification-body {
            margin-bottom: 20px;
            color: #666;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .notification-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .notification-btn:not(.secondary) {
            background: #28a745;
            color: white;
        }
        
        .notification-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .notification-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .notification-btn.disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Login Screen Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 400px;
            max-width: 90%;
        }

        .login-form h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #007bff;
        }

        .login-form .login-btn {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 10px;
        }

        .login-form .login-btn:hover {
            background: #0056b3;
        }

        .login-error {
            color: #dc3545;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 5px;
            display: none;
        }

        .main-app {
            display: none;
        }

        @media (max-width: 768px) {
            .login-form {
                min-width: auto;
                padding: 30px 20px;
            }
            
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .analysis-controls {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                max-height: 250px;
                padding: 15px;
            }
            
            .chart-canvas {
                height: 200px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .download-notification {
                min-width: 90%;
                margin: 0 5%;
            }
        }
        
        /* History section styles */
        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-item-date {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }
        
        .history-item-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .history-item-content {
            color: #333;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }

        /* Screen format: Show blocks, hide tables */
        .screen-format {
            display: block !important;
        }

        .print-format {
            display: none !important;
        }

        /* Print styles - Show only charts and analysis results */
        @media print {
            /* Force UTF-8 encoding for proper Bulgarian text */
            * {
                font-family: "Times New Roman", "DejaVu Sans", serif !important;
                -webkit-font-feature-settings: "kern" 1 !important;
                font-feature-settings: "kern" 1 !important;
            }
            
            /* Hide everything except results section */
            .header,
            .upload-section,
            .analysis-controls,
            .export-section,
            .history-section,
            .loading,
            .login-overlay,
            .file-input-wrapper,
            .btn,
            .control-group,
            .footer,
            button,
            input,
            .login-container,
            .form-section,
            .controls,
            #loginOverlay,
            .login-form,
            .error-message,
            .success-message {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Show only specific results */
            .results-section,
            #analysisResults,
            .chart-container,
            #chartsContainer {
                display: block !important;
                visibility: visible !important;
                margin: 0 !important;
                padding: 15px !important;
            }
            
            /* Optimize charts for printing */
            .chart-container {
                page-break-inside: avoid;
                margin-bottom: 30px !important;
                border: 2px solid #333 !important;
                padding: 20px !important;
                background: white !important;
                border-radius: 0 !important;
            }
            
            /* Chart titles styling */
            .chart-container h3,
            .chart-container h4 {
                font-size: 14pt !important;
                font-weight: bold !important;
                margin-bottom: 15px !important;
                text-align: center !important;
                color: #000 !important;
                page-break-after: avoid !important;
            }
            
            /* Canvas sizing for charts */
            canvas {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            
            /* Optimize analysis results for printing */
            #analysisResults {
                page-break-inside: avoid;
                background: white !important;
                padding: 20px !important;
                border: 2px solid #333 !important;
                margin: 20px 0 !important;
                font-size: 11pt !important;
                line-height: 1.5 !important;
            }
            
            /* Analysis results formatting */
            #analysisResults h3,
            #analysisResults h4 {
                font-size: 13pt !important;
                font-weight: bold !important;
                margin: 15px 0 10px 0 !important;
                color: #000 !important;
                page-break-after: avoid !important;
            }
            
            #analysisResults p,
            #analysisResults div {
                margin-bottom: 8px !important;
                font-size: 10pt !important;
                line-height: 1.4 !important;
            }
            
            #analysisResults ul,
            #analysisResults ol {
                margin: 10px 0 10px 20px !important;
                font-size: 10pt !important;
            }
            
            #analysisResults li {
                margin-bottom: 5px !important;
                line-height: 1.3 !important;
            }

            /* MBA Tables styling for print */
            .mba-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 15px 0 !important;
                font-size: 9pt !important;
                background: white !important;
                border: 1px solid #333 !important;
            }

            .mba-table th {
                background-color: #f5f5f5 !important;
                border: 1px solid #333 !important;
                padding: 8px 6px !important;
                text-align: left !important;
                font-weight: bold !important;
                font-size: 9pt !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .mba-table td {
                border: 1px solid #333 !important;
                padding: 6px !important;
                font-size: 9pt !important;
                line-height: 1.2 !important;
                vertical-align: top !important;
            }

            .mba-table tr:nth-child(even) {
                background-color: #f9f9f9 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Prevent tables from breaking across pages */
            .association-table,
            .popular-products-table,
            .weak-association-table {
                page-break-inside: avoid !important;
            }

            /* Ensure table headers stay with content */
            .mba-table thead {
                display: table-header-group !important;
            }

            /* Show only tables in print, hide screen format */
            .print-format {
                display: table !important;
                visibility: visible !important;
            }

            .screen-format {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Container adjustments for print */
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                background: white !important;
                width: 100% !important;
            }
            
            /* Body adjustments for print */
            body {
                background: white !important;
                color: black !important;
                font-size: 11pt !important;
                line-height: 1.4 !important;
                margin: 0 !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Page setup */
            @page {
                margin: 1.5cm !important;
                size: A4 !important;
            }
            
            /* Ensure good contrast for printing */
            h1, h2, h3, h4, h5, h6 {
                color: black !important;
                font-weight: bold !important;
                page-break-after: avoid !important;
            }
            
            /* Add a title for the printed document */
            body::before {
                content: "Business Intelligence Анализ - Резултати";
                display: block !important;
                font-size: 20pt !important;
                font-weight: bold !important;
                text-align: center !important;
                margin: 0 0 30px 0 !important;
                padding: 15px !important;
                border-bottom: 3px solid #333 !important;
                background: #f5f5f5 !important;
                page-break-after: avoid !important;
            }
            
            /* Hide specific problematic elements */
            .login-overlay,
            .loading,
            script,
            style:not([media*="print"]),
            .error,
            .warning,
            .notification,
            .popup,
            .modal {
                display: none !important;
            }
            
            /* Remove any JavaScript-generated content that causes issues */
            .dynamic-content:empty {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-form">
            <h2>🔐 Вход в системата</h2>
            <div class="input-group">
                <label for="username">Потребително име:</label>
                <input type="text" id="username" placeholder="Въведете потребително име">
            </div>
            <div class="input-group">
                <label for="password">Парола:</label>
                <input type="password" id="password" placeholder="Въведете парола">
            </div>
            <button class="login-btn" onclick="attemptLogin()">🚀 Влез</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="container">
        <div class="header">
            <h1>🎯 Business Intelligence Analyzer</h1>
            <p>Превърнете данните си в полезни бизнес решения с лесност и стил</p>
        </div>
        
        <div class="upload-section">
            <h2>📁 Качване на данни</h2>
            <p>Качете Excel (.xlsx, .xls) или CSV файл за анализ</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                <label for="fileInput" class="file-input-label">
                    📂 Изберете файл
                </label>
            </div>
            <br>
            <button class="btn" onclick="loadFile()">🚀 Зареди данните</button>
        </div>
        
        <div class="analysis-controls">
            <div class="control-group">
                <h3>📊 Визуализация на данните</h3>
                <p>Създайте диаграми и графики за по-ясно разбиране</p>
                <button class="btn" onclick="createCharts()">📈 Създай диаграми</button>
            </div>
            
            <div class="control-group">
                <h3>🔍 Market Basket анализ</h3>
                <p>Открийте връзки между продуктите</p>
                <button class="btn" onclick="performMarketBasketAnalysis()">🔍 Анализирай връзките</button>
            </div>
            
            <div class="control-group">
                <h3>💼 Бизнес анализ</h3>
                <p>Получете бизнес препоръки и анализи</p>
                <button class="btn" onclick="generateBusinessAnalysis()">💡 Генерирай анализ</button>
            </div>
        </div>
        
        <div class="export-section">
            <h3>📤 Експорт на резултатите</h3>
            <p>Изтеглете анализите в удобен формат</p>
            <button class="btn" onclick="exportToPDF()">📑 Експорт PDF</button>
            <button class="btn" onclick="exportToExcel()">📊 Експорт Excel</button>
            <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 0.9em;">
                <strong>💡 Съвети за изтегляне:</strong>
                <ul style="margin: 5px 0 0 20px; text-align: left;">
                    <li>Ако файлът не се изтегли автоматично, проверете браузъра за блокирани pop-up прозорци</li>
                    <li>Файловете се запазват в папката "Downloads" на компютъра</li>
                    <li>При проблеми, отворете Developer Console (F12) за повече информация</li>
                </ul>
            </div>
        </div>
        
        <div class="history-section" style="margin-top: 30px;">
            <h3>📚 История на анализите</h3>
            <p>Преглед на предишни анализи и резултати</p>
            <button class="btn" onclick="showAnalysisHistory()">📖 Покажи история</button>
            <button class="btn secondary" onclick="clearAnalysisHistory()" style="margin-left: 10px;">🗑️ Изчисти история</button>
            <div id="historyContainer" style="margin-top: 15px; display: none;"></div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <h3>⏳ Обработка на данните...</h3>
            <p>Моля, изчакайте...</p>
        </div>
        
        <div class="loading" id="exportLoading">
            <h3>📦 Генериране на файл...</h3>
            <p>Файлът се подготвя за изтегляне...</p>
        </div>
        
        <div class="results-section">
            <div id="chartContainer"></div>
            <div id="analysisResults"></div>
        </div>
    </div>
    </div> <!-- End of main-app -->
    
    <script>
        // Login functionality
        function attemptLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Check credentials
            if (username === 'admin' && password === 'password') {
                // Hide login screen
                document.getElementById('loginOverlay').style.display = 'none';
                // Show main application
                document.getElementById('mainApp').style.display = 'block';
                // Clear error
                errorDiv.style.display = 'none';
            } else {
                // Show error
                errorDiv.textContent = 'Грешно потребително име или парола!';
                errorDiv.style.display = 'block';
                // Clear password field
                document.getElementById('password').value = '';
            }
        }

        // Allow Enter key to submit login
        document.addEventListener('DOMContentLoaded', function() {
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            
            if (usernameField && passwordField) {
                usernameField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        passwordField.focus();
                    }
                });
                
                passwordField.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        attemptLogin();
                    }
                });
            }
        });

        let processedData = null;
        let currentCharts = [];
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
        
        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        function showInfo(message) {
            showNotification(message, 'info');
        }
        
        function showMessage(message, type = 'success') {
            showNotification(message, type);
        }
        
        function showLoading(message) {
            const loading = document.getElementById('exportLoading');
            if (loading) {
                loading.innerHTML = `<h3>⏳ ${message}</h3><p>Моля, изчакайте...</p>`;
                loading.style.display = 'block';
            }
        }
        
        function hideLoading() {
            const loading = document.getElementById('exportLoading');
            if (loading) loading.style.display = 'none';
        }
        
        // Analysis History Functions
        function saveToHistory(type, content, summary) {
            const historyItem = {
                id: Date.now(),
                date: new Date().toLocaleString('bg-BG'),
                type: type,
                content: content,
                summary: summary || 'Анализ без описание'
            };
            
            analysisHistory.unshift(historyItem); // Add to beginning
            
            // Keep only last 20 items
            if (analysisHistory.length > 20) {
                analysisHistory = analysisHistory.slice(0, 20);
            }
            
            // Save to localStorage
            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            console.log('Analysis saved to history:', type, summary);
        }
        
        function showAnalysisHistory() {
            const container = document.getElementById('historyContainer');
            
            if (analysisHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>📭 Няма запазени анализи</p>
                        <p style="font-size: 0.9em;">Направете първия си анализ, за да се появи тук!</p>
                    </div>
                `;
            } else {
                let historyHtml = '<h4>📚 Запазени анализи (' + analysisHistory.length + ' бр.)</h4>';
                
                analysisHistory.forEach(item => {
                    historyHtml += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-date">${item.date}</span>
                                <span class="history-item-type">${item.type}</span>
                            </div>
                            <div class="history-item-content">
                                <strong>${item.summary}</strong><br>
                                ${item.content.substring(0, 300)}${item.content.length > 300 ? '...' : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = historyHtml;
            }
            
            // Toggle visibility
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function clearAnalysisHistory() {
            if (confirm('Сигурни ли сте, че искате да изтриете цялата история на анализите?')) {
                analysisHistory = [];
                localStorage.removeItem('analysisHistory');
                
                const container = document.getElementById('historyContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>✅ Историята е изчистена</p>
                    </div>
                `;
                
                showSuccess('Историята на анализите е изчистена успешно!');
                
                // Hide container after 2 seconds
                setTimeout(() => {
                    container.style.display = 'none';
                }, 2000);
            }
        }
        
        // File loading functions
        function loadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Моля, изберете файл първо.');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('show');
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = function(e) {
                    try {
                        processedData = parseCSV(e.target.result);
                        displayDataPreview();
                        showSuccess('CSV файлът е зареден успешно!');
                    } catch (error) {
                        showError('Грешка при четене на CSV файла: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        processedData = parseArrayData(jsonData);
                        displayDataPreview();
                        showSuccess('Excel файлът е зареден успешно!');
                    } catch (error) {
                        showError('Грешка при четене на Excel файла: ' + error.message);
                    } finally {
                        document.getElementById('loadingIndicator').classList.remove('show');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                showError('Неподдържан формат на файл. Моля, използвайте CSV или Excel файлове.');
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return { headers, data };
        }
        
        function parseArrayData(arrayData) {
            if (arrayData.length === 0) return { headers: [], data: [] };
            
            const headers = arrayData[0].map(h => String(h || '').trim());
            const data = [];
            
            for (let i = 1; i < arrayData.length; i++) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = arrayData[i][index] || '';
                });
                if (Object.values(row).some(v => v !== '')) {
                    data.push(row);
                }
            }
            
            return { headers, data };
        }
        
        function displayDataPreview() {
            const container = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>📋 Преглед на данните</h3>
                    <p><strong>Заредени записи:</strong> ${processedData.data.length} бр.</p>
                    <p><strong>Колони:</strong> ${processedData.headers.join(', ')}</p>
                    
                    <div class="data-preview">
                        <table>
                            <thead>
                                <tr>
            `;
            
            processedData.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            
            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show first 5 rows
            processedData.data.slice(0, 5).forEach(row => {
                html += '<tr>';
                processedData.headers.forEach(header => {
                    html += `<td>${row[header] || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    ${processedData.data.length > 5 ? `<p><em>Показани са първите 5 записа от общо ${processedData.data.length}</em></p>` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function createCharts() {
            const container = document.getElementById('chartContainer');
            if (!container) {
                console.error('Chart container element not found in DOM');
                showError('Грешка: Не може да се намери контейнера за диаграми');
                return;
            }
            
            // Clear existing content
            container.innerHTML = '';
            
            // Destroy existing charts
            if (window.currentCharts && window.currentCharts.length > 0) {
                window.currentCharts.forEach(chart => {
                    try {
                        chart.destroy();
                    } catch (e) {
                        console.warn('Error destroying chart:', e);
                    }
                });
                window.currentCharts = [];
            }
            
            // Find suitable columns for charting
            const numericColumns = findNumericColumns();
            const textColumns = findTextColumns();
            
            if (numericColumns.length === 0) {
                container.innerHTML = `
                    <div class="chart-container">
                        <h3>⚠️ Няма числови данни за диаграми</h3>
                        <p>Файлът не съдържа числови колони подходящи за визуализация.</p>
                    </div>
                `;
                return;
            }
            
            // Create bar chart for first numeric column
            if (numericColumns.length > 0 && textColumns.length > 0) {
                createBarChart(textColumns[0], numericColumns[0]);
            }
            
            // Create pie chart if we have categorical data
            if (textColumns.length > 0) {
                createPieChart(textColumns[0]);
            }
            
            // Create line chart for trends
            if (numericColumns.length >= 2) {
                createLineChart(numericColumns[0], numericColumns[1]);
            }
            
            // Save charts to history
            const chartsCreated = [];
            if (numericColumns.length > 0 && textColumns.length > 0) chartsCreated.push('Bar Chart');
            if (textColumns.length > 0) chartsCreated.push('Pie Chart');
            if (numericColumns.length >= 2) chartsCreated.push('Line Chart');
            
            if (chartsCreated.length > 0) {
                const summaryText = `Визуализация: ${chartsCreated.join(', ')} от ${processedData.data.length} записа`;
                const contentText = `Създадени диаграми: ${chartsCreated.join(', ')}\nДанни: ${processedData.data.length} записа\nКолони: ${processedData.headers.join(', ')}`;
                saveToHistory('📊 Визуализация', contentText, summaryText);
            }
        }
        
        function findNumericColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && !isNaN(parseFloat(value)) && isFinite(value);
                });
            });
        }
        
        function findTextColumns() {
            return processedData.headers.filter(header => {
                return processedData.data.some(row => {
                    const value = row[header];
                    return value && isNaN(parseFloat(value));
                });
            });
        }
        
        function createBarChart(categoryColumn, valueColumn) {
            // Group data by category
            const categoryData = {};
            processedData.data.forEach(row => {
                const category = row[categoryColumn];
                const value = parseFloat(row[valueColumn]) || 0;
                
                if (category) {
                    categoryData[category] = (categoryData[category] || 0) + value;
                }
            });
            
            // Sort by value and take top 10
            const sortedData = Object.entries(categoryData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const labels = sortedData.map(([category]) => category);
            const values = sortedData.map(([, value]) => value);
            
            // Create chart
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            
            const container = document.getElementById('chartContainer');
            if (!container) {
                console.error('Chart container not found for bar chart');
                return;
            }
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<h3>📊 ${categoryColumn} vs ${valueColumn} (брой)</h3>`;
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get canvas context for bar chart');
                return;
            }
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${valueColumn} (брой)`,
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Продукти vs Количество (брой)`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество (брой)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: categoryColumn
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createPieChart(categoryColumn) {
            // Count occurrences
            const categoryData = {};
            processedData.data.forEach(row => {
                const category = row[categoryColumn];
                if (category) {
                    categoryData[category] = (categoryData[category] || 0) + 1;
                }
            });
            
            // Sort and take top 8
            const sortedData = Object.entries(categoryData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            const labels = sortedData.map(([category]) => category);
            const values = sortedData.map(([, count]) => count);
            
            // Create chart
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            
            const container = document.getElementById('chartContainer');
            if (!container) {
                console.error('Chart container not found for pie chart');
                return;
            }
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<h3>🥧 Разпределение на ${categoryColumn} (брой)</h3>`;
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get canvas context for pie chart');
                return;
            }
            
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Разпределение на ${categoryColumn} (брой)`
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const dataset = data.datasets[0];
                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                        
                                        return data.labels.map((label, i) => {
                                            const value = dataset.data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            
                                            return {
                                                text: `${label}: ${value} (${percentage}%)`,
                                                fillStyle: dataset.backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        function createLineChart(xColumn, yColumn) {
            // Get numeric data and sort by x-axis
            const chartData = processedData.data
                .map(row => ({
                    x: parseFloat(row[xColumn]) || 0,
                    y: parseFloat(row[yColumn]) || 0
                }))
                .filter(point => !isNaN(point.x) && !isNaN(point.y))
                .sort((a, b) => a.x - b.x);
            
            if (chartData.length === 0) return;
            
            // Create chart
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            
            const container = document.getElementById('chartContainer');
            if (!container) {
                console.error('Chart container not found for line chart');
                return;
            }
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<h3>📈 Тенденция: ${xColumn} vs ${yColumn}</h3>`;
            chartDiv.appendChild(canvas);
            container.appendChild(chartDiv);
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get canvas context for line chart');
                return;
            }
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${yColumn} (стойност)`,
                        data: chartData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${xColumn} vs ${yColumn} тенденция`
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: `${xColumn} (стойност)`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `${yColumn} (стойност)`
                            }
                        }
                    }
                }
            });
            
            currentCharts.push(chart);
        }
        
        // Market Basket Analysis functions
        function performMarketBasketAnalysis() {
            if (!processedData) {
                showError('Моля, първо качете файл с данни.');
                return;
            }
            
            try {
                const transactions = extractTransactions();
                const frequentItemsets = findFrequentItemsets(transactions);
                const associationRules = generateAssociationRules(frequentItemsets, transactions);
                
                displayMarketBasketResults(frequentItemsets, associationRules, transactions);
                showSuccess('Анализът на пазарната кошница е завършен!');
            } catch (error) {
                showError('Грешка при анализ на пазарната кошница: ' + error.message);
                console.error('Market basket analysis error:', error);
            }
        }
        
        function extractTransactions() {
            // Find transaction and product columns
            const possibleTransactionColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('transaction') || 
                header.toLowerCase().includes('order') ||
                header.toLowerCase().includes('customer') ||
                header.toLowerCase().includes('id') ||
                header.toLowerCase().includes('номер') ||
                header.toLowerCase().includes('клиент')
            );
            
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('продукт') ||
                header.toLowerCase().includes('стока') ||
                header.toLowerCase().includes('name')
            );
            
            const possibleDateColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('date') || 
                header.toLowerCase().includes('дата') ||
                header.toLowerCase().includes('time')
            );
            
            // Try different approaches to find transaction grouping
            let transactionColumn = possibleTransactionColumns[0];
            let productColumn = possibleProductColumns[0] || processedData.headers.find(h => h !== transactionColumn);
            let dateColumn = possibleDateColumns[0];
            
            // If no customer ID, use date as transaction grouper
            if (!transactionColumn && dateColumn) {
                transactionColumn = dateColumn;
            }
            
            // Fallback to first columns
            transactionColumn = transactionColumn || processedData.headers[0];
            productColumn = productColumn || processedData.headers[1];
            
            console.log('Market Basket Debug:', {
                headers: processedData.headers,
                transactionColumn,
                productColumn,
                dataRows: processedData.data.length
            });
            
            // Group products by transaction
            const transactions = {};
            
            processedData.data.forEach(row => {
                let transactionId = row[transactionColumn];
                const product = row[productColumn];
                
                // If using date, group by customer+date for better transactions
                if (dateColumn && dateColumn === transactionColumn) {
                    const customer = row[possibleTransactionColumns[0]] || 'default';
                    transactionId = `${customer}_${transactionId}`;
                }
                
                if (transactionId && product) {
                    if (!transactions[transactionId]) {
                        transactions[transactionId] = new Set();
                    }
                    transactions[transactionId].add(product);
                }
            });
            
            // Convert to array of arrays and filter out single-item transactions
            const transactionArrays = Object.values(transactions).map(set => Array.from(set));
            
            console.log('Market Basket Transactions:', {
                totalTransactions: transactionArrays.length,
                multiItemTransactions: transactionArrays.filter(t => t.length > 1).length,
                avgItemsPerTransaction: transactionArrays.length > 0 ? 
                    (transactionArrays.reduce((sum, t) => sum + t.length, 0) / transactionArrays.length).toFixed(2) : 0,
                sampleTransactions: transactionArrays.slice(0, 3)
            });
            
            return transactionArrays;
        }
        
        function findFrequentItemsets(transactions, minSupport = 0.05) {
            const itemCounts = {};
            const totalTransactions = transactions.length;
            
            // Count individual items
            transactions.forEach(transaction => {
                transaction.forEach(item => {
                    itemCounts[item] = (itemCounts[item] || 0) + 1;
                });
            });
            
            // Find frequent 1-itemsets
            const frequentItems = Object.entries(itemCounts)
                .filter(([item, count]) => count / totalTransactions >= minSupport)
                .map(([item, count]) => ({ items: [item], count, support: count / totalTransactions }));
            
            // Find frequent 2-itemsets
            const frequent2Itemsets = [];
            for (let i = 0; i < frequentItems.length; i++) {
                for (let j = i + 1; j < frequentItems.length; j++) {
                    const itemset = [frequentItems[i].items[0], frequentItems[j].items[0]];
                    const count = transactions.filter(transaction => 
                        itemset.every(item => transaction.includes(item))
                    ).length;
                    
                    const support = count / totalTransactions;
                    if (support >= minSupport) {
                        frequent2Itemsets.push({ items: itemset, count, support });
                    }
                }
            }
            
            return [...frequentItems, ...frequent2Itemsets];
        }
        
        function generateAssociationRules(frequentItemsets, transactions, minConfidence = 0.25) {
            const rules = [];
            const totalTransactions = transactions.length;
            
            // Generate rules from 2-itemsets
            frequentItemsets
                .filter(itemset => itemset.items.length === 2)
                .forEach(itemset => {
                    const [itemA, itemB] = itemset.items;
                    
                    // Rule: A -> B
                    const countA = transactions.filter(t => t.includes(itemA)).length;
                    const countAB = itemset.count;
                    const confidenceAB = countAB / countA;
                    
                    if (confidenceAB >= minConfidence) {
                        rules.push({
                            antecedent: [itemA],
                            consequent: [itemB],
                            support: itemset.support,
                            confidence: confidenceAB,
                            lift: confidenceAB / (transactions.filter(t => t.includes(itemB)).length / totalTransactions)
                        });
                    }
                    
                    // Rule: B -> A
                    const countB = transactions.filter(t => t.includes(itemB)).length;
                    const confidenceBA = countAB / countB;
                    
                    if (confidenceBA >= minConfidence) {
                        rules.push({
                            antecedent: [itemB],
                            consequent: [itemA],
                            support: itemset.support,
                            confidence: confidenceBA,
                            lift: confidenceBA / (countA / totalTransactions)
                        });
                    }
                });
            
            return rules.sort((a, b) => b.confidence - a.confidence);
        }
        
        function getProductIcon(product) {
            const productLower = product.toLowerCase();
            
            // Food items
            if (productLower.includes('хляб') || productLower.includes('bread')) return '🍞';
            if (productLower.includes('мляко') || productLower.includes('milk')) return '🥛';
            if (productLower.includes('сирене') || productLower.includes('cheese')) return '🧀';
            if (productLower.includes('кафе') || productLower.includes('coffee')) return '☕';
            if (productLower.includes('захар') || productLower.includes('sugar')) return '🍯';
            if (productLower.includes('ябълка') || productLower.includes('apple')) return '🍎';
            if (productLower.includes('банан') || productLower.includes('banana')) return '🍌';
            if (productLower.includes('месо') || productLower.includes('meat')) return '🥩';
            if (productLower.includes('риба') || productLower.includes('fish')) return '🐟';
            if (productLower.includes('яйца') || productLower.includes('eggs')) return '🥚';
            
            // Categories
            if (productLower.includes('продукт') || productLower.includes('product')) return '📦';
            if (productLower.includes('стока') || productLower.includes('item')) return '🛍️';
            
            return '🏷️'; // Default icon
        }
        
        function displayMarketBasketResults(frequentItemsets, associationRules, transactions) {
            const resultsDiv = document.getElementById('analysisResults');
            
            // Show top individual products
            const singleItems = frequentItemsets
                .filter(item => item.items.length === 1)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            let html = `
                <div class="analysis-section">
                    <h3>🔍 Market Basket Analysis - Анализ на пазарната кошница</h3>
                    
                    <div class="business-insight revenue">
                        <h4>📊 Обща статистика:</h4>
                        <ul>
                            <li><strong>Общо транзакции:</strong> ${transactions.length} бр.</li>
                            <li><strong>Открити често срещани продукти:</strong> ${frequentItemsets.filter(item => item.items.length === 1).length} бр.</li>
                            <li><strong>Открити правила за асоциация:</strong> ${associationRules.length} бр.</li>
                            <li><strong>Средно продукти на транзакция:</strong> ${(transactions.reduce((sum, t) => sum + t.length, 0) / transactions.length).toFixed(2)} бр.</li>
                        </ul>
                    </div>
            `;
            
            // Screen format: Original blocks
            if (associationRules.length > 0) {
                html += `
                    <div class="business-insight products">
                        <h4>🔗 Силни правила за асоциация:</h4>
                        <p>Продукти, които се купуват заедно:</p>
                        <div class="product-list screen-format">
                `;
                
                associationRules.slice(0, 10).forEach(rule => {
                    const antecedentIcon = getProductIcon(rule.antecedent[0]);
                    const consequentIcon = getProductIcon(rule.consequent[0]);
                    html += `
                        <div class="product-item">
                            <strong>${antecedentIcon} ${rule.antecedent[0]} → ${consequentIcon} ${rule.consequent[0]}</strong><br>
                            <small>Увереност: ${(rule.confidence * 100).toFixed(1)}% | Поддръжка: ${(rule.support * 100).toFixed(1)}% | Lift: ${rule.lift.toFixed(2)}</small>
                        </div>
                    `;
                });
                
                html += `</div>`;

                // Print format: Table
                html += `
                        <table class="mba-table association-table print-format">
                            <thead>
                                <tr>
                                    <th>Първи продукт</th>
                                    <th>Втори продукт</th>
                                    <th>Увереност</th>
                                    <th>Поддръжка</th>
                                    <th>Lift</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                associationRules.slice(0, 10).forEach(rule => {
                    const antecedentIcon = getProductIcon(rule.antecedent[0]);
                    const consequentIcon = getProductIcon(rule.consequent[0]);
                    html += `
                        <tr>
                            <td>${antecedentIcon} ${rule.antecedent[0]}</td>
                            <td>${consequentIcon} ${rule.consequent[0]}</td>
                            <td>${(rule.confidence * 100).toFixed(1)}%</td>
                            <td>${(rule.support * 100).toFixed(1)}%</td>
                            <td>${rule.lift.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                // Show debug information when no rules are found
                const twoItemsets = frequentItemsets.filter(item => item.items.length === 2);
                html += `
                    <div class="business-insight products">
                        <h4>🔗 Правила за асоциация:</h4>
                        <p><em>Не са открити силни правила за асоциация с минимална увереност от 25%.</em></p>
                `;
                
                if (twoItemsets.length > 0) {
                    // Screen format
                    html += `
                        <p><strong>Открити двойки продукти (слаба връзка):</strong></p>
                        <div class="product-list screen-format">
                    `;
                    twoItemsets.slice(0, 5).forEach(itemset => {
                        const [itemA, itemB] = itemset.items;
                        const iconA = getProductIcon(itemA);
                        const iconB = getProductIcon(itemB);
                        html += `
                            <div class="product-item">
                                <strong>${iconA} ${itemA} & ${iconB} ${itemB}</strong><br>
                                <small>Купени заедно ${itemset.count} пъти (${(itemset.support * 100).toFixed(1)}% от всички транзакции)</small>
                            </div>
                        `;
                    });
                    html += `</div>`;

                    // Print format
                    html += `
                        <table class="mba-table weak-association-table print-format">
                            <thead>
                                <tr>
                                    <th>Първи продукт</th>
                                    <th>Втори продукт</th>
                                    <th>Брой срещания</th>
                                    <th>Поддръжка</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    twoItemsets.slice(0, 5).forEach(itemset => {
                        const [itemA, itemB] = itemset.items;
                        const iconA = getProductIcon(itemA);
                        const iconB = getProductIcon(itemB);
                        html += `
                            <tr>
                                <td>${iconA} ${itemA}</td>
                                <td>${iconB} ${itemB}</td>
                                <td>${itemset.count} пъти</td>
                                <td>${(itemset.support * 100).toFixed(1)}%</td>
                            </tr>
                        `;
                    });
                    html += `
                            </tbody>
                        </table>
                    `;
                } else {
                    html += `<p><em>Не са открити и двойки продукти, които се купуват заедно често.</em></p>`;
                }
                
                html += `</div>`;
            }
            
            // Popular Products section
            if (singleItems.length > 0) {
                html += `
                    <div class="business-insight products">
                        <h4>⭐ Най-популярни продукти:</h4>
                        
                        <!-- Screen format -->
                        <div class="product-list screen-format">
                `;
                
                singleItems
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10)
                    .forEach((item, index) => {
                        const icon = getProductIcon(item.items[0]);
                        html += `
                            <div class="product-item">
                                ${icon} ${item.items[0]} (${item.count} пъти)
                            </div>
                        `;
                    });
                
                html += `</div>`;

                // Print format: Table
                html += `
                        <table class="mba-table popular-products-table print-format">
                            <thead>
                                <tr>
                                    <th>Позиция</th>
                                    <th>Продукт</th>
                                    <th>Брой продажби</th>
                                    <th>Честота</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                singleItems
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10)
                    .forEach((item, index) => {
                        const icon = getProductIcon(item.items[0]);
                        const frequency = (item.count / transactions.length * 100).toFixed(1);
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${icon} ${item.items[0]}</td>
                                <td>${item.count} пъти</td>
                                <td>${frequency}%</td>
                            </tr>
                        `;
                    });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            html += `
                    <div class="business-insight recommendation">
                        <h4>💡 Препоръки за подобряване на продажбите:</h4>
                        <ul>
            `;
            
            if (associationRules.length > 0) {
                html += `
                    <li>Поставете близо един до друг продуктите, които се купуват заедно</li>
                    <li>Създайте промоционални пакети от често купуваните заедно продукти</li>
                    <li>При реклама на един продукт, споменете и свързаните с него</li>
                `;
            } else {
                html += `
                    <li>Анализирайте защо продуктите се купуват поотделно</li>
                    <li>Създайте промоционални пакети за стимулиране на комбинираните покупки</li>
                    <li>Проучете клиентските предпочитания за по-добро разбиране на пазарното поведение</li>
                `;
            }
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const rulesCount = associationRules.length;
            const transactionsCount = transactions.length;
            const summaryText = `Market Basket анализ: ${rulesCount} правила за асоциация, ${transactionsCount} транзакции`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('🔍 Market Basket Анализ', contentText, summaryText);
        }
        
        // Business Analysis function
        function generateBusinessAnalysis() {
            if (!processedData) {
                showError('Моля, първо качете файл с данни.');
                return;
            }
            
            try {
                const analysis = performBusinessAnalysis();
                displayBusinessAnalysis(analysis);
                showSuccess('Бизнес анализът е завършен!');
            } catch (error) {
                showError('Грешка при бизнес анализа: ' + error.message);
            }
        }
        
        function performBusinessAnalysis() {
            // Find relevant columns
            const possibleProductColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('product') || 
                header.toLowerCase().includes('продукт') ||
                header.toLowerCase().includes('item') ||
                header.toLowerCase().includes('стока')
            );
            
            const possiblePriceColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('price') || 
                header.toLowerCase().includes('цена') ||
                header.toLowerCase().includes('amount') ||
                header.toLowerCase().includes('сума') ||
                header.toLowerCase().includes('total') ||
                header.toLowerCase().includes('общо')
            );
            
            const possibleQuantityColumns = processedData.headers.filter(header => 
                header.toLowerCase().includes('quantity') || 
                header.toLowerCase().includes('количество') ||
                header.toLowerCase().includes('qty') ||
                header.toLowerCase().includes('брой')
            );
            
            const productColumn = possibleProductColumns[0];
            const priceColumn = possiblePriceColumns[0];
            const quantityColumn = possibleQuantityColumns[0];
            
            // Filter valid data (remove product codes)
            const validData = processedData.data.filter(row => {
                const product = row[productColumn];
                return product && product.length > 2 && !/^[A-Z0-9]+$/.test(product);
            });
            
            // Calculate statistics
            const productStats = {};
            let totalRevenue = 0;
            let totalTransactions = validData.length;
            
            validData.forEach(row => {
                const product = row[productColumn];
                const price = parseFloat(row[priceColumn]) || 0;
                const quantity = parseFloat(row[quantityColumn]) || 1;
                const revenue = price * quantity;
                
                if (!productStats[product]) {
                    productStats[product] = {
                        count: 0,
                        totalRevenue: 0,
                        avgPrice: 0,
                        totalQuantity: 0
                    };
                }
                
                productStats[product].count++;
                productStats[product].totalRevenue += revenue;
                productStats[product].totalQuantity += quantity;
                totalRevenue += revenue;
            });
            
            // Calculate market share and average prices
            Object.keys(productStats).forEach(product => {
                const stats = productStats[product];
                stats.marketShare = (stats.totalRevenue / totalRevenue) * 100;
                stats.avgPrice = stats.totalRevenue / stats.totalQuantity;
            });
            
            // Find top and worst products
            const sortedProducts = Object.entries(productStats)
                .sort(([,a], [,b]) => b.totalRevenue - a.totalRevenue);
            
            const topProducts = sortedProducts.slice(0, 5);
            const worstProducts = sortedProducts.slice(-3).reverse();
            
            return {
                totalRevenue,
                totalTransactions,
                avgTransactionValue: totalRevenue / totalTransactions,
                topProducts,
                worstProducts,
                productCount: Object.keys(productStats).length
            };
        }
        
        function displayBusinessAnalysis(analysis) {
            const resultsDiv = document.getElementById('analysisResults');
            
            let html = `
                <div class="analysis-section">
                    <h3>💼 Бизнес анализ и препоръки</h3>
                    
                    <div class="business-insight revenue">
                        <h4>💰 Финансов преглед:</h4>
                        <ul>
                            <li><strong>Общ оборот:</strong> ${analysis.totalRevenue.toFixed(2)} лв.</li>
                            <li><strong>Общо транзакции:</strong> ${analysis.totalTransactions} бр.</li>
                            <li><strong>Средна стойност на транзакция:</strong> ${analysis.avgTransactionValue.toFixed(2)} лв.</li>
                            <li><strong>Брой различни продукти:</strong> ${analysis.productCount} бр.</li>
                        </ul>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>⭐ Най-печеливши продукти:</h4>
                        <div class="product-list">
            `;
            
            analysis.topProducts.forEach(([product, stats], index) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        <strong>${index + 1}. ${icon} ${product}</strong><br>
                        <small>Оборот: ${stats.totalRevenue.toFixed(2)} лв. | Продажби: ${stats.count} бр. | Дял: ${stats.marketShare.toFixed(1)}%</small>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight products">
                        <h4>⚠️ Слабо продавани продукти:</h4>
                        <div class="product-list">
            `;
            
            analysis.worstProducts.forEach(([product, stats]) => {
                const icon = getProductIcon(product);
                html += `
                    <div class="product-item">
                        ${icon} ${product} - само ${stats.count} бр. продажби
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="business-insight recommendation">
                        <h4>🎯 Конкретни препоръки за действие:</h4>
                        <ul>
                            <li><strong>Фокус върху топ продуктите:</strong> Увеличете рекламата и наличността на ${analysis.topProducts.slice(0, 3).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>Преосмислете слабите продукти:</strong> Намалете или премахнете от асортимента ${analysis.worstProducts.slice(0, 2).map(([product]) => getProductIcon(product) + ' ' + product).join(', ')}</li>
                            <li><strong>Анализ на ценообразуването:</strong> Проверете цените на топ продуктите - може да имате възможност за увеличение</li>
                            <li><strong>Управление на запасите:</strong> Осигурете достатъчно количества от печелившите продукти</li>
                            <li><strong>Маркетингова стратегия:</strong> Насочете рекламния бюджет към продуктите с най-висок оборот</li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Save to history
            const summaryText = `Бизнес анализ: Оборот ${analysis.totalRevenue.toFixed(2)} лв., ${analysis.totalTransactions} транзакции, ${analysis.productCount} продукта`;
            const contentText = document.getElementById('analysisResults').textContent || '';
            saveToHistory('💼 Бизнес анализ', contentText, summaryText);
        }
        
        // Export functions - FIXED VERSION
        function exportToPDF() {
            try {
                // Show loading message
                showLoading('Подготвяне на PDF принтиране...');
                
                // Hide the loading after a short delay
                setTimeout(() => {
                    hideLoading();
                    
                    // Show user-friendly message
                    showMessage('PDF принтирането ще започне след секунда. Изберете "Запази като PDF" в диалога за принтиране! 🖨️', 'info');
                    
                    // Delay print dialog to give user time to read message
                    setTimeout(() => {
                        // Open browser's native print dialog
                        window.print();
                    }, 1500);
                    
                }, 800);
                
            } catch (error) {
                hideLoading();
                showError('Грешка при PDF принтиране: ' + error.message);
                console.error('PDF Print Error:', error);
            }
        }
        
        // Simplified download function
        function downloadFile(url, filename) {
            try {
                hideLoading();
                
                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // Add to DOM, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                showMessage(`Файлът "${filename}" е изтеглен успешно! 📁`, 'success');
                
                // Cleanup URL after delay
                setTimeout(() => {
                    try {
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        console.warn('URL cleanup error:', e);
                    }
                }, 1000);
                
                console.log('Download completed:', filename);
                
            } catch (error) {
                hideLoading();
                console.error('Download error:', error);
                showError('Грешка при изтегляне: ' + error.message);
            }
        }
        
        function exportToExcel() {
            try {
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined') {
                    showError('Excel библиотеката не е заредена. Моля, презаредете страницата.');
                    return;
                }
                
                if (!processedData) {
                    showError('Няма данни за експорт.');
                    return;
                }
                
                showLoading('Генериране на Excel файл...');
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add main data sheet
                const ws = XLSX.utils.json_to_sheet(processedData.data);
                XLSX.utils.book_append_sheet(wb, ws, 'Данни');
                
                // Add summary sheet
                const summaryData = [
                    ['Обобщение на данните'],
                    ['Общо записи (брой)', processedData.data.length],
                    ['Брой колони (брой)', processedData.headers.length],
                    ['Дата на експорт', new Date().toLocaleDateString('bg-BG')]
                ];
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Обобщение');
                
                // Generate file
                const filename = `BI_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                const excelBlob = new Blob([XLSX.write(wb, { bookType: 'xlsx', type: 'array' })], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                const url = window.URL.createObjectURL(excelBlob);
                console.log('Excel generated successfully:', filename, 'Size:', excelBlob.size, 'bytes');
                downloadFile(url, filename);
                
            } catch (error) {
                showError('Грешка при генериране на Excel: ' + error.message);
                console.error('Excel Export Error:', error);
            }
        }
    </script>
</body>
</html>