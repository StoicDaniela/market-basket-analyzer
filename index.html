<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Analyzer - –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</title>
    
    <!-- MULTIPLE CDN FALLBACKS FOR BULLETPROOF LOADING -->
    
    <!-- XLSX Library - Multiple CDNs -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>
    <script>
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"><\/script>');
        }
    </script>
    
    <!-- jsPDF Library - Multiple CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        if (typeof jsPDF === 'undefined') {
            document.write('<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>');
        }
    </script>
    <script>
        if (typeof jsPDF === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>');
        }
    </script>
    
    <!-- html2canvas Library - Multiple CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        if (typeof html2canvas === 'undefined') {
            document.write('<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>');
        }
    </script>
    <script>
        if (typeof html2canvas === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>');
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6; color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px; margin: 0 auto; padding: 20px;
            background: white; margin-top: 20px; margin-bottom: 20px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center; margin-bottom: 40px; padding: 30px 0;
            background: linear-gradient(135deg, #4a90e2 0%, #50c9c3 100%);
            border-radius: 15px; color: white;
        }
        .header h1 {
            font-size: 2.5em; margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .upload-section {
            background: #f8f9fa; padding: 30px; border-radius: 15px;
            margin-bottom: 30px; border: 2px dashed #007bff;
            text-align: center; transition: all 0.3s ease;
        }
        .upload-section:hover {
            border-color: #0056b3; background: #e3f2fd;
        }
        .file-input-wrapper {
            position: relative; display: inline-block; margin: 20px 0;
        }
        .file-input { display: none; }
        .file-input-label {
            background: #007bff; color: white; padding: 15px 30px;
            border-radius: 25px; cursor: pointer; font-size: 1.1em;
            transition: all 0.3s ease; display: inline-block;
        }
        .file-input-label:hover {
            background: #0056b3; transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .demo-button {
            background: #28a745; color: white; padding: 12px 25px;
            border: none; border-radius: 20px; cursor: pointer;
            font-size: 1em; margin: 10px; transition: all 0.3s ease;
        }
        .demo-button:hover {
            background: #218838; transform: translateY(-2px);
        }
        .btn {
            background: #dc3545; color: white; padding: 12px 25px;
            border: none; border-radius: 20px; cursor: pointer;
            font-size: 1em; margin: 10px; transition: all 0.3s ease;
        }
        .btn:hover {
            background: #c82333; transform: translateY(-2px);
        }
        .analysis-section {
            background: #f8f9fa; padding: 30px; border-radius: 15px;
            margin-bottom: 30px; border-left: 5px solid #007bff;
        }
        .section-title {
            color: #007bff; font-size: 1.5em; margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef; padding-bottom: 10px;
        }
        .metric-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .metric-card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 4px solid #007bff;
        }
        .metric-value {
            font-size: 2em; font-weight: bold; color: #007bff; margin-bottom: 5px;
        }
        .metric-label { color: #666; font-size: 0.9em; }
        .notification {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            padding: 15px 25px; border-radius: 10px; color: white;
            font-weight: bold; transition: all 0.3s ease;
        }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #000; }
        .rules-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            background: white; border-radius: 10px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .rules-table th, .rules-table td {
            padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;
        }
        .rules-table th {
            background: #007bff; color: white; font-weight: bold;
        }
        .rules-table tr:hover { background: #f8f9fa; }
        .export-buttons {
            text-align: center; margin: 30px 0;
        }
        .progress-container {
            background: #e9ecef; border-radius: 10px; padding: 3px; margin: 20px 0;
        }
        .progress-bar {
            background: linear-gradient(45deg, #007bff, #0056b3);
            height: 20px; border-radius: 7px; transition: width 0.3s ease;
            text-align: center; color: white; font-size: 0.8em; line-height: 20px;
        }
        .history-section {
            background: #f8f9fa; padding: 20px; border-radius: 10px;
            margin-bottom: 20px; border-left: 4px solid #28a745;
        }
        .history-item {
            background: white; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .history-item:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .history-actions {
            text-align: right; margin-top: 10px;
        }
        .history-actions button {
            background: #007bff; color: white; border: none;
            padding: 5px 10px; border-radius: 5px; cursor: pointer;
            margin-left: 5px; font-size: 0.9em;
        }
        .history-actions button:hover { background: #0056b3; }
        .delete-btn { background: #dc3545 !important; }
        .delete-btn:hover { background: #c82333 !important; }
        .file-info {
            background: #e8f4fd; padding: 15px; border-radius: 10px;
            margin-bottom: 20px; border-left: 4px solid #007bff;
        }
        
        /* ERROR MODAL STYLES */
        .error-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 10000; display: none;
            justify-content: center; align-items: center;
        }
        .error-modal-content {
            background: white; padding: 30px; border-radius: 15px;
            max-width: 500px; width: 90%; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .error-modal-title {
            color: #dc3545; font-size: 1.5em; margin-bottom: 15px;
            font-weight: bold;
        }
        .error-modal-text {
            margin-bottom: 20px; font-size: 1.1em; line-height: 1.5;
        }
        .error-modal-close {
            background: #007bff; color: white; border: none;
            padding: 10px 25px; border-radius: 5px; cursor: pointer;
            font-size: 1em;
        }
        .error-modal-close:hover { background: #0056b3; }
        
        /* LIBRARY STATUS INDICATOR */
        .library-status {
            background: #f8f9fa; padding: 15px; border-radius: 10px;
            margin-bottom: 20px; font-size: 0.9em;
        }
        .library-ok { color: #28a745; }
        .library-error { color: #dc3545; }
    </style>
</head>
<body>
    <!-- ERROR MODAL -->
    <div id="errorModal" class="error-modal">
        <div class="error-modal-content">
            <div class="error-modal-title">‚ö†Ô∏è –ì—Ä–µ—à–∫–∞</div>
            <div id="errorModalText" class="error-modal-text"></div>
            <button class="error-modal-close" onclick="closeErrorModal()">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üõí Market Basket Analyzer</h1>
            <p>–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞ –∑–∞ –±–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
        </div>

        <!-- Library Status Display -->
        <div id="libraryStatus" class="library-status">
            üîÑ –ü—Ä–æ–≤–µ—Ä—è–≤–∞–Ω–µ –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏—Ç–µ...
        </div>

        <div class="upload-section">
            <h3>üìä –ö–∞—á–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏</h3>
            <p>–ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏ —Ñ–æ—Ä–º–∞—Ç–∏: CSV, Excel (.xlsx)</p>
            
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx" onchange="handleFile(event)">
                <label for="fileInput" class="file-input-label">üìÅ –ò–∑–±–µ—Ä–∏ —Ñ–∞–π–ª</label>
            </div>
            
            <div>
                <button class="demo-button" onclick="loadDemoData()">üéØ –î–µ–º–æ –¥–∞–Ω–Ω–∏</button>
                <button class="btn" onclick="showHistory()">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
            </div>
        </div>

        <div class="export-buttons" style="display: none;" id="exportButtons">
            <button class="btn" onclick="exportToPDF()">üìë –ï–∫—Å–ø–æ—Ä—Ç PDF</button>
            <button class="btn" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
        </div>

        <div id="analysisResult"></div>
        <div id="historySection" style="display: none;"></div>
    </div>

    <div id="notification" class="notification" style="display: none;"></div>

    <script>
        console.log('üöÄ JavaScript starting...');
        
        let processedData = null;
        let currentAnalysisResult = null;
        let librariesLoaded = false;

        function updateLibraryStatus() {
            const statusDiv = document.getElementById('libraryStatus');
            const missing = [];
            const loaded = [];
            
            if (typeof XLSX !== 'undefined') {
                loaded.push('‚úÖ XLSX (Excel export)');
            } else {
                missing.push('‚ùå XLSX (Excel export)');
            }
            
            if (typeof jsPDF !== 'undefined') {
                loaded.push('‚úÖ jsPDF (PDF generation)');
            } else {
                missing.push('‚ùå jsPDF (PDF generation)');
            }
            
            if (typeof html2canvas !== 'undefined') {
                loaded.push('‚úÖ html2canvas (PDF screenshots)');
            } else {
                missing.push('‚ùå html2canvas (PDF screenshots)');
            }
            
            const allLoaded = missing.length === 0;
            librariesLoaded = allLoaded;
            
            if (allLoaded) {
                statusDiv.innerHTML = '<span class="library-ok">üéâ –í—Å–∏—á–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å–∞ –∑–∞—Ä–µ–¥–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ!</span>';
                statusDiv.style.display = 'none'; // Hide when all OK
            } else {
                statusDiv.innerHTML = 
                    '<div><strong>–°—Ç–∞—Ç—É—Å –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏—Ç–µ:</strong></div>' +
                    loaded.map(lib => '<div class="library-ok">' + lib + '</div>').join('') +
                    missing.map(lib => '<div class="library-error">' + lib + '</div>').join('') +
                    '<div style="margin-top:10px; font-size:0.8em; color:#666;">–û–ø—Ä–µ—Å–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –∞–∫–æ –∏–º–∞ –ø—Ä–æ–±–ª–µ–º–∏.</div>';
            }
            
            return allLoaded;
        }

        function showErrorModal(title, message) {
            console.log('üì¢ Showing error modal:', title, message);
            document.getElementById('errorModalText').innerHTML = '<strong>' + title + '</strong><br><br>' + message;
            document.getElementById('errorModal').style.display = 'flex';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function checkLibraries() {
            const allLoaded = updateLibraryStatus();
            
            if (!allLoaded) {
                const missing = [];
                if (typeof XLSX === 'undefined') missing.push('XLSX (Excel export)');
                if (typeof jsPDF === 'undefined') missing.push('jsPDF (PDF generation)');
                if (typeof html2canvas === 'undefined') missing.push('html2canvas (PDF screenshots)');
                
                if (missing.length > 0) {
                    showErrorModal('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ —Å–∞ –∑–∞—Ä–µ–¥–µ–Ω–∏', 
                        '–°–ª–µ–¥–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ —Å–∞ –∑–∞—Ä–µ–¥–µ–Ω–∏:<br><br>' +
                        missing.map(lib => '‚Ä¢ ' + lib).join('<br>') + 
                        '<br><br>–ú–æ–ª—è, –æ–ø—Ä–µ—Å–Ω–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å–∏.');
                    return false;
                }
            }
            
            console.log('‚úÖ All libraries loaded successfully');
            return true;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üìÅ File selected:', file.name, file.type, file.size);
            showNotification('–û–±—Ä–∞–±–æ—Ç–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseData(e.target.result, file.name);
                } catch (error) {
                    console.error('‚ùå File processing error:', error);
                    showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Ñ–∞–π–ª', error.message);
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else if (file.name.toLowerCase().endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
            }
        }

        function loadDemoData() {
            console.log('üéØ Loading demo data...');
            showNotification('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–µ–º–æ –¥–∞–Ω–Ω–∏...', 'success');
            
            fetch('demo_market_basket_data.csv')
                .then(response => response.text())
                .then(data => {
                    parseData(data, 'demo_market_basket_data.csv');
                })
                .catch(error => {
                    console.error('‚ùå Demo data error:', error);
                    showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–µ–º–æ –¥–∞–Ω–Ω–∏', '–ù–µ –º–æ–≥–∞ –¥–∞ –∑–∞—Ä–µ–¥—è –¥–µ–º–æ —Ñ–∞–π–ª–∞. –ú–æ–ª—è, –∫–∞—á–µ—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω —Ñ–∞–π–ª.');
                });
        }

        function parseData(data, fileName) {
            console.log('üìä Parsing data for file:', fileName);
            
            try {
                let parsedData;
                
                if (fileName.toLowerCase().endsWith('.xlsx')) {
                    if (!checkLibraries()) return;
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    parsedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                } else {
                    parsedData = data.split('\n').map(row => 
                        row.split(',').map(cell => cell.trim().replace(/"/g, ''))
                    ).filter(row => row.length > 1 && row.some(cell => cell.length > 0));
                }

                if (parsedData.length < 2) {
                    throw new Error('–§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ –ø–æ–Ω–µ 2 —Ä–µ–¥–∞ (–∑–∞–≥–ª–∞–≤–∏–µ + –¥–∞–Ω–Ω–∏)');
                }

                const headers = parsedData[0];
                const dataRows = parsedData.slice(1);

                processedData = {
                    fileName: fileName,
                    headers: headers,
                    data: dataRows,
                    uploadTime: new Date().toISOString()
                };

                console.log('‚úÖ Data parsed successfully. Rows:', dataRows.length, 'Columns:', headers.length);
                displayFileInfo();
                performAnalysis();
                
            } catch (error) {
                console.error('‚ùå Parse error:', error);
                showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª', error.message);
            }
        }

        function displayFileInfo() {
            const fileInfo = `
                <div class="file-info">
                    <h3>üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ñ–∞–π–ª–∞</h3>
                    <p><strong>–ò–º–µ:</strong> ${processedData.fileName}</p>
                    <p><strong>–ó–∞–ø–∏—Å–∏:</strong> ${processedData.data.length}</p>
                    <p><strong>–ö–æ–ª–æ–Ω–∏:</strong> ${processedData.headers.length}</p>
                    <p><strong>–ó–∞—Ä–µ–¥–µ–Ω–æ:</strong> ${new Date(processedData.uploadTime).toLocaleString('bg-BG')}</p>
                </div>
            `;
            
            document.getElementById('analysisResult').innerHTML = fileInfo;
            document.getElementById('exportButtons').style.display = 'block';
        }

        function performAnalysis() {
            console.log('üîç Starting market basket analysis...');
            showNotification('–ò–∑–≤—ä—Ä—à–≤–∞–Ω–µ –Ω–∞ Market Basket –∞–Ω–∞–ª–∏–∑...', 'success');

            try {
                const transactions = processedData.data.map(row => {
                    return row.filter(item => item && item.trim() !== '').map(item => item.trim());
                }).filter(transaction => transaction.length > 0);

                const itemFrequency = {};
                const pairFrequency = {};
                const totalTransactions = transactions.length;

                transactions.forEach(transaction => {
                    const uniqueItems = [...new Set(transaction)];
                    
                    uniqueItems.forEach(item => {
                        itemFrequency[item] = (itemFrequency[item] || 0) + 1;
                    });

                    for (let i = 0; i < uniqueItems.length; i++) {
                        for (let j = i + 1; j < uniqueItems.length; j++) {
                            const pair = [uniqueItems[i], uniqueItems[j]].sort().join(' ‚Üí ');
                            pairFrequency[pair] = (pairFrequency[pair] || 0) + 1;
                        }
                    }
                });

                const rules = Object.entries(pairFrequency).map(([pair, frequency]) => {
                    const [item1, item2] = pair.split(' ‚Üí ');
                    const support = frequency / totalTransactions;
                    const confidence1 = frequency / itemFrequency[item1];
                    const confidence2 = frequency / itemFrequency[item2];
                    const lift = frequency / ((itemFrequency[item1] / totalTransactions) * (itemFrequency[item2] / totalTransactions));

                    return {
                        antecedent: item1,
                        consequent: item2,
                        support: support,
                        confidence: Math.max(confidence1, confidence2),
                        lift: lift / totalTransactions,
                        frequency: frequency
                    };
                }).sort((a, b) => b.lift - a.lift);

                const topItems = Object.entries(itemFrequency)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                currentAnalysisResult = {
                    totalTransactions,
                    uniqueItems: Object.keys(itemFrequency).length,
                    averageBasketSize: transactions.reduce((sum, t) => sum + t.length, 0) / transactions.length,
                    topItems,
                    rules: rules.slice(0, 20),
                    generatedAt: new Date().toISOString()
                };

                displayAnalysisResults();
                saveToHistory();

            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑', error.message);
            }
        }

        function displayAnalysisResults() {
            const results = currentAnalysisResult;
            
            const html = `
                <div class="analysis-section">
                    <h2 class="section-title">üìä –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –∞–Ω–∞–ª–∏–∑–∞</h2>
                    
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-value">${results.totalTransactions}</div>
                            <div class="metric-label">–û–±—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${results.uniqueItems}</div>
                            <div class="metric-label">–£–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${results.averageBasketSize.toFixed(1)}</div>
                            <div class="metric-label">–°—Ä–µ–¥–Ω–∞ –∫–æ—à–Ω–∏—Ü–∞</div>
                        </div>
                    </div>

                    <h3>üèÜ –ù–∞–π-–ø–æ–ø—É–ª—è—Ä–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</h3>
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                <th>–ü–æ–∫—É–ø–∫–∏</th>
                                <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.topItems.map(([item, freq]) => `
                                <tr>
                                    <td>${item}</td>
                                    <td>${freq}</td>
                                    <td>${((freq / results.totalTransactions) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <h3>üîó –ê—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞</h3>
                    <table class="rules-table">
                        <thead>
                            <tr>
                                <th>–ê–∫–æ –∫—É–ø–∏</th>
                                <th>–©–µ –∫—É–ø–∏ –∏</th>
                                <th>Support</th>
                                <th>Confidence</th>
                                <th>Lift</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.rules.map(rule => `
                                <tr>
                                    <td>${rule.antecedent}</td>
                                    <td>${rule.consequent}</td>
                                    <td>${(rule.support * 100).toFixed(2)}%</td>
                                    <td>${(rule.confidence * 100).toFixed(2)}%</td>
                                    <td>${rule.lift.toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <h3>üí° –ë–∏–∑–Ω–µ—Å –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h3>
                    <div class="analysis-section">
                        <ul>
                            <li><strong>–ö—Ä—ä—Å—Ç–æ—Å–∞–Ω–æ –ø—Ä–µ–ø–æ—Ä—ä—á–≤–∞–Ω–µ:</strong> –ü—Ä–µ–ø–æ—Ä—ä—á–≤–∞–π—Ç–µ ${results.rules[0]?.consequent || '—Å–≤—ä—Ä–∑–∞–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏'} –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∏, –∫–æ–∏—Ç–æ –∫—É–ø—É–≤–∞—Ç ${results.rules[0]?.antecedent || '–æ—Å–Ω–æ–≤–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏'}</li>
                            <li><strong>–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–∞–Ω–µ:</strong> –ü–æ—Å—Ç–∞–≤–µ—Ç–µ ${results.topItems[0]?.[0] || '–ø–æ–ø—É–ª—è—Ä–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏'} –Ω–∞ –≤–∏–¥–Ω–∏ –º–µ—Å—Ç–∞</li>
                            <li><strong>–ü—Ä–æ–º–æ—Ü–∏–∏:</strong> –°—ä–∑–¥–∞–π—Ç–µ –ø–∞–∫–µ—Ç–Ω–∏ –æ—Ñ–µ—Ä—Ç–∏ –∑–∞ —á–µ—Å—Ç–æ –∫—É–ø—É–≤–∞–Ω–∏ –∑–∞–µ–¥–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏</li>
                            <li><strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä:</strong> –û—Å–∏–≥—É—Ä–µ—Ç–µ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç —Ç–æ–ø ${Math.min(5, results.topItems.length)} –ø—Ä–æ–¥—É–∫—Ç–∞</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('analysisResult').innerHTML = html;
            showNotification('–ê–Ω–∞–ª–∏–∑—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ! üéâ', 'success');
        }

        function exportToPDF() {
            console.log('üìë Starting PDF export...');
            
            if (!processedData || !currentAnalysisResult) {
                showErrorModal('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç', '–ú–æ–ª—è, –ø—ä—Ä–≤–æ –Ω–∞–ø—Ä–∞–≤–µ—Ç–µ –∞–Ω–∞–ª–∏–∑ –Ω–∞ –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            if (!checkLibraries()) {
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF —Ñ–∞–π–ª...', 'success');
                
                // Get the analysis results element
                const element = document.getElementById('analysisResult');
                
                if (!element) {
                    throw new Error('–ù–µ –Ω–∞–º–∏—Ä–∞–º —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ—Ç –∞–Ω–∞–ª–∏–∑–∞');
                }
                
                html2canvas(element, {
                    scale: 1,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const doc = new jsPDF.jsPDF();
                    const imgData = canvas.toDataURL('image/png');
                    
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = doc.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    
                    const ratio = Math.min(pdfWidth / canvasWidth, pdfHeight / canvasHeight);
                    const imgWidth = canvasWidth * ratio;
                    const imgHeight = canvasHeight * ratio;
                    
                    const marginX = (pdfWidth - imgWidth) / 2;
                    const marginY = 10;
                    
                    doc.addImage(imgData, 'PNG', marginX, marginY, imgWidth, imgHeight);
                    
                    const fileName = `Market_Basket_Analysis_${processedData.fileName.replace(/\.[^/.]+$/, "")}_${new Date().getTime()}.pdf`;
                    doc.save(fileName);
                    
                    console.log('‚úÖ PDF export completed');
                    showNotification('PDF —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìÑ', 'success');
                    
                }).catch(error => {
                    console.error('‚ùå PDF Canvas Error:', error);
                    showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF', '–ù–µ –º–æ–≥–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤—è —Å–Ω–∏–º–∫–∞ –Ω–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ: ' + error.message);
                });
                
            } catch (error) {
                console.error('‚ùå PDF Export Error:', error);
                showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF', error.message);
            }
        }

        function exportToExcel() {
            console.log('üìä Starting Excel export...');
            
            if (!processedData || !currentAnalysisResult) {
                showErrorModal('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç', '–ú–æ–ª—è, –ø—ä—Ä–≤–æ –Ω–∞–ø—Ä–∞–≤–µ—Ç–µ –∞–Ω–∞–ª–∏–∑ –Ω–∞ –¥–∞–Ω–Ω–∏.');
                return;
            }
            
            if (!checkLibraries()) {
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª...', 'success');
                
                const wb = XLSX.utils.book_new();
                
                // Summary sheet
                const summaryData = [
                    ['Market Basket Analysis Report'],
                    ['–§–∞–π–ª:', processedData.fileName],
                    ['–î–∞—Ç–∞:', new Date().toLocaleString('bg-BG')],
                    [''],
                    ['–û–±—â–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', currentAnalysisResult.totalTransactions],
                    ['–£–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:', currentAnalysisResult.uniqueItems],
                    ['–°—Ä–µ–¥–Ω–∞ –∫–æ—à–Ω–∏—Ü–∞:', currentAnalysisResult.averageBasketSize.toFixed(2)],
                ];
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summarySheet, '–û–±–æ–±—â–µ–Ω–∏–µ');
                
                // Top items sheet
                const topItemsData = [
                    ['–ü—Ä–æ–¥—É–∫—Ç', '–ü–æ–∫—É–ø–∫–∏', '–ü—Ä–æ—Ü–µ–Ω—Ç'],
                    ...currentAnalysisResult.topItems.map(([item, freq]) => [
                        item, 
                        freq, 
                        ((freq / currentAnalysisResult.totalTransactions) * 100).toFixed(1) + '%'
                    ])
                ];
                
                const topItemsSheet = XLSX.utils.aoa_to_sheet(topItemsData);
                XLSX.utils.book_append_sheet(wb, topItemsSheet, '–¢–æ–ø –ø—Ä–æ–¥—É–∫—Ç–∏');
                
                // Rules sheet
                const rulesData = [
                    ['–ê–∫–æ –∫—É–ø–∏', '–©–µ –∫—É–ø–∏ –∏', 'Support %', 'Confidence %', 'Lift'],
                    ...currentAnalysisResult.rules.map(rule => [
                        rule.antecedent,
                        rule.consequent,
                        (rule.support * 100).toFixed(2),
                        (rule.confidence * 100).toFixed(2),
                        rule.lift.toFixed(3)
                    ])
                ];
                
                const rulesSheet = XLSX.utils.aoa_to_sheet(rulesData);
                XLSX.utils.book_append_sheet(wb, rulesSheet, '–ê—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞');
                
                const fileName = `Market_Basket_Analysis_${processedData.fileName.replace(/\.[^/.]+$/, "")}_${new Date().getTime()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                console.log('‚úÖ Excel export completed');
                showNotification('Excel —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìä', 'success');
                
            } catch (error) {
                console.error('‚ùå Excel Export Error:', error);
                showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel', error.message);
            }
        }

        function saveToHistory() {
            try {
                const historyData = JSON.parse(localStorage.getItem('marketBasketHistory') || '[]');
                
                const analysisRecord = {
                    id: Date.now(),
                    fileName: processedData.fileName,
                    uploadTime: processedData.uploadTime,
                    analysisTime: currentAnalysisResult.generatedAt,
                    summary: {
                        totalTransactions: currentAnalysisResult.totalTransactions,
                        uniqueItems: currentAnalysisResult.uniqueItems,
                        averageBasketSize: currentAnalysisResult.averageBasketSize,
                        topRule: currentAnalysisResult.rules[0] || null
                    }
                };
                
                historyData.unshift(analysisRecord);
                if (historyData.length > 20) historyData.splice(20);
                
                localStorage.setItem('marketBasketHistory', JSON.stringify(historyData));
                console.log('‚úÖ Analysis saved to history');
                
            } catch (error) {
                console.error('‚ùå History save error:', error);
            }
        }

        function showHistory() {
            try {
                const historyData = JSON.parse(localStorage.getItem('marketBasketHistory') || '[]');
                
                if (historyData.length === 0) {
                    showNotification('–ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞', 'warning');
                    return;
                }

                const historyHtml = `
                    <div class="history-section">
                        <h2 class="section-title">üìã –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ</h2>
                        ${historyData.map(record => `
                            <div class="history-item">
                                <h4>${record.fileName}</h4>
                                <p><strong>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–æ:</strong> ${new Date(record.analysisTime).toLocaleString('bg-BG')}</p>
                                <p><strong>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong> ${record.summary.totalTransactions} | <strong>–ü—Ä–æ–¥—É–∫—Ç–∏:</strong> ${record.summary.uniqueItems}</p>
                                ${record.summary.topRule ? `<p><strong>–¢–æ–ø –ø—Ä–∞–≤–∏–ª–æ:</strong> ${record.summary.topRule.antecedent} ‚Üí ${record.summary.topRule.consequent}</p>` : ''}
                                <div class="history-actions">
                                    <button onclick="viewAnalysis(${record.id})">üëÅÔ∏è –ü—Ä–µ–≥–ª–µ–¥</button>
                                    <button class="delete-btn" onclick="deleteFromHistory(${record.id})">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                document.getElementById('analysisResult').innerHTML = historyHtml;
                document.getElementById('exportButtons').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå History display error:', error);
                showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è', error.message);
            }
        }

        function viewAnalysis(id) {
            showNotification('–§—É–Ω–∫—Ü–∏—è—Ç–∞ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥ —â–µ –±—ä–¥–µ –¥–æ–±–∞–≤–µ–Ω–∞ —Å–∫–æ—Ä–æ', 'warning');
        }

        function deleteFromHistory(id) {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ –∞–Ω–∞–ª–∏–∑?')) return;
            
            try {
                const historyData = JSON.parse(localStorage.getItem('marketBasketHistory') || '[]');
                const filteredData = historyData.filter(record => record.id !== id);
                localStorage.setItem('marketBasketHistory', JSON.stringify(filteredData));
                showHistory();
                showNotification('–ê–Ω–∞–ª–∏–∑—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç –æ—Ç –∏—Å—Ç–æ—Ä–∏—è—Ç–∞', 'success');
                
            } catch (error) {
                console.error('‚ùå History delete error:', error);
                showErrorModal('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ', error.message);
            }
        }

        // Check libraries periodically and on page load
        function checkLibrariesPeriodically() {
            updateLibraryStatus();
            
            // If not all loaded, try again in 2 seconds
            if (!librariesLoaded) {
                setTimeout(checkLibrariesPeriodically, 2000);
            }
        }

        window.addEventListener('load', function() {
            console.log('‚úÖ JavaScript loaded successfully');
            checkLibrariesPeriodically();
        });
        
    </script>
</body>
</html>