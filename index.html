<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Analyzer - BI Dashboard</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 400px;
        }

        .login-box h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .login-box label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 10px;
        }

        .nav-tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .nav-tab.active, .nav-tab:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .file-upload {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }

        .file-upload.drag-over {
            border-color: #28a745;
            background: #f0fff4;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            font-size: 14px;
        }

        .file-input {
            display: none;
        }

        .parameters {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .parameter-group {
            margin-bottom: 25px;
        }

        .parameter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .parameter-range {
            width: 100%;
            margin-bottom: 10px;
        }

        .parameter-value {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid;
        }

        .alert-info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .alert-success {
            background: #e8f5e8;
            border-color: #28a745;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .results-container {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .results-tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .results-tab.active, .results-tab:hover {
            background: #667eea;
            color: white;
        }

        .combinations-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .combination-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .combination-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .combination-products {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .combination-metrics {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .metric {
            text-align: center;
            flex: 1;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .support-high { border-left: 5px solid #28a745; }
        .support-medium { border-left: 5px solid #ffc107; }
        .support-low { border-left: 5px solid #dc3545; }

        .network-container {
            width: 100%;
            height: 600px;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .network-svg {
            width: 100%;
            height: 100%;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e1e5e9;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #reports-content, #reports-content * {
                visibility: visible;
            }
            #reports-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .nav-tabs, .btn, .file-upload, .parameters {
                display: none !important;
            }
        }

        .tab-pane h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .tab-pane h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .tab-pane h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
    </style>

    <!-- Scripts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <h2>🔐 BI Dashboard</h2>
            <form id="login-form">
                <label for="username">Потребителско име:</label>
                <input type="text" id="username" name="username" required>
                
                <label for="password">Парола:</label>
                <input type="password" id="password" name="password" required>
                
                <button type="submit" class="login-btn">Влизане</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-container" class="container">
        <div class="header">
            <h1>📊 Market Basket Analyzer</h1>
            <p>Напреднал бизнес интелигентен анализ на пазарната кошница</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('upload')">📁 Качване на данни</button>
            <button class="nav-tab" onclick="showTab('analysis')">📊 Анализ</button>
            <button class="nav-tab" onclick="showTab('reports')">📄 Генериране на доклади</button>
        </div>

        <div class="content">
            <!-- Upload Tab -->
            <div id="upload-tab" class="tab-content active">
                <div class="tab-pane">
                    <h2>📁 Качване на данни</h2>
                    <div class="alert alert-info">
                        <strong>💡 Инструкции:</strong><br>
                        ✅ Качете CSV файл с данни за транзакциите<br>
                        ✅ Всеки ред представлява една транзакция<br>
                        ✅ Продуктите в транзакцията да са разделени със запетая<br>
                        ✅ Първият ред трябва да съдържа заглавия<br>
                        ✅ Поддържани формати: CSV<br>
                        ✅ Цветово кодирани комбинации според поддръжката<br>
                        ✅ Интерактивна мрежова диаграма за визуализация<br>
                        ✅ Експорт в Excel и PDF формати
                    </div>
                    
                    <div class="file-upload" onclick="document.getElementById('file-input').click()">
                        <div class="upload-icon">📤</div>
                        <div class="upload-text">Качете вашия CSV файл</div>
                        <div class="upload-hint">Кликнете тук или плъзнете файл</div>
                        <input type="file" id="file-input" class="file-input" accept=".csv" />
                    </div>
                    
                    <div id="file-status" style="display: none;" class="alert alert-success">
                        <strong>✅ Файлът е качен успешно!</strong>
                    </div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis-tab" class="tab-content">
                <div class="tab-pane">
                    <h2>📊 Конфигуриране на анализа</h2>
                    
                    <div class="parameters">
                        <h3>⚙️ Параметри за анализ</h3>
                        
                        <div class="parameter-group">
                            <label for="min-support">Минимална поддръжка: <span id="support-value" class="parameter-value">0.02</span></label>
                            <input type="range" id="min-support" class="parameter-range" min="0.01" max="0.5" step="0.01" value="0.02">
                        </div>
                        
                        <div class="parameter-group">
                            <label for="min-confidence">Минимална увереност: <span id="confidence-value" class="parameter-value">0.30</span></label>
                            <input type="range" id="min-confidence" class="parameter-range" min="0.1" max="1.0" step="0.05" value="0.30">
                        </div>
                        
                        <div class="parameter-group">
                            <label for="max-combinations">Максимален брой комбинации:</label>
                            <input type="number" id="max-combinations" min="5" max="100" value="20">
                        </div>
                        
                        <button class="btn" onclick="performMarketBasketAnalysis()">🚀 Стартиране на анализа</button>
                    </div>
                    
                    <div id="results-container" class="results-container">
                        <div class="results-tabs">
                            <button class="results-tab active" onclick="showResultsTab('combinations')">🛒 Топ комбинации</button>
                            <button class="results-tab" onclick="showResultsTab('network')">🌐 Мрежова диаграма</button>
                            <button class="results-tab" onclick="showResultsTab('statistics')">📈 Статистики</button>
                        </div>
                        
                        <div id="combinations-content" class="results-content">
                            <div id="combinations-list" class="combinations-grid"></div>
                        </div>
                        
                        <div id="network-content" class="results-content" style="display: none;">
                            <div id="network-chart" class="network-container"></div>
                        </div>
                        
                        <div id="statistics-content" class="results-content" style="display: none;">
                            <div id="statistics-grid" class="statistics-grid"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="tab-pane">
                    <h2>📄 Генериране на доклади</h2>
                    <div class="alert alert-info">
                        <strong>📊 Експортирайте вашите анализи</strong><br>
                        Изберете формат за сваляне на резултатите от анализа.
                    </div>
                    
                    <div id="export-buttons" style="margin-top: 30px;">
                        <h3>🎯 Експорт опции:</h3>
                        <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                            <button class="btn" onclick="exportToExcel()" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                                📊 Експорт в Excel
                            </button>
                            <button class="btn" onclick="printToPDF()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                🖨️ Принтирай като PDF
                            </button>
                        </div>
                        
                        <div id="export-status" style="margin-top: 20px; display: none;" class="alert alert-success">
                            <strong>✅ Експортът е готов!</strong>
                        </div>
                    </div>

                    <div id="reports-content" style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>💡 Инструкции:</h4>
                        <ul style="margin-top: 10px; line-height: 1.8;">
                            <li><strong>📊 Excel експорт:</strong> Сваля файл с всички комбинации и техните метрики</li>
                            <li><strong>🖨️ PDF експорт:</strong> Отваря диалог за принтиране - изберете "Save as PDF"</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = null;
        let currentResults = null;

        // Login functionality
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'password') {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                console.log('🎉 Login successful! All features activated!');
            } else {
                alert('❌ Грешно потребителско име или парола!');
                document.getElementById('login-container').style.display = 'flex';
            }
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        function showResultsTab(tabName) {
            // Hide all results content
            document.querySelectorAll('.results-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all results tabs
            document.querySelectorAll('.results-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content
            document.getElementById(tabName + '-content').style.display = 'block';
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Redraw network if needed
            if (tabName === 'network' && currentResults) {
                drawNetworkChart(currentResults);
            }
        }

        // File upload handling
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        });

        function handleFileUpload(file) {
            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                reader.onload = function(e) {
                    currentData = e.target.result;
                    console.log('✅ CSV file loaded successfully');
                    
                    document.getElementById('file-status').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('file-status').style.display = 'none';
                    }, 3000);
                };
                reader.readAsText(file);
            } else {
                alert('❌ Моля, качете CSV файл!');
            }
        }

        // Main analysis function
        function performMarketBasketAnalysis() {
            if (!currentData) {
                alert('⚠️ Моля, първо качете CSV файл!');
                return;
            }

            console.log('🚀 Starting market basket analysis...');

            const minSupport = parseFloat(document.getElementById('min-support').value);
            const minConfidence = parseFloat(document.getElementById('min-confidence').value);
            const maxCombinations = parseInt(document.getElementById('max-combinations').value);

            console.log(`⚙️ Analysis parameters:
            - Min Support: ${minSupport}
            - Min Confidence: ${minConfidence}  
            - Max Combinations: ${maxCombinations}`);

            try {
                currentResults = analyzeMarketBasket(currentData, minSupport, minConfidence, maxCombinations);
                
                if (currentResults && currentResults.combinations && currentResults.combinations.length > 0) {
                    displayAnalysisResults(currentResults);
                    document.getElementById('results-container').style.display = 'block';
                    console.log('✅ Analysis completed successfully!');
                } else {
                    alert('⚠️ Няма намерени комбинации с текущите настройки.\n\n💡 Опитайте:\n• Намалете минималната поддръжка (под 5%)\n• Намалете минималната увереност (под 50%)\n• Увеличете броя комбинации');
                    console.log('⚠️ No combinations found with current settings');
                }
            } catch (error) {
                console.error('❌ Analysis error:', error);
                alert('❌ Грешка при анализа: ' + error.message);
            }
        }

        function analyzeMarketBasket(csvData, minSupport, minConfidence, maxCombinations) {
            console.log('🔍 Starting enhanced market basket analysis...');
            
            // Parse CSV data
            const lines = csvData.trim().split('\n');
            const transactions = [];
            const allProducts = new Set();

            lines.forEach((line, index) => {
                if (index === 0) return; // Skip header
                
                const transaction = [];
                const values = line.split(',');
                
                values.forEach(value => {
                    if (value && value.trim() !== '') {
                        const product = value.trim(); // Keep original case
                        allProducts.add(product);
                        transaction.push(product);
                    }
                });
                if (transaction.length > 0) {
                    transactions.push(transaction);
                }
            });

            const productsArray = Array.from(allProducts);
            console.log('📦 Unique products found:', productsArray.length);

            // Calculate support for individual items
            const itemSupport = {};
            productsArray.forEach(product => {
                const count = transactions.filter(transaction => transaction.includes(product)).length;
                itemSupport[product] = count / transactions.length;
            });

            // Filter items by minimum support
            const frequentItems = productsArray.filter(product => itemSupport[product] >= minSupport);
            console.log('⭐ Frequent items:', frequentItems.length);

            // Generate combinations and calculate support
            const combinations = [];
            
            // 2-item combinations
            for (let i = 0; i < frequentItems.length; i++) {
                for (let j = i + 1; j < frequentItems.length; j++) {
                    const combo = [frequentItems[i], frequentItems[j]];
                    const support = calculateSupport(transactions, combo);
                    const confidence = calculateConfidence(transactions, frequentItems[i], frequentItems[j]);
                    const lift = calculateLift(transactions, frequentItems[i], frequentItems[j]);
                    
                    if (support >= minSupport && confidence >= minConfidence) {
                        combinations.push({
                            items: combo,
                            support: support,
                            confidence: confidence,
                            lift: lift,
                            count: Math.round(support * transactions.length)
                        });
                    }
                }
            }

            // Sort by support * confidence
            combinations.sort((a, b) => (b.support * b.confidence) - (a.support * a.confidence));
            
            // Limit results
            const limitedCombinations = combinations.slice(0, maxCombinations);
            
            console.log(`📊 Found ${limitedCombinations.length} valid combinations`);
            
            return {
                combinations: limitedCombinations,
                data: transactions,
                products: productsArray,
                frequentItems: frequentItems,
                totalTransactions: transactions.length,
                uniqueProducts: productsArray.length,
                parameters: { minSupport, minConfidence, maxCombinations }
            };
        }

        function calculateSupport(transactions, itemset) {
            const count = transactions.filter(transaction => 
                itemset.every(item => transaction.includes(item))
            ).length;
            return count / transactions.length;
        }

        function calculateConfidence(transactions, antecedent, consequent) {
            const antecedentCount = transactions.filter(t => t.includes(antecedent)).length;
            const bothCount = transactions.filter(t => t.includes(antecedent) && t.includes(consequent)).length;
            return antecedentCount > 0 ? bothCount / antecedentCount : 0;
        }

        function calculateLift(transactions, itemA, itemB) {
            const supportA = calculateSupport(transactions, [itemA]);
            const supportB = calculateSupport(transactions, [itemB]);
            const supportAB = calculateSupport(transactions, [itemA, itemB]);
            return (supportA > 0 && supportB > 0) ? supportAB / (supportA * supportB) : 0;
        }

        function displayAnalysisResults(results) {
            // Display combinations
            displayCombinations(results.combinations);
            
            // Display statistics
            displayStatistics(results);
            
            // Draw network chart
            drawNetworkChart(results);
        }

        function displayCombinations(combinations) {
            const container = document.getElementById('combinations-list');
            container.innerHTML = '';

            if (combinations.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>⚠️ Няма намерени комбинации</strong><br>
                        Опитайте да намалите параметрите за анализа.
                    </div>
                `;
                return;
            }

            combinations.forEach((combo, index) => {
                const supportLevel = combo.support > 0.1 ? 'high' : combo.support > 0.05 ? 'medium' : 'low';
                
                const card = document.createElement('div');
                card.className = `combination-card support-${supportLevel}`;
                card.innerHTML = `
                    <div class="combination-products">
                        ${combo.items.map(item => `${getProductEmoji(item)} ${item}`).join(' + ')}
                    </div>
                    <div class="combination-metrics">
                        <div class="metric">
                            <div class="metric-value">${(combo.support * 100).toFixed(1)}%</div>
                            <div class="metric-label">Поддръжка</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${(combo.confidence * 100).toFixed(1)}%</div>
                            <div class="metric-label">Увереност</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${combo.lift.toFixed(2)}</div>
                            <div class="metric-label">Lift</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Enhanced product emojis function
        function getProductEmoji(productName) {
            const emojiMap = {
                'хляб': '🍞', 'мляко': '🥛', 'масло': '🧈', 'яйца': '🥚', 'сирене': '🧀',
                'кафе': '☕', 'чай': '🍵', 'захар': '🍯', 'сол': '🧂', 'ориз': '🍚',
                'макарони': '🍝', 'месо': '🥩', 'риба': '🐟', 'плодове': '🍎', 'зеленчуци': '🥬',
                'тоалетна хартия': '🧻', 'сапун': '🧼', 'шампоан': '🧴', 'pasta': '🍝', 'bread': '🍞'
            };
            return emojiMap[productName.toLowerCase()] || '🔸';
        }

        function displayStatistics(results) {
            const container = document.getElementById('statistics-grid');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${results.totalTransactions}</div>
                    <div class="stat-label">Общо транзакции</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.uniqueProducts}</div>
                    <div class="stat-label">Уникални продукти</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.combinations.length}</div>
                    <div class="stat-label">Намерени комбинации</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${results.frequentItems.length}</div>
                    <div class="stat-label">Чести продукти</div>
                </div>
            `;
        }

        function drawNetworkChart(results) {
            const container = d3.select('#network-chart');
            container.selectAll('*').remove();

            const width = 800;
            const height = 600;
            const svg = container.append('svg')
                .attr('class', 'network-svg')
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('width', '100%')
                .attr('height', '100%');

            // Create nodes from products
            const nodes = results.frequentItems.map(product => ({
                id: product,
                name: product,
                emoji: getProductEmoji(product) // NEW: Add emoji
            }));

            // Create links from combinations
            const links = results.combinations.map(combo => ({
                source: combo.items[0],
                target: combo.items[1],
                support: combo.support,
                confidence: combo.confidence,
                lift: combo.lift
            }));

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));

            // Add links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => Math.sqrt(d.support * 50));

            // Add nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('r', 20)
                .attr('fill', '#667eea')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add labels
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter().append('text')
                .text(d => `${d.emoji} ${d.name}`)
                .attr('font-size', '12px')
                .attr('font-family', 'Arial')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white');

            // Update positions on tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // Parameter change handlers
        document.getElementById('min-support').addEventListener('input', function() {
            document.getElementById('support-value').textContent = this.value;
        });

        document.getElementById('min-confidence').addEventListener('input', function() {
            document.getElementById('confidence-value').textContent = this.value;
        });

        // Export functions
        function exportToExcel() {
            if (!currentResults || !currentResults.combinations || currentResults.combinations.length === 0) {
                alert('⚠️ Няма данни за експортиране! Първо направете анализ.');
                return;
            }

            console.log('📊 Starting Excel export...');

            // Prepare data for Excel
            const excelData = currentResults.combinations.map((combo, index) => ({
                'Ред': index + 1,
                'Продукти': combo.items.join(' + '),
                'Поддръжка (%)': (combo.support * 100).toFixed(1),
                'Увереност (%)': (combo.confidence * 100).toFixed(1),
                'Lift': combo.lift.toFixed(2),
                'Брой транзакции': combo.count,
                'Общо транзакции': currentResults.data.length
            }));

            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Add some styling and auto-width
            const wscols = [
                { wch: 5 },   // Ред
                { wch: 30 },  // Продукти  
                { wch: 15 },  // Поддръжка
                { wch: 15 },  // Увереност
                { wch: 10 },  // Lift
                { wch: 18 },  // Брой транзакции
                { wch: 18 }   // Общо транзакции
            ];
            ws['!cols'] = wscols;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Анализ на кошница');

            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '');
            const filename = `market_basket_analysis_${timestamp}.xlsx`;

            // Save file
            XLSX.writeFile(wb, filename);

            console.log('✅ Excel file generated successfully:', filename);
            
            // Show success message
            const statusDiv = document.getElementById('export-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `<strong>✅ Excel файлът е изтеглен:</strong> ${filename}`;
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function printToPDF() {
            if (!currentResults || !currentResults.combinations || currentResults.combinations.length === 0) {
                alert('⚠️ Няма данни за принтиране! Първо направете анализ.');
                return;
            }

            console.log('🖨️ Opening print dialog for PDF generation...');
            
            // Show success message
            const statusDiv = document.getElementById('export-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <strong>🖨️ Отваря се диалогът за принтиране...</strong><br>
                Изберете "Save as PDF" или "Запази като PDF" от опциите за принтиране.
            `;
            
            // Open print dialog
            window.print();
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 8000);
        }

        // Initialize
        console.log('🚀 Bullet-proof version loaded with all enhancements!');
    </script>
</body>
</html>