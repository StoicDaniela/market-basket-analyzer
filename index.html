<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Basket Analyzer - –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #4a90e2 0%, #50c9c3 100%);
            border-radius: 15px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #007bff;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #0056b3;
            background: #e3f2fd;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            background: #007bff;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .file-input-label:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .btn-group {
            text-align: center;
            margin: 30px 0;
        }
        
        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            min-height: 100px;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        .product-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .product-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #28a745;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .product-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.95em;
        }
        
        .product-item:last-child {
            border-bottom: none;
        }
        
        .product-item span:first-child {
            font-weight: 500;
            color: #495057;
        }
        
        .product-item span:last-child {
            font-weight: bold;
            color: #28a745;
            background: #e8f5e8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        
        .business-insights {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #ffc107;
            margin: 20px 0;
        }
        
        .business-insights h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .insight-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            line-height: 1.5;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #dc3545;
            margin: 20px 0;
        }
        
        .error-message h4 {
            margin-bottom: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .history-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-title {
            font-weight: bold;
            color: #495057;
        }
        
        .history-time {
            font-size: 0.8em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Market Basket Analyzer</h1>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π—Ç–µ –≤—Ä—ä–∑–∫–∏—Ç–µ –º–µ–∂–¥—É –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ –≤—ä–≤ –≤–∞—à–∏—Ç–µ –¥–∞–Ω–Ω–∏</p>
        </div>
        
        <div class="upload-section">
            <h2>üìÇ –ö–∞—á–µ—Ç–µ CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏ –∑–∞ –ø—Ä–æ–¥–∞–∂–±–∏</h2>
            <p>–§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ –∫–æ–ª–æ–Ω–∏ –∑–∞ –ø—Ä–æ–¥—É–∫—Ç–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ –ø–æ—Ä—ä—á–∫–∏</p>
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="loadFile()">
                <label for="csvFile" class="file-input-label">
                    üìé –ò–∑–±–µ—Ä–µ—Ç–µ CSV —Ñ–∞–π–ª
                </label>
            </div>
            <br>
            <button class="btn" onclick="loadData()">üìä –ó–∞—Ä–µ–¥–∏ –¥–∞–Ω–Ω–∏—Ç–µ</button>
        </div>
        
        <div class="btn-group">
            <button class="btn" onclick="performMarketBasketAnalysis()">üîç Market Basket –ê–Ω–∞–ª–∏–∑</button>
            <button class="btn" onclick="exportToPDF()">üìë –ï–∫—Å–ø–æ—Ä—Ç PDF</button>
            <button class="btn" onclick="exportToExcel()">üìä –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
        </div>
        
        <div class="results-section">
            <div id="analysisResults">
                <p style="text-align: center; color: #666; font-style: italic;">
                    –ö–∞—á–µ—Ç–µ CSV —Ñ–∞–π–ª –∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ "Market Basket –ê–Ω–∞–ª–∏–∑" –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ
                </p>
            </div>
        </div>
        
        <div class="history-container">
            <h3>üìö –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ</h3>
            <div id="historyContainer">
                <p style="text-align: center; color: #666; font-style: italic;">
                    –í—Å–µ –æ—â–µ –Ω—è–º–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏
                </p>
            </div>
            <button class="btn" onclick="clearHistory()" style="background: #dc3545;">üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</button>
        </div>
    </div>

    <script>
        let processedData = null;
        let analysisHistory = [];
        
        // Safe storage wrapper for localStorage issues
        const SafeStorage = {
            isAvailable: (() => {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    console.warn('localStorage –Ω–µ–¥–æ—Å—Ç—ä–ø–µ–Ω, –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞ –ø–∞–º–µ—Ç');
                    return false;
                }
            })(),
            
            memoryStore: [],
            
            getItem: function(key) {
                if (this.isAvailable) {
                    return localStorage.getItem(key);
                } else {
                    return JSON.stringify(this.memoryStore);
                }
            },
            
            setItem: function(key, value) {
                if (this.isAvailable) {
                    localStorage.setItem(key, value);
                } else {
                    this.memoryStore = JSON.parse(value);
                }
            },
            
            removeItem: function(key) {
                if (this.isAvailable) {
                    localStorage.removeItem(key);
                } else {
                    this.memoryStore = [];
                }
            }
        };
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function loadFile() {
            const fileInput = document.getElementById('csvFile');
            const fileName = fileInput.files[0]?.name || '–ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —Ñ–∞–π–ª';
            showNotification(`–ò–∑–±—Ä–∞–Ω —Ñ–∞–π–ª: ${fileName}`, 'success');
        }
        
        function loadData() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ CSV —Ñ–∞–π–ª!', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error('–§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –ø–æ–Ω–µ –∑–∞–≥–ª–∞–≤–Ω–∏ —Ä–µ–¥–æ–≤–µ –∏ –µ–¥–∏–Ω —Ä–µ–¥ —Å –¥–∞–Ω–Ω–∏');
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].split(',').map(cell => cell.trim().replace(/"/g, ''));
                        if (row.length === headers.length) {
                            data.push(row);
                        }
                    }
                    
                    processedData = {
                        fileName: file.name,
                        headers: headers,
                        data: data
                    };
                    
                    showNotification(`‚úÖ –î–∞–Ω–Ω–∏ –∑–∞—Ä–µ–¥–µ–Ω–∏: ${data.length} –∑–∞–ø–∏—Å–∞, ${headers.length} –∫–æ–ª–æ–Ω–∏`, 'success');
                    
                } catch (error) {
                    console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ:', error);
                    showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        function performMarketBasketAnalysis() {
            if (!processedData) {
                showNotification('–ú–æ–ª—è, –ø—ä—Ä–≤–æ –∑–∞—Ä–µ–¥–µ—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω–∏!', 'warning');
                return;
            }
            
            try {
                const results = document.getElementById('analysisResults');
                let html = '<div class="chart-container">';
                html += '<h3 class="chart-title">üõí Market Basket –ê–Ω–∞–ª–∏–∑ - –ê–Ω–∞–ª–∏–∑ –Ω–∞ –ø–∞–∑–∞—Ä–Ω–∞—Ç–∞ –∫–æ—à–Ω–∏—Ü–∞</h3>';
                
                // Find product/item columns
                const productColumns = [];
                const transactionColumns = [];
                let productCounts = {}; // Move this outside the if block
                
                processedData.headers.forEach((header, index) => {
                    const lowerHeader = header.toLowerCase();
                    if (lowerHeader.includes('product') || lowerHeader.includes('item') || 
                        lowerHeader.includes('–∞—Ä—Ç–∏–∫—É–ª') || lowerHeader.includes('–ø—Ä–æ–¥—É–∫—Ç') ||
                        lowerHeader.includes('—Å—Ç–æ–∫–∞') || lowerHeader.includes('—Ç–æ–≤–∞—Ä')) {
                        productColumns.push({ name: header, index: index });
                    }
                    if (lowerHeader.includes('transaction') || lowerHeader.includes('order') || 
                        lowerHeader.includes('receipt') || lowerHeader.includes('–ø–æ—Ä—ä—á–∫–∞') ||
                        lowerHeader.includes('—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è') || lowerHeader.includes('—Ñ–∞–∫—Ç—É—Ä–∞')) {
                        transactionColumns.push({ name: header, index: index });
                    }
                });
                
                if (productColumns.length > 0) {
                    const productColumn = productColumns[0];
                    
                    // Count product frequencies
                    const totalTransactions = processedData.data.length;
                    
                    processedData.data.forEach(row => {
                        const product = row[productColumn.index];
                        if (product && product !== '') {
                            productCounts[product] = (productCounts[product] || 0) + 1;
                        }
                    });
                    
                    // Sort products by frequency
                    const sortedProducts = Object.entries(productCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 15); // Top 15 products
                    
                    html += '<div class="product-analysis">';
                    
                    // Top products card
                    html += '<div class="product-card">';
                    html += '<h4>üèÜ –ù–∞–π-–ø–æ–ø—É–ª—è—Ä–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</h4>';
                    sortedProducts.slice(0, 10).forEach(([product, count], index) => {
                        const percentage = ((count / totalTransactions) * 100).toFixed(1);
                        let emoji = 'üîπ';
                        if (index === 0) emoji = 'ü•á';
                        else if (index === 1) emoji = 'ü•à'; 
                        else if (index === 2) emoji = 'ü•â';
                        else if (index < 5) emoji = '‚≠ê';
                        else if (index < 8) emoji = 'üì¶';
                        else emoji = 'üõçÔ∏è';
                        
                        html += `<div class="product-item">
                                    <span>${emoji} ${product}</span>
                                    <span>${count} –ø—ä—Ç–∏ (${percentage}%)</span>
                                </div>`;
                    });
                    html += '</div>';
                    
                    // Statistics card
                    html += '<div class="product-card">';
                    html += '<h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ</h4>';
                    html += `<div class="product-item"><span>üõçÔ∏è –û–±—â–æ —É–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏:</span><span>${Object.keys(productCounts).length}</span></div>`;
                    html += `<div class="product-item"><span>üßæ –û–±—â–æ –∑–∞–ø–∏—Å–∏:</span><span>${totalTransactions}</span></div>`;
                    
                    const avgPerProduct = totalTransactions / Object.keys(productCounts).length;
                    html += `<div class="product-item"><span>üìà –°—Ä–µ–¥–Ω–æ –ø—Ä–æ–¥–∞–∂–±–∏ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç:</span><span>${avgPerProduct.toFixed(1)}</span></div>`;
                    
                    // Find products that appear together if we have transaction data
                    if (transactionColumns.length > 0) {
                        const transactionColumn = transactionColumns[0];
                        const transactions = {};
                        
                        processedData.data.forEach(row => {
                            const transactionId = row[transactionColumn.index];
                            const product = row[productColumn.index];
                            
                            if (transactionId && product) {
                                if (!transactions[transactionId]) {
                                    transactions[transactionId] = [];
                                }
                                if (!transactions[transactionId].includes(product)) {
                                    transactions[transactionId].push(product);
                                }
                            }
                        });
                        
                        const uniqueTransactions = Object.keys(transactions).length;
                        const avgItemsPerTransaction = Object.values(transactions).reduce((sum, items) => sum + items.length, 0) / uniqueTransactions;
                        
                        html += `<div class="product-item"><span>üîÑ –£–Ω–∏–∫–∞–ª–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</span><span>${uniqueTransactions}</span></div>`;
                        html += `<div class="product-item"><span>üõí –°—Ä–µ–¥–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–∏ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:</span><span>${avgItemsPerTransaction.toFixed(1)}</span></div>`;
                    }
                    
                    html += '</div>';
                    html += '</div>';
                    
                    // Business insights
                    html += '<div class="business-insights">';
                    html += '<h4>üí° –ë–∏–∑–Ω–µ—Å –ø—Ä–µ–ø–æ—Ä—ä–∫–∏</h4>';
                    
                    const topProduct = sortedProducts[0];
                    const topPercentage = ((topProduct[1] / totalTransactions) * 100).toFixed(1);
                    
                    html += `<div class="insight-item">
                                <strong>üéØ –í–æ–¥–µ—â –ø—Ä–æ–¥—É–∫—Ç:</strong> "${topProduct[0]}" –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–≤–∞ ${topPercentage}% –æ—Ç –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥–∞–∂–±–∏
                            </div>`;
                    
                    if (sortedProducts.length > 5) {
                        const top5Count = sortedProducts.slice(0, 5).reduce((sum, [,count]) => sum + count, 0);
                        const top5Percentage = ((top5Count / totalTransactions) * 100).toFixed(1);
                        html += `<div class="insight-item">
                                    <strong>üìà –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è:</strong> –¢–æ–ø 5 –ø—Ä–æ–¥—É–∫—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç ${top5Percentage}% –æ—Ç –ø—Ä–æ–¥–∞–∂–±–∏—Ç–µ
                                </div>`;
                    }
                    
                    const lowPerformers = sortedProducts.filter(([,count]) => count < 3).length;
                    if (lowPerformers > 0) {
                        html += `<div class="insight-item">
                                    <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> ${lowPerformers} –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–º–∞—Ç –ø–æ–¥ 3 –ø—Ä–æ–¥–∞–∂–±–∏ - –ø–æ–º–∏—Å–ª–µ—Ç–µ –∑–∞ –ø—Ä–æ–º–æ—Ü–∏–∏ –∏–ª–∏ –ø—Ä–µ–º–∞—Ö–≤–∞–Ω–µ
                                </div>`;
                    }
                    
                    html += '</div>';
                    
                } else {
                    html += '<div class="error-message">';
                    html += '<h4>‚ùå –ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏ –¥–∞–Ω–Ω–∏ –∑–∞ Market Basket –∞–Ω–∞–ª–∏–∑</h4>';
                    html += '<p>–ù–µ —Å–∞ –æ—Ç–∫—Ä–∏—Ç–∏ –∫–æ–ª–æ–Ω–∏ —Å –ø—Ä–æ–¥—É–∫—Ç–∏. –ó–∞ Market Basket –∞–Ω–∞–ª–∏–∑ —Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –∫–æ–ª–æ–Ω–∏ –∫–∞—Ç–æ:</p>';
                    html += '<ul>';
                    html += '<li>üõçÔ∏è "product", "item", "–ø—Ä–æ–¥—É–∫—Ç", "–∞—Ä—Ç–∏–∫—É–ª"</li>';
                    html += '<li>üßæ "transaction", "order", "–ø–æ—Ä—ä—á–∫–∞" (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</li>';
                    html += '</ul>';
                    html += '<p>–ú–æ–ª—è, —É–≤–µ—Ä–µ—Ç–µ —Å–µ —á–µ —Ñ–∞–π–ª—ä—Ç —Å—ä–¥—ä—Ä–∂–∞ —Ç–µ–∑–∏ —Ç–∏–ø–æ–≤–µ –¥–∞–Ω–Ω–∏.</p>';
                    html += '</div>';
                }
                
                html += '</div>';
                results.innerHTML = html;
                
                const productCount = productColumns.length > 0 ? Object.keys(productCounts || {}).length : 0;
                addToHistory('üõí Market Basket –∞–Ω–∞–ª–∏–∑', `–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏ ${productCount} —É–Ω–∏–∫–∞–ª–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –æ—Ç ${processedData.data.length} –∑–∞–ø–∏—Å–∞`);
                showNotification('Market Basket –∞–Ω–∞–ª–∏–∑—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω! üõí', 'success');
                
            } catch (error) {
                console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ Market Basket –∞–Ω–∞–ª–∏–∑:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'error');
            }
        }
        
        function exportToPDF() {
            if (!processedData) {
                showNotification('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!', 'warning');
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF —Ñ–∞–π–ª...', 'success');
                console.log('–ó–∞–ø–æ—á–≤–∞ PDF –µ–∫—Å–ø–æ—Ä—Ç...');
                
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞');
                }
                
                const doc = new jsPDF();
                console.log('jsPDF –µ –≥–æ—Ç–æ–≤');
                
                // Safe text function 
                const safeText = (text, x, y) => {
                    try {
                        let cleanText = '';
                        if (text === null || text === undefined) {
                            cleanText = '';
                        } else {
                            cleanText = String(text)
                                .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Remove control characters
                                .replace(/[^\x00-\x7F]/g, '?') // Replace non-ASCII with ?
                                .trim();
                        }
                        
                        if (cleanText.length > 0 && typeof x === 'number' && typeof y === 'number') {
                            doc.text(cleanText, x, y);
                            return true;
                        }
                        return false;
                    } catch (e) {
                        console.warn('PDF text error:', e);
                        return false;
                    }
                };
                
                // Add content to PDF
                let yPos = 20;
                
                // Title
                doc.setFontSize(18);
                safeText('Market Basket Analysis Report', 20, yPos);
                yPos += 15;
                
                // Date
                doc.setFontSize(12);
                const dateStr = new Date().toLocaleString('bg-BG');
                safeText(`Date: ${dateStr}`, 20, yPos);
                yPos += 15;
                
                // File info
                doc.setFontSize(14);
                safeText('File Information:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                safeText(`File: ${processedData.fileName}`, 20, yPos);
                yPos += 8;
                safeText(`Records: ${processedData.data.length}`, 20, yPos);
                yPos += 8;
                safeText(`Columns: ${processedData.headers.length}`, 20, yPos);
                yPos += 15;
                
                // Headers
                if (processedData.headers && processedData.headers.length > 0) {
                    doc.setFontSize(12);
                    safeText('Data Columns:', 20, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(9);
                    const headersList = processedData.headers.slice(0, 10).join(', ');
                    safeText(headersList, 20, yPos);
                    yPos += 10;
                    
                    if (processedData.headers.length > 10) {
                        safeText(`... and ${processedData.headers.length - 10} more columns`, 20, yPos);
                        yPos += 10;
                    }
                }
                
                // Generate blob and download
                const pdfBlob = doc.output('blob');
                console.log('PDF blob —Å—ä–∑–¥–∞–¥–µ–Ω, —Ä–∞–∑–º–µ—Ä:', pdfBlob.size);
                
                if (pdfBlob && pdfBlob.size > 0) {
                    console.log('–ó–∞–ø–æ—á–≤–∞ download...');
                    // Create download link with better browser compatibility
                    const url = URL.createObjectURL(pdfBlob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = `Market_Basket_Analysis_${new Date().getTime()}.pdf`;
                    downloadLink.style.display = 'none';
                    
                    // Add to DOM, click, then remove
                    document.body.appendChild(downloadLink);
                    console.log('Download link –¥–æ–±–∞–≤–µ–Ω –∫—ä–º DOM');
                    
                    // Force the download
                    downloadLink.click();
                    console.log('Download click triggered');
                    
                    // Wait a bit before cleanup
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                        console.log('Download cleanup –∑–∞–≤—ä—Ä—à–µ–Ω');
                    }, 100);
                    
                    showNotification('PDF —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìÑ –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ø–∞–ø–∫–∞—Ç–∞ Downloads', 'success');
                    addToHistory('üìÑ PDF –µ–∫—Å–ø–æ—Ä—Ç', `–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω PDF –æ—Ç—á–µ—Ç –∑–∞ "${processedData.fileName}"`);
                } else {
                    throw new Error('PDF –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ—Ç–æ –µ –Ω–µ—É—Å–ø–µ—à–Ω–æ - –ø—Ä–∞–∑–µ–Ω —Ñ–∞–π–ª');
                }
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF: ' + error.message, 'error');
            }
        }
        
        function exportToExcel() {
            if (!processedData) {
                showNotification('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!', 'warning');
                return;
            }
            
            try {
                showNotification('–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel —Ñ–∞–π–ª...', 'success');
                console.log('–ó–∞–ø–æ—á–≤–∞ Excel –µ–∫—Å–ø–æ—Ä—Ç...');
                
                if (!XLSX) {
                    throw new Error('XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞');
                }
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                console.log('Excel workbook —Å—ä–∑–¥–∞–¥–µ–Ω');
                
                // Prepare data for Excel
                const excelData = [];
                
                // Add headers
                if (processedData.headers) {
                    excelData.push(processedData.headers);
                }
                
                // Add data rows
                if (processedData.data) {
                    processedData.data.forEach(row => {
                        excelData.push(row);
                    });
                }
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                
                // Create summary worksheet
                const summaryData = [
                    ['Market Basket Analysis Summary'],
                    [''],
                    ['File', processedData.fileName || 'Unknown'],
                    ['Export Date', new Date().toLocaleString('bg-BG')],
                    ['Total Records', processedData.data ? processedData.data.length : 0],
                    ['Total Columns', processedData.headers ? processedData.headers.length : 0],
                    [''],
                    ['Columns:']
                ];
                
                // Add column names
                if (processedData.headers) {
                    processedData.headers.forEach((header, index) => {
                        summaryData.push([`${index + 1}.`, header]);
                    });
                }
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
                
                // Generate file and download
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const excelBlob = new Blob([excelBuffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                console.log('Excel blob —Å—ä–∑–¥–∞–¥–µ–Ω, —Ä–∞–∑–º–µ—Ä:', excelBlob.size);
                
                console.log('–ó–∞–ø–æ—á–≤–∞ Excel download...');
                // Create download link with better browser compatibility
                const url = URL.createObjectURL(excelBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `Market_Basket_Analysis_${new Date().getTime()}.xlsx`;
                downloadLink.style.display = 'none';
                
                // Add to DOM, click, then remove
                document.body.appendChild(downloadLink);
                console.log('Excel download link –¥–æ–±–∞–≤–µ–Ω –∫—ä–º DOM');
                
                // Force the download
                downloadLink.click();
                console.log('Excel download click triggered');
                
                // Wait a bit before cleanup
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    console.log('Excel download cleanup –∑–∞–≤—ä—Ä—à–µ–Ω');
                }, 100);
                
                showNotification('Excel —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ! üìä –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ø–∞–ø–∫–∞—Ç–∞ Downloads', 'success');
                addToHistory('üìä Excel –µ–∫—Å–ø–æ—Ä—Ç', `–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω Excel —Ñ–∞–π–ª –∑–∞ "${processedData.fileName}"`);
                
            } catch (error) {
                console.error('Excel Export Error:', error);
                showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Excel: ' + error.message, 'error');
            }
        }
        
        function addToHistory(type, description) {
            const timestamp = new Date().toLocaleString('bg-BG');
            const historyItem = {
                type: type,
                description: description,
                timestamp: timestamp
            };
            
            analysisHistory.unshift(historyItem);
            if (analysisHistory.length > 10) {
                analysisHistory = analysisHistory.slice(0, 10);
            }
            
            saveHistory();
            updateHistoryDisplay();
        }
        
        function saveHistory() {
            try {
                SafeStorage.setItem('marketBasketHistory', JSON.stringify(analysisHistory));
            } catch (e) {
                console.warn('–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∑–∞–ø–∞–∑–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞:', e);
            }
        }
        
        function loadHistory() {
            try {
                const saved = SafeStorage.getItem('marketBasketHistory');
                if (saved) {
                    analysisHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∑–∞—Ä–µ–¥–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞:', e);
                analysisHistory = [];
            }
        }
        
        function updateHistoryDisplay() {
            const container = document.getElementById('historyContainer');
            if (analysisHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏</p>';
                return;
            }
            
            let html = '';
            analysisHistory.forEach(item => {
                html += `<div class="history-item">
                            <div>
                                <div class="history-title">${item.type}</div>
                                <div style="color: #6c757d; font-size: 0.9em;">${item.description}</div>
                            </div>
                            <div class="history-time">${item.timestamp}</div>
                        </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function clearHistory() {
            if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ü—è–ª–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è?')) {
                analysisHistory = [];
                SafeStorage.removeItem('marketBasketHistory');
                updateHistoryDisplay();
                showNotification('–ò—Å—Ç–æ—Ä–∏—è—Ç–∞ –µ –∏–∑—á–∏—Å—Ç–µ–Ω–∞', 'success');
            }
        }
        
        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadHistory();
                updateHistoryDisplay();
                showNotification('Market Basket Analyzer –µ –≥–æ—Ç–æ–≤ –∑–∞ —Ä–∞–±–æ—Ç–∞! üöÄ', 'success');
            } catch (error) {
                console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:', error);
                showNotification('–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ.', 'error');
            }
        });
    </script>
</body>
</html>